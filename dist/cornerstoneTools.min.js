/*! cornerstone-tools - 0.0.0-semantically-released - 2021-11-08 | (c) 2017 Chris Hafey | https://github.com/cornerstonejs/cornerstoneTools */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("cornerstone-tools",[],t):"object"==typeof exports?exports["cornerstone-tools"]=t():e.cornerstoneTools=t()}(window,(function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var a=t[o]={i:o,l:!1,exports:{}};return e[o].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(o,a,function(t){return e[t]}.bind(null,a));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=18)}([function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return i})),n.d(t,"d",(function(){return r})),n.d(t,"e",(function(){return s}));const o=Symbol("thread.errors"),a=Symbol("thread.events"),i=Symbol("thread.terminate"),r=Symbol("thread.transferable"),s=Symbol("thread.worker")},function(e,t,n){"use strict";const o={deserialize:e=>Object.assign(Error(e.message),{name:e.name,stack:e.stack}),serialize:e=>({__error_marker:"$$error",message:e.message,name:e.name,stack:e.stack})},a={deserialize(e){return(t=e)&&"object"==typeof t&&"__error_marker"in t&&"$$error"===t.__error_marker?o.deserialize(e):e;var t},serialize:e=>e instanceof Error?o.serialize(e):e};n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return s}));let i=a;function r(e){return i.deserialize(e)}function s(e){return i.serialize(e)}},function(e,t,n){(function(o){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let o=0,a=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(o++,"%c"===e&&(a=o))}),t.splice(a,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==o&&"env"in o&&(e=o.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0)}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=n(16)(t);const{formatters:a}=e.exports;a.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,n(7))},function(e,t,n){"use strict";var o,a;n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return a})),function(e){e.cancel="cancel",e.run="run"}(o||(o={})),function(e){e.error="error",e.init="init",e.result="result",e.running="running",e.uncaughtError="uncaughtError"}(a||(a={}))},function(e,t,n){"use strict";const o=()=>"function"==typeof Symbol,a=e=>o()&&Boolean(Symbol[e]),i=e=>a(e)?Symbol[e]:"@@"+e;a("asyncIterator")||(Symbol.asyncIterator=Symbol.asyncIterator||Symbol.for("Symbol.asyncIterator"));const r=i("iterator"),s=i("observable"),c=i("species");function l(e,t){const n=e[t];if(null!=n){if("function"!=typeof n)throw new TypeError(n+" is not a function");return n}}function d(e){let t=e.constructor;return void 0!==t&&(t=t[c],null===t&&(t=void 0)),void 0!==t?t:y}function u(e){u.log?u.log(e):setTimeout(()=>{throw e},0)}function h(e){Promise.resolve().then(()=>{try{e()}catch(e){u(e)}})}function g(e){const t=e._cleanup;if(void 0!==t&&(e._cleanup=void 0,t))try{if("function"==typeof t)t();else{const e=l(t,"unsubscribe");e&&e.call(t)}}catch(e){u(e)}}function m(e){e._observer=void 0,e._queue=void 0,e._state="closed"}function f(e,t,n){e._state="running";const o=e._observer;try{const a=o?l(o,t):void 0;switch(t){case"next":a&&a.call(o,n);break;case"error":if(m(e),!a)throw n;a.call(o,n);break;case"complete":m(e),a&&a.call(o)}}catch(e){u(e)}"closed"===e._state?g(e):"running"===e._state&&(e._state="ready")}function p(e,t,n){if("closed"!==e._state)return"buffering"===e._state?(e._queue=e._queue||[],void e._queue.push({type:t,value:n})):"ready"!==e._state?(e._state="buffering",e._queue=[{type:t,value:n}],void h(()=>function(e){const t=e._queue;if(t){e._queue=void 0,e._state="ready";for(const n of t)if(f(e,n.type,n.value),"closed"===e._state)break}}(e))):void f(e,t,n)}class v{constructor(e,t){this._cleanup=void 0,this._observer=e,this._queue=void 0,this._state="initializing";const n=new x(this);try{this._cleanup=t.call(void 0,n)}catch(e){n.error(e)}"initializing"===this._state&&(this._state="ready")}get closed(){return"closed"===this._state}unsubscribe(){"closed"!==this._state&&(m(this),g(this))}}class x{constructor(e){this._subscription=e}get closed(){return"closed"===this._subscription._state}next(e){p(this._subscription,"next",e)}error(e){p(this._subscription,"error",e)}complete(){p(this._subscription,"complete")}}class y{constructor(e){if(!(this instanceof y))throw new TypeError("Observable cannot be called as a function");if("function"!=typeof e)throw new TypeError("Observable initializer must be a function");this._subscriber=e}subscribe(e,t,n){return"object"==typeof e&&null!==e||(e={next:e,error:t,complete:n}),new v(e,this._subscriber)}pipe(e,...t){let n=this;for(const o of[e,...t])n=o(n);return n}tap(e,t,n){const o="object"!=typeof e||null===e?{next:e,error:t,complete:n}:e;return new y(e=>this.subscribe({next(t){o.next&&o.next(t),e.next(t)},error(t){o.error&&o.error(t),e.error(t)},complete(){o.complete&&o.complete(),e.complete()},start(e){o.start&&o.start(e)}}))}forEach(e){return new Promise((t,n)=>{if("function"!=typeof e)return void n(new TypeError(e+" is not a function"));function o(){a.unsubscribe(),t(void 0)}const a=this.subscribe({next(t){try{e(t,o)}catch(e){n(e),a.unsubscribe()}},error(e){n(e)},complete(){t(void 0)}})})}map(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return new(d(this))(t=>this.subscribe({next(n){let o=n;try{o=e(n)}catch(e){return t.error(e)}t.next(o)},error(e){t.error(e)},complete(){t.complete()}}))}filter(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return new(d(this))(t=>this.subscribe({next(n){try{if(!e(n))return}catch(e){return t.error(e)}t.next(n)},error(e){t.error(e)},complete(){t.complete()}}))}reduce(e,t){if("function"!=typeof e)throw new TypeError(e+" is not a function");const n=d(this),o=arguments.length>1;let a=!1,i=t;return new n(t=>this.subscribe({next(n){const r=!a;if(a=!0,!r||o)try{i=e(i,n)}catch(e){return t.error(e)}else i=n},error(e){t.error(e)},complete(){if(!a&&!o)return t.error(new TypeError("Cannot reduce an empty sequence"));t.next(i),t.complete()}}))}concat(...e){const t=d(this);return new t(n=>{let o,a=0;return function i(r){o=r.subscribe({next(e){n.next(e)},error(e){n.error(e)},complete(){a===e.length?(o=void 0,n.complete()):i(t.from(e[a++]))}})}(this),()=>{o&&(o.unsubscribe(),o=void 0)}})}flatMap(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");const t=d(this);return new t(n=>{const o=[],a=this.subscribe({next(a){let r;if(e)try{r=e(a)}catch(e){return n.error(e)}else r=a;const s=t.from(r).subscribe({next(e){n.next(e)},error(e){n.error(e)},complete(){const e=o.indexOf(s);e>=0&&o.splice(e,1),i()}});o.push(s)},error(e){n.error(e)},complete(){i()}});function i(){a.closed&&0===o.length&&n.complete()}return()=>{o.forEach(e=>e.unsubscribe()),a.unsubscribe()}})}[(Symbol.observable,s)](){return this}static from(e){const t="function"==typeof this?this:y;if(null==e)throw new TypeError(e+" is not an object");const n=l(e,s);if(n){const o=n.call(e);if(Object(o)!==o)throw new TypeError(o+" is not an object");return function(e){return e instanceof y}(o)&&o.constructor===t?o:new t(e=>o.subscribe(e))}if(a("iterator")){const n=l(e,r);if(n)return new t(t=>{h(()=>{if(!t.closed){for(const o of n.call(e))if(t.next(o),t.closed)return;t.complete()}})})}if(Array.isArray(e))return new t(t=>{h(()=>{if(!t.closed){for(const n of e)if(t.next(n),t.closed)return;t.complete()}})});throw new TypeError(e+" is not observable")}static of(...e){return new("function"==typeof this?this:y)(t=>{h(()=>{if(!t.closed){for(const n of e)if(t.next(n),t.closed)return;t.complete()}})})}static get[c](){return this}}o()&&Object.defineProperty(y,Symbol("extensions"),{value:{symbol:s,hostReportError:u},configurable:!0});t.a=y},function(e,t,n){"use strict";var o;n.d(t,"a",(function(){return o})),function(e){e.internalError="internalError",e.message="message",e.termination="termination"}(o||(o={}))},function(e,t,n){"use strict";(function(e){var o=n(10);const a={formatArgs:function(e){if(e[0]="".concat((this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" "),"+").concat(i.humanize(this.diff)),!this.useColors)return;const t="color: ".concat(this.color);e.splice(1,0,t,"color: inherit");let n=0,o=0;e[0].replace(/%[a-zA-Z%]/g,(function(e){"%%"!==e&&(n++,"%c"===e&&(o=n))})),e.splice(o,0,t)},save:function(e){try{e?a.storage.setItem("debug",e):a.storage.removeItem("debug")}catch(e){}},load:function(){let t;try{t=a.storage.getItem("debug")}catch(e){}!t&&void 0!==e&&"env"in e&&(t=e.env.DEBUG);return t},useColors:function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},storage:function(){try{return localStorage}catch(e){}}()};a.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],a.log=console.debug||console.log||function(){};const i=Object(o.a)(a);i.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: ".concat(e.message)}},t.a=i}).call(this,n(7))},function(e,t){var n,o,a=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function s(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{o="function"==typeof clearTimeout?clearTimeout:r}catch(e){o=r}}();var c,l=[],d=!1,u=-1;function h(){d&&c&&(d=!1,c.length?l=c.concat(l):u=-1,l.length&&g())}function g(){if(!d){var e=s(h);d=!0;for(var t=l.length;t;){for(c=l,l=[];++u<t;)c&&c[u].run();u=-1,t=l.length}c=null,d=!1,function(e){if(o===clearTimeout)return clearTimeout(e);if((o===r||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(e);try{o(e)}catch(t){try{return o.call(null,e)}catch(t){return o.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function f(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new m(e,t)),1!==l.length||d||s(g)},m.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=f,a.addListener=f,a.once=f,a.off=f,a.removeListener=f,a.removeAllListeners=f,a.emit=f,a.prependListener=f,a.prependOnceListener=f,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},function(e,t,n){"use strict";var o=n(2),a=n.n(o),i=n(4);class r extends i.a{constructor(){super(e=>(this._observers.add(e),()=>this._observers.delete(e))),this._observers=new Set}next(e){for(const t of this._observers)t.next(e)}error(e){for(const t of this._observers)t.error(e)}complete(){for(const e of this._observers)e.complete()}}var s=r;var c=function(e){"function"==typeof e?e():e&&"function"==typeof e.unsubscribe&&e.unsubscribe()};var l=function(e){const t=new s;let n,o=0;return new i.a(a=>{n||(n=e.subscribe(t));const i=t.subscribe(a);return o++,()=>{o--,i.unsubscribe(),0===o&&(c(n),n=void 0)}})},d=n(1);const u=()=>{},h=e=>e,g=e=>Promise.resolve().then(e);function m(e){throw e}class f extends i.a{constructor(e){super(t=>{const n=this,o=Object.assign(Object.assign({},t),{complete(){t.complete(),n.onCompletion()},error(e){t.error(e),n.onError(e)},next(e){t.next(e),n.onNext(e)}});try{return this.initHasRun=!0,e(o)}catch(e){o.error(e)}}),this.initHasRun=!1,this.fulfillmentCallbacks=[],this.rejectionCallbacks=[],this.firstValueSet=!1,this.state="pending"}onNext(e){this.firstValueSet||(this.firstValue=e,this.firstValueSet=!0)}onError(e){this.state="rejected",this.rejection=e;for(const t of this.rejectionCallbacks)g(()=>t(e))}onCompletion(){this.state="fulfilled";for(const e of this.fulfillmentCallbacks)g(()=>e(this.firstValue))}then(e,t){const n=e||h,o=t||m;let a=!1;return new Promise((e,t)=>{const i=n=>{if(!a){a=!0;try{e(o(n))}catch(e){t(e)}}};return this.initHasRun||this.subscribe({error:i}),"fulfilled"===this.state?e(n(this.firstValue)):"rejected"===this.state?(a=!0,e(o(this.rejection))):(this.fulfillmentCallbacks.push(t=>{try{e(n(t))}catch(e){i(e)}}),void this.rejectionCallbacks.push(i))})}catch(e){return this.then(void 0,e)}finally(e){const t=e||u;return this.then(e=>(t(),e),()=>t())}static from(e){return function(e){return e&&"function"==typeof e.then}(e)?new f(t=>{e.then(e=>{t.next(e),t.complete()},e=>{t.error(e)})}):super.from(e)}}var p=n(14),v=n(3);n.d(t,"a",(function(){return T})),n.d(t,"b",(function(){return C}));const x=a()("threads:master:messages");let y=1;function b(e,t){return new i.a(n=>{let o;const a=i=>{var r;if(x("Message from worker:",i.data),i.data&&i.data.uid===t)if((r=i.data)&&r.type===v.b.running)o=i.data.resultType;else if((e=>e&&e.type===v.b.result)(i.data))"promise"===o?(void 0!==i.data.payload&&n.next(Object(d.a)(i.data.payload)),n.complete(),e.removeEventListener("message",a)):(i.data.payload&&n.next(Object(d.a)(i.data.payload)),i.data.complete&&(n.complete(),e.removeEventListener("message",a)));else if((e=>e&&e.type===v.b.error)(i.data)){const t=Object(d.a)(i.data.error);n.error(t),e.removeEventListener("message",a)}};return e.addEventListener("message",a),()=>{if("observable"===o||!o){const n={type:v.a.cancel,uid:t};e.postMessage(n)}e.removeEventListener("message",a)}})}function T(e,t){return(...n)=>{const o=y++,{args:a,transferables:i}=function(e){if(0===e.length)return{args:[],transferables:[]};const t=[],n=[];for(const o of e)Object(p.a)(o)?(t.push(Object(d.b)(o.send)),n.push(...o.transferables)):t.push(Object(d.b)(o));return{args:t,transferables:0===n.length?n:(o=n,Array.from(new Set(o)))};var o}(n),r={type:v.a.run,uid:o,method:t,args:a};x("Sending command to run function to worker:",r);try{e.postMessage(r,i)}catch(e){return f.from(Promise.reject(e))}return f.from(l(b(e,o)))}}function C(e,t){const n={};for(const o of t)n[o]=T(e,o);return n}},,function(e,t,n){"use strict";t.a=function(e){function t(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return o.colors[Math.abs(t)%o.colors.length]}function o(e){let n;function r(...e){if(!r.enabled)return;const t=r,a=Number(new Date),i=a-(n||a);t.diff=i,t.prev=n,t.curr=a,n=a,e[0]=o.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(n,a)=>{if("%%"===n)return n;s++;const i=o.formatters[a];if("function"==typeof i){const o=e[s];n=i.call(t,o),e.splice(s,1),s--}return n}),o.formatArgs.call(t,e),(t.log||o.log).apply(t,e)}return r.namespace=e,r.enabled=o.enabled(e),r.useColors=o.useColors(),r.color=t(e),r.destroy=a,r.extend=i,"function"==typeof o.init&&o.init(r),o.instances.push(r),r}function a(){const e=o.instances.indexOf(this);return-1!==e&&(o.instances.splice(e,1),!0)}function i(e,t){const n=o(this.namespace+(void 0===t?":":t)+e);return n.log=this.log,n}function r(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return o.debug=o,o.default=o,o.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},o.disable=function(){const e=[...o.names.map(r),...o.skips.map(r).map(e=>"-".concat(e))].join(",");return o.enable(""),e},o.enable=function(e){let t;o.save(e),o.names=[],o.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),a=n.length;for(t=0;t<a;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?o.skips.push(new RegExp("^".concat(e.substr(1),"$"))):o.names.push(new RegExp("^".concat(e,"$"))));for(t=0;t<o.instances.length;t++){const e=o.instances[t];e.enabled=o.enabled(e.namespace)}},o.enabled=function(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=o.skips.length;t<n;t++)if(o.skips[t].test(e))return!1;for(t=0,n=o.names.length;t<n;t++)if(o.names[t].test(e))return!0;return!1},o.humanize=n(15),Object.keys(e).forEach(t=>{o[t]=e[t]}),o.instances=[],o.names=[],o.skips=[],o.formatters={},o.selectColor=t,o.enable(o.load()),o}},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(e,t,n){"use strict";e.exports=function(e,t,n,o){var a=self||window;try{try{var i;try{i=new a.Blob([e])}catch(t){(i=new(a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||a.MSBlobBuilder)).append(e),i=i.getBlob()}var r=a.URL||a.webkitURL,s=r.createObjectURL(i),c=new a[t](s,n);return r.revokeObjectURL(s),c}catch(o){return new a[t]("data:application/javascript,".concat(encodeURIComponent(e)),n)}}catch(e){if(!o)throw Error("Inline worker is not supported");return new a[t](o,n)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));const o=()=>{};function a(){let e,t=!1,n=o;return[new Promise(o=>{t?o(e):n=o}),o=>{t=!0,e=o,n(e)}]}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var o=n(0);function a(e){return e&&"object"==typeof e&&e[o.d]}},function(e,t){var n=1e3,o=6e4,a=60*o,i=24*a;function r(e,t,n,o){var a=t>=1.5*n;return Math.round(e/n)+" "+o+(a?"s":"")}e.exports=function(e,t){t=t||{};var s=typeof e;if("string"===s&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\-?\d?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return 6048e5*r;case"days":case"day":case"d":return r*i;case"hours":case"hour":case"hrs":case"hr":case"h":return r*a;case"minutes":case"minute":case"mins":case"min":case"m":return r*o;case"seconds":case"second":case"secs":case"sec":case"s":return r*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}(e);if("number"===s&&!1===isNaN(e))return t.long?function(e){var t=Math.abs(e);if(t>=i)return r(e,t,i,"day");if(t>=a)return r(e,t,a,"hour");if(t>=o)return r(e,t,o,"minute");if(t>=n)return r(e,t,n,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=i)return Math.round(e/i)+"d";if(t>=a)return Math.round(e/a)+"h";if(t>=o)return Math.round(e/o)+"m";if(t>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,n){e.exports=function(e){function t(e){let n,a,i,r=null;function s(...e){if(!s.enabled)return;const o=s,a=Number(new Date),i=a-(n||a);o.diff=i,o.prev=n,o.curr=a,n=a,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let r=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(n,a)=>{if("%%"===n)return"%";r++;const i=t.formatters[a];if("function"==typeof i){const t=e[r];n=i.call(o,t),e.splice(r,1),r--}return n}),t.formatArgs.call(o,e),(o.log||t.log).apply(o,e)}return s.namespace=e,s.useColors=t.useColors(),s.color=t.selectColor(e),s.extend=o,s.destroy=t.destroy,Object.defineProperty(s,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==r?r:(a!==t.namespaces&&(a=t.namespaces,i=t.enabled(e)),i),set:e=>{r=e}}),"function"==typeof t.init&&t.init(s),s}function o(e,n){const o=t(this.namespace+(void 0===n?":":n)+e);return o.log=this.log,o}function a(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(a),...t.skips.map(a).map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){let n;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const o=("string"==typeof e?e:"").split(/[\s,]+/),a=o.length;for(n=0;n<a;n++)o[n]&&("-"===(e=o[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let n,o;for(n=0,o=t.skips.length;n<o;n++)if(t.skips[n].test(e))return!1;for(n=0,o=t.names.length;n<o;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=n(17),t.destroy=function(){},Object.keys(e).forEach(n=>{t[n]=e[n]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t}},function(e,t){var n=1e3,o=6e4,a=60*o,i=24*a;function r(e,t,n,o){var a=t>=1.5*n;return Math.round(e/n)+" "+o+(a?"s":"")}e.exports=function(e,t){t=t||{};var s=typeof e;if("string"===s&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return 6048e5*r;case"days":case"day":case"d":return r*i;case"hours":case"hour":case"hrs":case"hr":case"h":return r*a;case"minutes":case"minute":case"mins":case"min":case"m":return r*o;case"seconds":case"second":case"secs":case"sec":case"s":return r*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}(e);if("number"===s&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=i)return r(e,t,i,"day");if(t>=a)return r(e,t,a,"hour");if(t>=o)return r(e,t,o,"minute");if(t>=n)return r(e,t,n,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=i)return Math.round(e/i)+"d";if(t>=a)return Math.round(e/a)+"h";if(t>=o)return Math.round(e/o)+"m";if(t>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,n){"use strict";n.r(t);var o={};n.r(o),n.d(o,"drawBrushPixels",(function(){return V})),n.d(o,"eraseIfSegmentIndex",(function(){return B})),n.d(o,"eraseOutsideBoundingBox",(function(){return z})),n.d(o,"eraseInsideShape",(function(){return W})),n.d(o,"eraseOutsideShape",(function(){return G})),n.d(o,"fillOutsideBoundingBox",(function(){return Y})),n.d(o,"fillInsideShape",(function(){return Z})),n.d(o,"fillOutsideShape",(function(){return $})),n.d(o,"floodFill",(function(){return J})),n.d(o,"getBoundingBoxAroundCircle",(function(){return ne})),n.d(o,"getBoundingBoxAroundPolygon",(function(){return oe})),n.d(o,"getCircle",(function(){return ae})),n.d(o,"getPixelPathBetweenPixels",(function(){return se})),n.d(o,"isSameSegment",(function(){return j})),n.d(o,"triggerLabelmapModifiedEvent",(function(){return fe})),n.d(o,"getDiffBetweenPixelData",(function(){return pe}));var a={};n.r(a),n.d(a,"angleCursor",(function(){return Go})),n.d(a,"arrowAnnotateCursor",(function(){return Yo})),n.d(a,"bidirectionalCursor",(function(){return Xo})),n.d(a,"cobbAngleCursor",(function(){return Ko})),n.d(a,"circleRoiCursor",(function(){return Zo})),n.d(a,"ellipticalRoiCursor",(function(){return $o})),n.d(a,"freehandRoiCursor",(function(){return Jo})),n.d(a,"freehandRoiSculptorCursor",(function(){return Qo})),n.d(a,"lengthCursor",(function(){return ea})),n.d(a,"probeCursor",(function(){return ta})),n.d(a,"rectangleRoiCursor",(function(){return na})),n.d(a,"textMarkerCursor",(function(){return oa})),n.d(a,"crosshairsCursor",(function(){return aa})),n.d(a,"eraserCursor",(function(){return ia})),n.d(a,"magnifyCursor",(function(){return ra})),n.d(a,"panCursor",(function(){return sa})),n.d(a,"rotateCursor",(function(){return ca})),n.d(a,"stackScrollCursor",(function(){return la})),n.d(a,"wwwcRegionCursor",(function(){return da})),n.d(a,"wwwcCursor",(function(){return ua})),n.d(a,"zoomCursor",(function(){return ha})),n.d(a,"freehandEraseInsideCursor",(function(){return ya})),n.d(a,"freehandFillInsideCursor",(function(){return ba})),n.d(a,"freehandEraseOutsideCursor",(function(){return Ta})),n.d(a,"freehandFillOutsideCursor",(function(){return Ca})),n.d(a,"segRectangleEraseInsideCursor",(function(){return Ma})),n.d(a,"segRectangleFillInsideCursor",(function(){return Ea})),n.d(a,"segRectangleEraseOutsideCursor",(function(){return wa})),n.d(a,"segRectangleFillOutsideCursor",(function(){return Ia})),n.d(a,"segCircleEraseInsideCursor",(function(){return Sa})),n.d(a,"segCircleFillInsideCursor",(function(){return _a})),n.d(a,"segCircleEraseOutsideCursor",(function(){return Pa})),n.d(a,"segCircleFillOutsideCursor",(function(){return Da}));let i=window.cornerstone,r=window.cornerstoneMath,s=window.Hammer;var c={set cornerstone(e){i=e},get cornerstone(){return i},set cornerstoneMath(e){r=e},get cornerstoneMath(){return r},set Hammer(e){s=e},get Hammer(){return s}};var l={MOUSE_DOWN:"cornerstonetoolsmousedown",MOUSE_UP:"cornerstonetoolsmouseup",MOUSE_DOWN_ACTIVATE:"cornerstonetoolsmousedownactivate",MOUSE_DRAG:"cornerstonetoolsmousedrag",MOUSE_MOVE:"cornerstonetoolsmousemove",MOUSE_CLICK:"cornerstonetoolsmouseclick",MOUSE_DOUBLE_CLICK:"cornerstonetoolsmousedoubleclick",MOUSE_WHEEL:"cornerstonetoolsmousewheel",TOUCH_START:"cornerstonetoolstouchstart",TOUCH_START_ACTIVE:"cornerstonetoolstouchstartactive",TOUCH_END:"cornerstonetoolstouchend",TOUCH_DRAG:"cornerstonetoolstouchdrag",TOUCH_DRAG_END:"cornerstonetoolstouchdragend",TOUCH_PINCH:"cornerstonetoolstouchpinch",TOUCH_ROTATE:"cornerstonetoolstouchrotate",TOUCH_PRESS:"cornerstonetoolstouchpress",TAP:"cornerstonetoolstap",DOUBLE_TAP:"cornerstonetoolsdoubletap",MULTI_TOUCH_START:"cornerstonetoolsmultitouchstart",MULTI_TOUCH_START_ACTIVE:"cornerstonetoolsmultitouchstartactive",MULTI_TOUCH_DRAG:"cornerstonetoolsmultitouchdrag",KEY_DOWN:"cornerstonetoolskeydown",KEY_UP:"cornerstonetoolskeyup",KEY_PRESS:"cornerstonetoolskeypress",MEASUREMENT_ADDED:"cornerstonetoolsmeasurementadded",MEASUREMENT_MODIFIED:"cornerstonetoolsmeasurementmodified",MEASUREMENT_COMPLETED:"cornerstonetoolsmeasurementcompleted",MEASUREMENT_REMOVED:"cornerstonetoolsmeasurementremoved",TOOL_DEACTIVATED:"cornerstonetoolstooldeactivated",CLIP_STOPPED:"cornerstonetoolsclipstopped",STACK_SCROLL:"cornerstonetoolsstackscroll",STACK_PREFETCH_IMAGE_LOADED:"cornerstonetoolsstackprefetchimageloaded",STACK_PREFETCH_DONE:"cornerstonetoolsstackprefetchdone",LABELMAP_MODIFIED:"cornersontetoolslabelmapmodified"};function d(e,t,n=null){let o;return"function"==typeof window.CustomEvent?o=new CustomEvent(t,{detail:n,cancelable:!0}):(o=document.createEvent("CustomEvent"),o.initCustomEvent(t,!0,!0,n)),e.dispatchEvent(o)}function u(e){return e instanceof HTMLElement?e:tt.enabledElementByUID(e)}var h={UINT_16_ARRAY:0,FLOAT_32_ARRAY:1};const{UINT_16_ARRAY:g,FLOAT_32_ARRAY:m}=h;function f(e,t,n){const{configuration:o}=ot("segmentation");let a;switch(o.arrayType){case g:a=2;break;case m:a=4;break;default:throw new Error("Unsupported Array Type ".concat(o.arrayType))}e.labelmaps3D[t]={buffer:new ArrayBuffer(n*a),labelmaps2D:[],metadata:[],activeSegmentIndex:1,colorLUTIndex:0,segmentsHidden:[],undo:[],redo:[]}}function p(){let e={};function t(t,n,o){!1===e.hasOwnProperty(t)&&(e[t]={});const a=e[t];!1===a.hasOwnProperty(n)&&(a[n]={data:[]}),a[n].data.push(o)}function n(t,n){if(!1===e.hasOwnProperty(t))return;const o=e[t];return!1!==o.hasOwnProperty(n)?o[n]:void 0}function o(t,n,o){e[t][n]=o}function a(t){!1!==e.hasOwnProperty(t)&&delete e[t]}return{get:function(e,t){const o=c.cornerstone.getEnabledElement(e);if(o.image)return n(o.image.imageId,t)},add:function(e,n,o){const a=c.cornerstone.getEnabledElement(e);a.image&&t(a.image.imageId,n,o)},set:function(e,t,n){const a=c.cornerstone.getEnabledElement(e);a.image&&o(a.image.imageId,t,n)},clear:function(e){const t=c.cornerstone.getEnabledElement(e);t.image&&a(t.image.imageId)},getImageIdToolState:n,addImageIdToolState:t,setImageIdToolState:o,clearImageIdToolState:a,saveImageIdToolState:function(t){return e[t]},restoreImageIdToolState:function(t,n){e[t]=n},saveToolState:function(){return e},restoreToolState:function(t){e=t},toolState:e}}const v=p();function x(e){const t=c.cornerstone.getEnabledElement(e);return void 0===t.toolStateManager&&(t.toolStateManager=v),t.toolStateManager}function y(e,t,n){const o=x(e);n.uuid=n.uuid||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),o.add(e,t,n),d(e,l.MEASUREMENT_ADDED,{toolName:t,toolType:t,element:e,measurementData:n})}function b(e,t){return x(e).get(e,t)}function T(e,t,n){const o=x(e).get(e,t);if(!o||!o.data||!o.data.length)return;let a=-1;for(let e=0;e<o.data.length;e++)o.data[e]===n&&(a=e);if(-1!==a){o.data.splice(a,1),d(e,l.MEASUREMENT_REMOVED,{toolName:t,toolType:t,element:e,measurementData:n})}}function C(e,t){const n=x(e).get(e,t);void 0!==n&&(n.data=[])}function M(e,t){c.cornerstone.getEnabledElement(e).toolStateManager=t}var E=n(6);const w=Object(E.a)("cornerstoneTools");const I=e=>{const t=w.extend(e);return{log:t,warn:t,error:void 0}},S=(e="".concat("cornerstoneTools",":*"))=>E.a.enable(e),_=()=>E.a.disable();var P={series:{},colorLutTables:[]};const D=I("store:modules:segmentationModule:metadata");function k(e,t="increase"){const{configuration:n}=ot("segmentation"),o=b(e,"stack").data[0].imageIds[0],a=P.series[o];if(!a)return;const i=a.activeLabelmapIndex,r=a.labelmaps3D[i];switch(t){case"increase":r.activeSegmentIndex++,r.activeSegmentIndex>n.segmentsPerLabelmap&&(r.activeSegmentIndex=1);break;case"decrease":r.activeSegmentIndex--,r.activeSegmentIndex<=0&&(r.activeSegmentIndex=n.segmentsPerLabelmap)}}const O=I("store:modules:segmentationModule:segmentVisibility");const L=I("store:modules:segmentationModule:getLabelmaps3D");function A(e){const t=u(e);if(!t)return;const n=b(t,"stack");if(!n)return void L.error("Consumers must define stacks in their application if using segmentations in cornerstoneTools.");const o=n.data[0],a=o.imageIds[0],i=P.series[a];let r,s;return i&&(r=i.labelmaps3D,s=i.activeLabelmapIndex),{labelmaps3D:r,activeLabelmapIndex:s,currentImageIdIndex:o.currentImageIdIndex}}function H(e,t){const{labelmaps3D:n,activeLabelmapIndex:o}=A(e);return n[t=void 0!==t?t:o]}const{UINT_16_ARRAY:R,FLOAT_32_ARRAY:U}=h;function F(e,t){const n=u(e);if(!n)return;const{labelmaps3D:o}=A(n);if(!o)return[];const{configuration:a}=ot("segmentation");let i,r;switch(a.arrayType){case R:i="Uint16Array",r="2";break;case U:i="Float32Array",r="4";break;default:throw new Error("Unsupported Array Type ".concat(a.arrayType))}const s=P.colorLutTables;if(void 0!==t){const e=o[t];return e?{labelmapIndex:t,bytesPerVoxel:r,type:i,buffer:e.buffer,colorLUT:s[e.colorLUTIndex]}:void 0}const c=[];for(let e=0;e<o.length;e++){const t=o[e];t&&c.push({labelmapIndex:e,bytesPerVoxel:2,buffer:t.buffer,colorLUT:s[t.colorLUTIndex]})}return c}function N(e){const t=new Set(e).values(),n=[];let o=!1;for(;!o;){const e=t.next();o=e.done,o||n.push(e.value)}return n}function B(e,t,n){t[e]===n&&(t[e]=0)}function V(e,t,n,o,a=!1){e.forEach(e=>{const i=((e,t)=>t*o+e)(...e);a?B(i,t,n):t[i]=n})}function z(e,t,n,o){const a=e.detail,{pixelData:i,segmentIndex:r}=t,{image:s}=a,{width:c,height:l}=s;for(let e=0;e<c;e++)for(let t=0;t<n[1];t++)B(t*c+e,i,r);for(let e=0;e<n[0];e++)for(let t=n[1];t<o[1];t++)B(t*c+e,i,r);for(let e=o[0];e<c;e++)for(let t=n[1];t<o[1];t++)B(t*c+e,i,r);for(let e=0;e<c;e++)for(let t=o[1];t<l;t++)B(t*c+e,i,r)}function j(e,t,n){return t[e]===n}I("util:segmentation:operations:eraseOutsideCircle");function q(e,t,n,o,a,i="inside"){const{width:r}=e.detail.image,{pixelData:s,segmentIndex:c}=t,[l,d]=o,[u,h]=a;"outside"===i&&z(e,t,o,a);for(let e=l;e<u;e++)for(let t=d;t<h;t++){const o=t*r+e;j(o,s,c)&&n({x:e,y:t})&&(s[o]=0)}}function W(e,t,n,o,a){q(e,t,n,o,a,"inside")}function G(e,t,n,o,a){q(e,t,e=>!n(e),o,a,"outside")}function Y(e,t,n,o){const{pixelData:a,segmentIndex:i}=t,{width:r,height:s}=e.detail.image;for(let e=0;e<r;e++)for(let t=0;t<n[1];t++)a[t*r+e]=i;for(let e=0;e<n[0];e++)for(let t=n[1];t<o[1];t++)a[t*r+e]=i;for(let e=o[0];e<r;e++)for(let t=n[1];t<o[1];t++)a[t*r+e]=i;for(let e=0;e<r;e++)for(let t=o[1];t<s;t++)a[t*r+e]=i}const X=I("util:segmentation:operations:helpers:fillShape");function K(e,t,n,o,a,i="inside"){const{pixelData:r,segmentIndex:s}=t;if(void 0===r||void 0===s)return void X.error("fillInsideShape requires operationData to contain pixelData and segmentIndex");const{width:c}=e.detail.image,[l,d]=o,[u,h]=a;"outside"===i&&Y(e,t,o,a);for(let e=l;e<u;e++)for(let t=d;t<h;t++){const o=t*c+e;n({x:e,y:t})&&(r[o]=s)}}function Z(e,t,n,o,a){K(e,t,n,o,a,"inside")}function $(e,t,n,o,a){K(e,t,e=>!n(e),o,a,"outside")}var J=function(e,t,n={}){const o=n.onFlood||function(){},a=n.onBoundary||function(){},i=n.equals||Q,r=n.diagonals||!1,s=m(t),c=function(e){const t=[],n=function(e){return e.split("").map((function(e){return parseInt(e,10)-1}))};for(let o=0;o<Math.pow(3,e);o+=1){const a=ee(o.toString(3),"0",e);t.push(n(a))}return t}(t.length).filter((function(e){const t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||r)})),l=[],d=[],u={},h={};for(l.push({currentArgs:t});l.length>0;)g(l.pop());return{flooded:d,boundaries:function(){const e=[];for(const t in h)h.hasOwnProperty(t)&&e.unshift(h[t]);return e}()};function g(e){const t=e.currentArgs,n=e.previousArgs;!0!==u[t]&&(!function(e){u[e]=!0}(t),function(e){const t=f(m,[e]);return f(i,[t,s])}(t)?(function(e){d.push(e),o(...e)}(t),function(e){for(let t=0;t<c.length;t+=1){const n=c[t],o=e.slice(0);for(let t=0;t<e.length;t+=1)o[t]+=n[t];l.push({currentArgs:o,previousArgs:e})}}(t)):function(e){h[e]=e,a(...e)}(n))}function m(t){return e(...t)}function f(e,t){try{return e(...t)}catch(e){return}}};function Q(e,t){return e===t}function ee(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}function te(e,t){const{distance:n}=c.cornerstoneMath.point,o=n(e,t);return{left:Math.floor(Math.min(e.x-o,t.x)),top:Math.floor(Math.min(e.y-o,t.y)),width:2*o,height:2*o}}function ne(e){const{handles:t}=e.detail,{width:n,height:o}=e.detail.image,a=te(t.start,t.end);let i=a.width+a.left,r=a.left,s=a.top+a.height,c=a.top;return r=Math.floor(r),c=Math.floor(c),i=Math.floor(i),s=Math.floor(s),i=Math.min(n,i),r=Math.max(0,r),s=Math.min(o,s),c=Math.max(0,c),[[r,c],[i,s]]}function oe(e,t){let n=1/0,o=0,a=1/0,i=0;const{width:r,height:s}=t;return e.forEach(e=>{n=Math.min(e[0],n),o=Math.max(e[0],o),a=Math.min(e[1],a),i=Math.max(e[1],i)}),n=Math.floor(n),a=Math.floor(a),o=Math.floor(o),i=Math.floor(i),o=Math.min(r,o),n=Math.max(0,n),i=Math.min(s,i),a=Math.max(0,a),[[n,a],[o,i]]}function ae(e,t,n,o=0,a=0){const i=Math.floor(o),r=Math.floor(a);if(1===e)return[[i,r]];const s=[];let c=0;for(let o=-e;o<=e;o++){const a=r+o;if(!(a>t||a<0))for(let t=-e;t<=e;t++){const a=i+t;a>=n||a<0||t*t+o*o<e*e&&(s[c++]=[i+t,r+o])}}return s}const ie=1/Math.sqrt(2),re={up:{x:0,y:1},upRight:{x:ie,y:ie},right:{x:1,y:0},downRight:{x:ie,y:-ie},down:{x:0,y:1},downLeft:{x:-ie,y:-ie},left:{x:-1,y:0},upLeft:{x:-ie,y:ie}};var se=function(e,t){const n={x:e.x,y:e.y},o=[];for(;t.x!==n.x||t.y!==n.y;)t.x===n.x?t.y>n.y?n.y++:n.y--:t.y===n.y?t.x>n.x?n.x++:n.x--:t.y>n.y?t.x>n.x?ce(n,t):le(n,t):t.x>n.x?de(n,t):ue(n,t),o.push({x:n.x,y:n.y});return o.pop(),o};function ce(e,t){const n=he(e,t);switch(me([ge(n,re.up),ge(n,re.right),ge(n,re.upRight)])){case 0:e.y++;break;case 1:e.x++;break;case 2:e.y++,e.x++}}function le(e,t){const n=he(e,t);switch(me([ge(n,re.up),ge(n,re.left),ge(n,re.upLeft)])){case 0:e.y++;break;case 1:e.x--;break;case 2:e.y++,e.x--}}function de(e,t){const n=he(e,t);switch(me([ge(n,re.down),ge(n,re.right),ge(n,re.downRight)])){case 0:e.y--;break;case 1:e.x++;break;case 2:e.y--,e.x++}}function ue(e,t){const n=he(e,t);switch(me([ge(n,re.down),ge(n,re.left),ge(n,re.downLeft)])){case 0:e.y--;break;case 1:e.x--;break;case 2:e.y--,e.x--}}function he(e,t){const n=c.cornerstoneMath.point.distance(e,t);return{x:(t.x-e.x)/n,y:(t.y-e.y)/n}}function ge(e,t){return e.x*t.x+e.y*t.y}function me(e){let t=e[0]>e[1]?0:1;return e[2]>e[t]&&(t=2),t}function fe(e,t){const{getters:n}=ot("segmentation");t=void 0===t?n.activeLabelmapIndex(e):t,c.cornerstone.triggerEvent(e,l.LABELMAP_MODIFIED,{labelmapIndex:t})}function pe(e,t){const n=[];for(let o=0;o<e.length;o++)e[o]!==t[o]&&n.push([o,e[o],t[o]]);return n}const{UINT_16_ARRAY:ve,FLOAT_32_ARRAY:xe}=h;function ye(e,t,n,o=[],a,i,r=0){const{configuration:s}=ot("segmentation");let c=P.series[e];c||(P.series[e]={activeLabelmapIndex:n,labelmaps3D:[]},c=P.series[e]),c.labelmaps3D[n]={buffer:t,labelmaps2D:[],metadata:o,activeSegmentIndex:1,colorLUTIndex:r,segmentsHidden:[],undo:[],redo:[]};const l=c.labelmaps3D[n].labelmaps2D,d=t.byteLength/a;for(let e=0;e<a;e++){let n;switch(s.arrayType){case ve:n=new Uint16Array(t,d*e,d/2);break;case xe:n=new Float32Array(t,d*e,d/4);break;default:throw new Error("Unsupported Array Type ".concat(s.arrayType))}const o=i?i[e]:N(n);o&&o.some(e=>e)&&(l[e]={pixelData:n,segmentsOnLabelmap:o})}}const be=I("store:modules:segmentationModule:getLabelmapStats");function Te(e,t,n){const o=e.length,a=t[n].imagePositionPatient;if(0===n){return Ce(a,t[n+1].imagePositionPatient)}if(n===o-1){return Ce(a,t[n-1].imagePositionPatient)}const i=t[n-1].imagePositionPatient,r=t[n+1].imagePositionPatient;return(Ce(a,i)+Ce(a,r))/2}function Ce(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}const{UINT_16_ARRAY:Me,FLOAT_32_ARRAY:Ee}=h;function we(e,t,n,o,a){const{configuration:i}=ot("segmentation"),r=o*a,s=r*n;let c;switch(i.arrayType){case Me:c=new Uint16Array(e.labelmaps3D[t].buffer,2*s,r);break;case Ee:c=new Float32Array(e.labelmaps3D[t].buffer,4*s,r);break;default:throw new Error("Unsupported Array Type ".concat(i.arrayType))}e.labelmaps3D[t].labelmaps2D[n]={pixelData:c,segmentsOnLabelmap:[]}}const{UINT_16_ARRAY:Ie,FLOAT_32_ARRAY:Se}=h,_e=I("store:modules:segmentationModule:getLabelmap2D");function Pe({x:e,y:t},n,o){return e<o&&e>=0&&t<n&&t>=0}const De=I("store:modules:segmentationModule:getSegmentOfActiveLabelmapAtEvent");const ke=I("store:modules:segmentationModule:setColorLUT");function Oe(e,t=[]){const{configuration:n}=ot("segmentation"),o=n.segmentsPerLabelmap;t?(!function(e,t){e.length<t?ke.warn("The provided colorLUT only provides ".concat(e.length," labels, whereas segmentsPerLabelmap is set to ").concat(t,". Autogenerating the rest.")):e.length>t&&ke.warn("segmentsPerLabelmap is set to ".concat(t,", and the provided colorLUT provides ").concat(e.length,". Using the first ").concat(t," colors from the LUT."))}(t,o),t.length<o&&(t=[...t,...Ae(o-t.length)])):t=t||Ae(o),t.unshift([0,0,0,0]),P.colorLutTables[e]=t}function Le(e){return"number"==typeof e?P.colorLutTables[e]:P.colorLutTables[e.colorLUTIndex]}function Ae(e=255){const t=[];for(let n=0;n<e;n++)t.push(Ne(Re(),Fe()));return t}let He=222.5;function Re(){return He+=137.5,He>=360&&(He-=360),He}let Ue=.6;function Fe(){if(Ue+=.07,Ue>.82){Ue=.3+(Ue-.82)}return Ue}function Ne(e,t=1,n=.6,o=255){const a=(1-Math.abs(2*n-1))*t,i=a*(1-Math.abs(e/60%2-1)),r=n-a/2;let s,c,l;return e<60?[s,c,l]=[a,i,0]:e<120?[s,c,l]=[i,a,0]:e<180?[s,c,l]=[0,a,i]:e<240?[s,c,l]=[0,i,a]:e<300?[s,c,l]=[i,0,a]:e<360&&([s,c,l]=[a,0,i]),[255*(s+r),255*(c+r),255*(l+r),o]}const Be=I("store:modules:segmentationModule:getBrushColor");const{UINT_16_ARRAY:Ve}=h;var ze={renderOutline:!0,renderFill:!0,shouldRenderInactiveLabelmaps:!0,radius:10,minRadius:1,maxRadius:50,fillAlpha:.2,fillAlphaInactive:.1,outlineAlpha:.7,outlineAlphaInactive:.35,outlineWidth:3,storeHistory:!0,segmentsPerLabelmap:65535,arrayType:Ve};const je=I("util:segmentation:labelmap3DHistory");function qe(e,t,n){const{labelmaps2D:o}=e;t.forEach(e=>{const{imageIdIndex:t,diff:a}=e,i=o[t].pixelData;for(let e=0;e<a.length;e++){const t=a[e];i[t[0]]=t[n]}})}var We={state:P,configuration:ze,onRegisterCallback:function(){Oe(0)},getters:{metadata:function(e,t,n){const o=u(e);if(!o)return;const a=b(o,"stack").data[0].imageIds[0],i=P.series[a];if(!i)return void D.warn("brushStackState is undefined");if(t=void 0===t?i.activeLabelmapIndex:t,!i.labelmaps3D[t])return void D.warn("No labelmap3D of labelmap index ".concat(t," on stack."));const r=i.labelmaps3D[t];return void 0===n?r.metadata:r.metadata[n]},labelmap3D:H,labelmaps3D:A,activeLabelmapIndex:function(e){const t=u(e);if(!t)return;const n=b(t,"stack").data[0].imageIds[0],o=P.series[n];return o?o.activeLabelmapIndex:void 0},activeSegmentIndex:function(e,t){const n=u(e);if(!n)return;const o=b(n,"stack").data[0].imageIds[0],a=P.series[o];if(a){t=void 0===t?a.activeLabelmapIndex:t;const e=a.labelmaps3D[t];if(e)return e.activeSegmentIndex}return 1},isSegmentVisible:function(e,t,n){if(!t)return;const o=u(e);if(!o)return;const a=b(o,"stack").data[0].imageIds[0],i=P.series[a];if(i){if(n=void 0===n?i.activeLabelmapIndex:n,i.labelmaps3D[n])return!i.labelmaps3D[n].segmentsHidden[t];O.warn("No labelmap3D of labelmap index ".concat(n," on stack."))}else O.warn("brushStackState is undefined")},labelmap2D:function(e){const t=u(e);if(!t)return;const n=c.cornerstone,o=b(t,"stack");if(!o)return void _e.error("Consumers must define stacks in their application if using segmentations in cornerstoneTools.");const a=o.data[0],i=n.getEnabledElement(t),r=a.currentImageIdIndex,{rows:s,columns:l}=i.image,d=a.imageIds.length,h=a.imageIds[0];let g,m=P.series[h];if(m){if(g=m.activeLabelmapIndex,!m.labelmaps3D[g]){f(m,g,s*l*d)}m.labelmaps3D[g].labelmaps2D[r]||we(m,g,r,s,l)}else{g=0,P.series[h]={activeLabelmapIndex:g,labelmaps3D:[]},m=P.series[h],f(m,g,s*l*d),we(m,g,r,s,l)}const p=m.labelmaps3D[g];return{labelmap2D:p.labelmaps2D[r],labelmap3D:p,currentImageIdIndex:r,activeLabelmapIndex:g}},labelmap2DByImageIdIndex:function(e,t,n,o){if(!e.labelmaps2D[t]){const{configuration:a}=ot("segmentation"),i=n*o,r=i*t;let s;switch(a.arrayType){case Ie:s=new Uint16Array(e.buffer,2*r,i);break;case Se:s=new Float32Array(e.buffer,4*r,i);break;default:throw new Error("Unsupported Array Type ".concat(a.arrayType))}e.labelmaps2D[t]={pixelData:s,segmentsOnLabelmap:N(s)}}return e.labelmaps2D[t]},labelmapStats:function(e,t,n){const o=c.cornerstone,a=u(e);if(!a)return null;const i=b(a,"stack").data[0].imageIds,r=i[0];return new Promise(e=>{const a=P.series[r];a||e(null);const{sufficientMetadata:s,imagePlanes:l}=function(e){const t=[],n=c.cornerstone.metaData;let o=!0;for(let a=0;a<e.length;a++){const i=n.get("imagePlaneModule",e[a]);if(!i){o=!1;break}t.push(i)}return{sufficientMetadata:o,imagePlanes:t}}(i);s||(be.warn("Insufficient imagePlaneModule information to calculate volume statistics."),e(null)),n=void 0===n?a.activeLabelmapIndex:n;const d=a.labelmaps3D[n],u=[];for(let e=0;e<i.length;e++)u.push(o.loadAndCacheImage(i[e]));Promise.all(u).then(n=>{const o=function(e,t,n,o){const a=function(e,t,n,o){const{rowPixelSpacing:a,columnPixelSpacing:i}=t[0],r=e.labelmaps2D,s=[];for(let e=0;e<r.length;e++){const c=r[e];if(c&&c.segmentsOnLabelmap.includes(o)){const r=Te(t,n,e)*a*i,l=c.pixelData,d=t[e].getPixelData(),u=[];for(let e=0;e<l.length;e++)l[e]===o&&u.push(d[e]);s.push({voxelInMM3:r,values:u})}}return s}(e,t,n,o);let i=0,r=a[0].values[0],s=r,c=0;for(let e=0;e<a.length;e++){const{values:t,voxelInMM3:n}=a[e];c+=n*t.length;let o=0;t.forEach(e=>{e>r?r=e:e<s&&(s=e),o+=e}),i+=o*n}i/=c;let l=0;for(let e=0;e<a.length;e++){const{values:t,voxelInMM3:n}=a[e];let o=0;t.forEach(e=>{o+=Math.pow(e-i,2)}),l+=o*n}return l/=c,l=Math.sqrt(l),{volume:c,mean:i,stdDev:l,max:r,min:s}}(d,n,l,t);e(o)})})},segmentOfActiveLabelmapAtEvent:function(e){const t=e.detail,{element:n,image:o,currentPoints:a}=t;if(!a)return void De.warn("Not a cornerstone input event.");const i=o.width,r=o.height;if(!n)return;const s=b(n,"stack").data[0],c=s.currentImageIdIndex,l=s.imageIds[0],d=P.series[l],u=d.activeLabelmapIndex,h=d.labelmaps3D[u];if(!h)return;const g=h.labelmaps2D[c];if(!g)return;const m=g.pixelData;let{x:f,y:p}=a.image;if(f=Math.floor(f),p=Math.floor(p),Pe({x:f,y:p},r,i)){const e=m[p*i+f];if(0===e)return;return{segmentIndex:e,metadata:h.metadata[e]}}},brushColor:function(e,t=!1){const n=u(e);if(!n)return;const o=b(n,"stack");if(!o)return void Be.error("Consumers must define stacks in their application if using segmentations in cornerstoneTools.");const a=o.data[0].imageIds[0],i=P.series[a];let r;if(i){const e=i.activeLabelmapIndex,t=i.labelmaps3D[e],n=t.activeSegmentIndex;r=P.colorLutTables[t.colorLUTIndex][n]}else r=P.colorLutTables[0][1];return t?"rgba(".concat(r[0],", ").concat(r[1],", ").concat(r[2],", 1.0 )"):"rgba(".concat(r[0],", ").concat(r[1],", ").concat(r[2],", 0.8 )")},labelmapBuffers:F,activeLabelmapBuffer:function(e){const t=u(e);if(!t)return;const n=b(t,"stack").data[0].imageIds[0],o=P.series[n];return o?F(t,o.activeLabelmapIndex):void 0},colorLUT:Le,colorForSegmentIndexColorLUT:function(e,t){return Le(e)[t]}},setters:{metadata:function(e,t=0,n,o){const a=u(e);if(!a)return;const i=c.cornerstone,r=b(a,"stack").data[0],s=r.imageIds[0];let l=P.series[s];if(l||(P.series[s]={labelmapIndex:t,labelmaps3D:[]},l=P.series[s]),!l.labelmaps3D[t]){const e=i.getEnabledElement(a),{rows:n,columns:o}=e.image;f(l,t,n*o*r.imageIds.length)}l.labelmaps3D[t].metadata[n]=o},labelmap3DForElement:function(e,t,n,o=[],a,i=0){const r=u(e);if(!r)return;const s=b(r,"stack"),c=s.data[0].imageIds.length;ye(s.data[0].imageIds[0],t,n,o,c,a,i),fe(r,n)},labelmap3DByFirstImageId:ye,incrementActiveSegmentIndex:function(e){const t=u(e);t&&k(t,"increase")},decrementActiveSegmentIndex:function(e){const t=u(e);t&&k(t,"decrease")},activeSegmentIndex:function(e,t){const n=u(e);if(!n)return;const o=b(n,"stack").data[0].imageIds[0],a=P.series[o];if(!a)return;const i=a.activeLabelmapIndex,r=a.labelmaps3D[i],{configuration:s}=ot("segmentation");t<=0?t=1:t>s.segmentsPerLabelmap&&(t=s.segmentsPerLabelmap),r.activeSegmentIndex=t},toggleSegmentVisibility:function(e,t,n){if(!t)return;const o=u(e);if(!o)return;const a=b(o,"stack").data[0].imageIds[0],i=P.series[a];if(!i)return void O.warn("brushStackState is undefined");if(n=void 0===n?i.activeLabelmapIndex:n,!i.labelmaps3D[n])return void O.warn("No labelmap3D of labelmap index ".concat(n," on stack."));const r=i.labelmaps3D[n].segmentsHidden;return r[t]=!r[t],!r[t]},updateSegmentsOnLabelmap2D:e=>{e.segmentsOnLabelmap=N(e.pixelData)},deleteSegment:function(e,t,n){if(!t)return;const o=u(e);if(!o)return;const a=b(o,"stack").data[0].imageIds[0],i=P.series[a];if(!i)return;n=void 0===n?i.activeLabelmapIndex:n;const r=i.labelmaps3D[n];if(!r)return;delete r.metadata[t];const s=r.labelmaps2D;for(let e=0;e<s.length;e++){const n=s[e];if(n&&n.segmentsOnLabelmap.includes(t)){const e=n.pixelData,o=n.segmentsOnLabelmap.indexOf(t);n.segmentsOnLabelmap.splice(o,1);for(let n=0;n<e.length;n++)e[n]===t&&(e[n]=0)}}c.cornerstone.updateImage(o)},colorLUT:Oe,colorLUTIndexForLabelmap3D:function(e,t){e.colorLUTIndex=t},colorForSegmentIndexOfColorLUT:function(e,t,n){Le(e)[t]=n},activeLabelmapIndex:function(e,t=0){const n=u(e);if(!n)return;const o=c.cornerstone,a=b(n,"stack").data[0],i=o.getEnabledElement(n),{rows:r,columns:s}=i.image,l=r*s*a.imageIds.length,d=a.imageIds[0];let h=P.series[d];h?(h.activeLabelmapIndex=t,h.labelmaps3D[t]||f(h,t,l)):(P.series[d]={activeLabelmapIndex:t,labelmaps3D:[]},h=P.series[d],f(h,t,l)),o.updateImage(n)},radius:function(e){const{configuration:t}=ot("segmentation");t.radius=Math.min(Math.max(e,t.minRadius),t.maxRadius)},pushState:function(e,t,n){const o=H(e,n);o.undo.push(t),o.redo=[]},undo:function(e,t){const n=H(e,t),{undo:o,redo:a}=n;if(!o.length)return void je.warn("No undos left.");const i=o.pop();qe(n,i,1),a.push(i),c.cornerstone.updateImage(e)},redo:function(e,t){const n=H(e,t),{undo:o,redo:a}=n;if(!a.length)return void je.warn("No redos left.");const i=a.pop();qe(n,i,2),o.push(i),c.cornerstone.updateImage(e)}}};const Ge={activeManipulators:{}};function Ye(e){const t=c.cornerstone.getEnabledElement(e).uuid,{activeManipulators:n}=Ge;delete n[t]}function Xe(e){const{activeManipulators:t}=Ge,n=t[e];"function"==typeof n&&n(),delete t[e]}function Ke(e){const t=e.detail,{element:n}=t;Ye(n)}var Ze={setters:{addActiveManipulatorForElement:function(e,t){const n=c.cornerstone.getEnabledElement(e).uuid;Ge.activeManipulators[n]=t},removeActiveManipulatorForElement:Ye,cancelActiveManipulatorsForElement:function(e){Xe(c.cornerstone.getEnabledElement(e).uuid)},cancelActiveManipulators:function(){const{activeManipulators:e}=Ge;Object.keys(e).forEach(e=>Xe(e))}},state:Ge,enabledElementCallback:function(e){const{NEW_IMAGE:t}=c.cornerstone.EVENTS;e.removeEventListener(t,Ke),e.addEventListener(t,Ke)},removeEnabledElementCallback:function(e){const{NEW_IMAGE:t}=c.cornerstone.EVENTS;e.removeEventListener(t,Ke),Ye(e)}};const $e={iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="ACTIVE_COLOR" d="M8 16L8 0"></path>\n    <path stroke="ACTIVE_COLOR" d="M16 8L0 8"></path>\n  '};var Je={configuration:$e,getters:{defaultOptions:()=>$e},setters:{defaultOptions:e=>{Object.assign($e,e)}}};var Qe={configuration:{mouseEnabled:!0,touchEnabled:!0,globalToolSyncEnabled:!1,showSVGCursors:!1,autoResizeViewports:!0,lineDash:[4,4]}};I("store:modules:storeLogger");const et={globalTools:{},globalToolChangeHistory:[],enabledElements:[],tools:[],isToolLocked:!1,activeMultiPartTool:null,mousePositionImage:{},clickProximity:6,touchProximity:10,handleRadius:6,deleteIfHandleOutsideImage:!0,preventHandleOutsideImage:!1,preventTextBoxOutsideDisplayedArea:!1,handleTouchOffset:{x:0,y:-57},svgCursorUrl:null},tt={mouseTools:()=>et.tools.filter(e=>e.supportedInteractionTypes.includes("Mouse")),touchTools:()=>et.tools.filter(e=>e.supportedInteractionTypes.includes("Touch")),enabledElementByUID:e=>et.enabledElements.find(t=>c.cornerstone.getEnabledElement(t).uuid===e)},nt={segmentation:We,cursor:Je,globalConfiguration:Qe,manipulatorState:Ze};function ot(e){return nt[e]}var at={modules:nt,state:et,getters:tt},it=function(e,t){return et.tools.find(n=>n.element===e&&n.name===t)};const rt=nt.globalConfiguration;function st(e,t){if(!rt.configuration.showSVGCursors)return;const n=t.getIconWithPointerSVG(),o=t.mousePoint,a=window.URL.createObjectURL(n);e.style.cursor="url('".concat(a,"') ").concat(o,", auto"),et.svgCursorUrl=a}function ct(e){rt.configuration.showSVGCursors&&lt(e,"none")}function lt(e,t){et.svgCursorUrl&&window.URL.revokeObjectURL(et.svgCursorUrl),et.svgCursorUrl=null,e.style.cursor=t}const dt=ot("globalConfiguration"),ut=I("store:setToolMode"),ht=function(e,t,n,o){void 0===o&&Array.isArray(n)&&(o=n,n=null);const a=it(e,t);a&&(function(e,t,n,o){t.supportedInteractionTypes.forEach(a=>{if(void 0===o||o.includes(a)){const o=Et[a];o?o(t,e,n):ut.warn("Unable to resolve input conflicts for type %s",a)}}),at.state.tools.filter(t=>t.element===e&&"active"===t.mode&&t.supportedInteractionTypes.length>0).forEach(t=>{let n=!1;t.supportedInteractionTypes.forEach(e=>{t.options["is".concat(e,"Active")]&&(n=!0)}),n||(ut.log("Setting tool %s's to PASSIVE",t.name),xt(e,t.name))})}(e,a,n,o),a.supportedInteractionTypes.forEach(e=>{void 0===o||o.includes(e)?n["is".concat(e,"Active")]=!0:n["is".concat(e,"Active")]=!1}),dt.configuration.showSVGCursors&&a.supportedInteractionTypes.includes("Mouse")&&function(e,t,n){let o;o="number"==typeof t?[t]:t.mouseButtonMask;o.includes(1)&&(n.svgCursor?st(n.element,n.svgCursor):n.hideDefaultCursor?ct(e):function(e){lt(e,"initial")}(e))}(e,n,a)),bt("active",null,e,t,n)};const gt=function(e,t,n){Mt("active",e,t,n),at.state.enabledElements.forEach(o=>{ht(o,e,t,n)})},mt=bt.bind(null,"disabled",null),ft=Tt.bind(null,"disabled",null),pt=bt.bind(null,"enabled",null),vt=Tt.bind(null,"enabled",null),xt=bt.bind(null,"passive",l.TOOL_DEACTIVATED),yt=Tt.bind(null,"passive",l.TOOL_DEACTIVATED);function bt(e,t,n,o,a){const i=it(n,o);var r,s;if(i){if(a=wt(a),Array.isArray(a.mouseButtonMask)&&0!==a.mouseButtonMask.length&&Array.isArray(i.options.mouseButtonMask)&&(a.mouseButtonMask=(r=a.mouseButtonMask,s=i.options.mouseButtonMask,r.concat(s).reduce((e,t)=>(-1===e.indexOf(t)&&e.push(t),e),[]))),i.mode=e,i.mergeOptions(a),i["".concat(e,"Callback")]&&i["".concat(e,"Callback")](n,a),t){d(n,t,{options:a,toolName:o,toolType:o,type:t})}}else ut.warn('Unable to find tool "%s" for enabledElement',o)}function Tt(e,t,n,o){Mt(e,n,o),at.state.enabledElements.forEach(a=>{bt(e,t,a,n,o)})}function Ct(e,t,n){const o="is".concat(e,"Active"),a=at.state.tools.find(e=>e.element===n&&"active"===e.mode&&!0===e.options[o]);a&&(ut.log("Setting tool %s's %s to false",a.name,o),a.options[o]=!1)}function Mt(e,t,n,o){if(!dt.configuration.globalToolSyncEnabled)return;const a={mode:e,args:[t,n]};o&&a.push(o),at.state.globalToolChangeHistory.push(a);at.state.globalToolChangeHistory.length>50&&at.state.globalToolChangeHistory.shift();const i=at.state.globalTools[t];if(i)if("active"===e){let e=function(e,t,n){void 0===n&&Array.isArray(t)&&(n=t,t=null);const o=[],a=at.state.globalTools[e];if(a){const e=new a.tool(a.props);e.supportedInteractionTypes.forEach(a=>{if(void 0===n||n.includes(a))if("Mouse"===a){const e=wt(t).mouseButtonMask;Array.isArray(e)&&e.length>0?e.forEach(e=>o.push("".concat(a,"-").concat(e))):Array.isArray(e)&&0===e.length&&o.push("".concat(a,"-DELETE"))}else"MultiTouch"===a?o.push("".concat(a,"-").concat(e.configuration.touchPointers)):o.push(a)})}return o}(t,n,o);Object.keys(at.state.globalTools).forEach(t=>{const n=at.state.globalTools[t];n.activeBindings=n.activeBindings.filter(t=>!e.includes(t))}),e.some(e=>e.includes("Mouse-DELETE"))&&(i.activeBindings=i.activeBindings.filter(e=>!e.includes("Mouse")),e=e.filter(e=>!e.includes("Mouse"))),i.activeBindings=i.activeBindings.concat(e)}else i.activeBindings=[];else ut.warn("setToolMode call for tool not available globally: ".concat(t))}const Et={Mouse:function(e,t,n){const o=wt(n).mouseButtonMask;if(!(Array.isArray(o)&&o.length>0))return;const a=at.state.tools.find(e=>e.element===t&&"active"===e.mode&&!0===e.options.isMouseActive&&Array.isArray(e.options.mouseButtonMask)&&e.options.mouseButtonMask.some(e=>o.includes(e)));a&&(a.options.mouseButtonMask=a.options.mouseButtonMask.filter(e=>!o.includes(e)),0===a.options.mouseButtonMask.length&&(a.options.isMouseActive=!1))},MouseWheel:Ct.bind(void 0,"MouseWheel"),Touch:function(e,t){const n=at.state.tools.find(e=>e.element===t&&"active"===e.mode&&!0===e.options.isTouchActive),o=at.state.tools.find(e=>e.element===t&&"active"===e.mode&&!0===e.options.isMultiTouchActive&&1===e.configuration.touchPointers);n&&(ut.log("Setting tool %s's isTouchActive to false",n.name),n.options.isTouchActive=!1),o&&(ut.log("Setting tool %s's isTouchActive to false",o.name),o.options.isMultiTouchActive=!1)},TouchPinch:Ct.bind(void 0,"TouchPinch"),TouchRotate:Ct.bind(void 0,"TouchRotate"),DoubleTap:Ct.bind(void 0,"DoubleTap"),MultiTouch:function(e,t){const n=at.state.tools.find(n=>n.element===t&&"active"===n.mode&&!0===n.options.isMultiTouchActive&&n.configuration.touchPointers===e.configuration.touchPointers);let o;1===e.configuration.touchPointers&&(o=at.state.tools.find(e=>e.element===t&&"active"===e.mode&&!0===e.options.isTouchActive)),n&&(ut.log("Setting tool %s's isMultiTouchActive to false",n.name),n.options.isMultiTouchActive=!1),o&&(ut.log("Setting tool %s's isTouchActive to false",o.name),o.options.isTouchActive=!1)}};function wt(e){return Array.isArray(e)?e={mouseButtonMask:e}:e!==Object(e)&&(e={mouseButtonMask:[e]}),e.hasOwnProperty("mouseButtonMask")||(e.mouseButtonMask=[]),Array.isArray(e.mouseButtonMask)||(e.mouseButtonMask=[e.mouseButtonMask]),e.mouseButtonMask=e.mouseButtonMask.filter(e=>"number"==typeof e&&0!==e),e}var It={passiveCallback:function(e){mt(e,this.name)},enabledCallback:function(e){ht(e,this.name)}};var St={passiveCallback:function(e){mt(e,this.name)},activeCallback:function(e){pt(e,this.name)}},_t=function(e,t){e.save(),t(e),e.restore()};let Pt=1,Dt=2;var kt={setToolWidth:function(e){Pt=e},getToolWidth:function(){return Pt},setActiveWidth:function(e){Dt=e},getActiveWidth:function(){return Dt}},Ot=function(e,t={},n){const{color:o,lineWidth:a,fillStyle:i,lineDash:r,shouldDrawLines:s=!0}=t;e.beginPath(),e.strokeStyle=o||e.strokeStyle,e.lineWidth=a||void 0===a&&kt.getToolWidth()||e.lineWidth,r&&e.setLineDash(r),n(e),i&&(e.fillStyle=i,e.fill()),s&&e.stroke(),r&&e.setLineDash([])};function Lt(e,t,n,o,a,i="pixel"){Ot(e,a,e=>{"pixel"===i&&(n=c.cornerstone.pixelToCanvas(t,n),o=c.cornerstone.pixelToCanvas(t,o)),e.moveTo(n.x,n.y),e.lineTo(o.x,o.y)})}var At=function(e,t,n,o,a,i="pixel"){Ot(e,a,e=>{"pixel"===i&&(n=c.cornerstone.pixelToCanvas(t,n),o=o.map(e=>c.cornerstone.pixelToCanvas(t,e))),e.moveTo(n.x,n.y),o.forEach(({x:t,y:n})=>{e.lineTo(t,n)})})},Ht=function(e,t,n,o,a,i){const r=Math.atan2(n.y-t.y,n.x-t.x);let s={color:o,lineWidth:a};i&&(s.lineDash=i),Lt(e,void 0,t,n,s,"canvas"),s={color:o,lineWidth:a,fillStyle:o};const c=[{x:n.x-10*Math.cos(r-Math.PI/7),y:n.y-10*Math.sin(r-Math.PI/7)},{x:n.x-10*Math.cos(r+Math.PI/7),y:n.y-10*Math.sin(r+Math.PI/7)},n];At(e,void 0,n,c,s,"canvas")},Rt=function(e,t,n,o,a,i="pixel"){"pixel"===i&&(n=c.cornerstone.pixelToCanvas(t,n)),Ot(e,a,e=>{e.arc(n.x,n.y,o,0,2*Math.PI)})};function Ut(e){const t=c.cornerstoneMath;if(e instanceof t.Vector3)return e;const n=Object.keys(e);return n.includes("x")&&n.includes("y")&&n.includes("z")?new t.Vector3(e.x,e.y,e.z):new t.Vector3(e[0],e[1],e[2])}function Ft(e,t){const n=Ut(t.rowCosines),o=Ut(t.columnCosines),a=Ut(t.imagePositionPatient),i=e.clone().sub(a);return{x:n.dot(i)/t.columnPixelSpacing,y:o.dot(i)/t.rowPixelSpacing}}function Nt(e,t){const n=Ut(t.rowCosines),o=Ut(t.columnCosines),a=Ut(t.imagePositionPatient),i=n.clone().multiplyScalar(e.x);i.multiplyScalar(t.columnPixelSpacing);const r=o.clone().multiplyScalar(e.y);r.multiplyScalar(t.rowPixelSpacing);const s=i.add(r);return s.add(a),s}function Bt(e,t){const n=Ut(e.rowCosines),o=Ut(e.columnCosines),a=Ut(e.imagePositionPatient),i=Ut(t.rowCosines),r=Ut(t.columnCosines),s=Ut(t.imagePositionPatient),l=n.clone().cross(o),d=new c.cornerstoneMath.Plane;d.setFromNormalAndCoplanarPoint(l,a);const u=i.clone().cross(r),h=new c.cornerstoneMath.Plane;h.setFromNormalAndCoplanarPoint(u,s);const g=h.clone().intersectPlane(d),m=g.origin,f=g.direction,p=Nt({x:t.columns,y:t.rows},t),v=s.distanceTo(p),x=new c.cornerstoneMath.Line3;x.start=m,x.end=m.clone().add(f.multiplyScalar(v));const y=function(e,t){const n=[];return Object.keys(t).forEach((function(o){const a=t[o],i=e.intersectLine(a);i&&n.push(i)})),n}(x,function(e){const t=Nt({x:0,y:0},e),n=Nt({x:e.columns,y:0},e),o=Nt({x:0,y:e.rows},e),a=Nt({x:e.columns,y:e.rows},e);return{top:new c.cornerstoneMath.Line3(t,n),left:new c.cornerstoneMath.Line3(t,o),right:new c.cornerstoneMath.Line3(n,a),bottom:new c.cornerstoneMath.Line3(o,a)}}(t));if(2===y.length)return{start:y[0],end:y[1]}}function Vt(e,t,n){const o=n*(Math.PI/180);return{x:Math.cos(o)*(e.x-t.x)-Math.sin(o)*(e.y-t.y)+t.x,y:Math.sin(o)*(e.x-t.x)+Math.cos(o)*(e.y-t.y)+t.y}}var zt=function(e,t,n,o,a,i="pixel",r=0){"pixel"===i&&(n=c.cornerstone.pixelToCanvas(t,n),o=c.cornerstone.pixelToCanvas(t,o));const s=c.cornerstone.getViewport(t),{clientWidth:l,clientHeight:d}=t,{scale:u,translation:h}=s,g=s.rotation-r,m={x:l/2+h.x*u,y:d/2+h.y*u};Math.abs(g)>.05&&(n=Vt(n,m,-g),o=Vt(o,m,-g));const f=Math.abs(n.x-o.x),p=Math.abs(n.y-o.y),v=Math.min(n.x,o.x),x=Math.min(n.y,o.y);let y={x:v+f/2,y:x+p/2};Math.abs(g)>.05&&(y=Vt(y,m,g));const b=g*Math.PI/180;Ot(e,a,e=>{e.ellipse(y.x,y.y,f/2,p/2,b,0,2*Math.PI),e.closePath()})};let jt="white",qt="greenyellow",Wt="transparent";var Gt={setFillColor:function(e){Wt=e},getFillColor:function(){return Wt},setToolColor:function(e){jt=e},getToolColor:function(){return jt},setActiveColor:function(e){qt=e},getActiveColor:function(){return qt},getColorIfActive:function(e){return e.color?e.color:e.active?qt:jt}},Yt=function(e,t,n,o={}){const a=t.element,i=Gt.getToolColor();e.strokeStyle=o.color||i;const r=Object.keys(n);for(let t=0;t<r.length;t++){const i=n[r[t]];if(!0===i.drawnIndependently)continue;if(!0===o.drawHandlesIfActive&&!i.active)continue;if(o.hideHandlesIfMoving&&i.moving)continue;const s={lineWidth:i.active?kt.getActiveWidth():kt.getToolWidth(),fillStyle:o.fill};o.lineDash&&(s.lineDash=o.lineDash),Ot(e,s,e=>{const t=c.cornerstone.pixelToCanvas(a,i),n=i.radius||o.handleRadius||et.handleRadius;e.arc(t.x,t.y,n,0,2*Math.PI)})}},Xt=function(e,t,n,o,a="pixel"){Ot(e,o,e=>{n.forEach(n=>{let o=n.start,i=n.end;if("pixel"===a){const e=c.cornerstone;o=e.pixelToCanvas(t,o),i=e.pixelToCanvas(t,i)}e.moveTo(o.x,o.y),e.lineTo(i.x,i.y)})})},Kt=function(e,t,n,o,a,i){const r=e.length>0?c.cornerstoneMath.point.findClosestPoint(e,t):t,s=[{x:n.left+n.width/2,y:n.top},{x:n.left,y:n.top+n.height/2},{x:n.left+n.width/2,y:n.top+n.height},{x:n.left+n.width,y:n.top+n.height/2}];Lt(o,void 0,r,c.cornerstoneMath.point.findClosestPoint(s,r),{color:a,lineWidth:i,lineDash:[2,3]},"canvas")};const Zt={fontSize:15,fontFamily:"Arial",backgroundColor:"transparent"};function $t(e){if("string"!=typeof e)throw new Error("Font family must be a valid string");Zt.fontFamily=e}function Jt(e){if("number"!=typeof e||isNaN(e)||!isFinite(e))throw new Error("Font size must be a valid number");Zt.fontSize=parseFloat(e)}var Qt={setFont:function(e){const t=e.split("px ");2===t.length&&(Jt(parseFloat(t[0])),$t(t[1]))},getFont:function(){return"".concat(Zt.fontSize,"px ").concat(Zt.fontFamily)},setFontSize:Jt,getFontSize:function(){return Zt.fontSize},setFontFamily:$t,getFontFamily:function(){return Zt.fontFamily},setBackgroundColor:function(e){Zt.backgroundColor=e},getBackgroundColor:function(){return Zt.backgroundColor}},en=function(e,t,n,o,a){const i=Qt.getFontSize();e.font=Qt.getFont(),e.textBaseline="top",e.fillStyle=o,n.forEach((function(n,o){e.fillText(n,t.left+a,t.top+a+o*(i+a))}))},tn=function(e,t,n){e.fillStyle=n,e.fillRect(t.left,t.top,t.width,t.height)};function nn(e,t,n){const o=Qt.getFont(),a=e.font;o&&o!==a&&(e.font=o);const i=e.measureText(t).width;return o&&o!==a&&(e.font=a),i+2*n}var on=function(e,t,n,o,a,i={}){"[object Array]"!==Object.prototype.toString.call(t)&&(t=[t]);const r=Qt.getFontSize(),s=Qt.getBackgroundColor();let c=0;t.forEach((function(t){const n=nn(e,t,5);c=Math.max(c,n)}));const l={width:c,height:5+t.length*(r+5)};return _t(e,e=>{e.strokeStyle=a,i.centering&&(!0===i.centering.x&&(n-=l.width/2),!0===i.centering.y&&(o-=l.height/2)),l.left=n,l.top=o,"function"==typeof i.displacer&&i.displacer(l),tn(e,l,s),en(e,l,t,a,5)}),l};function an(e,t,n){return Math.min(Math.max(t,e),n)}function rn(e,t){const n=t.left||0,o=t.top||0;e.x=an(e.x,n,n+t.width),e.y=an(e.y,o,o+t.height)}const sn=(e,t,n,o,a,i)=>{i-a<o-n?(e[t]+=a-n,e[t]+=(i-a)/2,e[t]-=(o-n)/2):n<a?e[t]+=a-n:o>i&&(e[t]-=o-i)};function cn(e,t){const{pixelToCanvas:n,canvasToPixel:o,getViewport:a,getEnabledElement:i,getDisplayedArea:r}=c.cornerstone,s=o(e,{x:t.left,y:t.top}),{minX:l,minY:d,maxX:u,maxY:h}=((e,t)=>{const n=t=>c.cornerstone.canvasToPixel(e,t),{top:o,left:a,width:i,height:r}=t,s=[n({x:a,y:o}),n({x:a+i,y:o}),n({x:a,y:o+r}),n({x:a+i,y:o+r})],l=s.map(e=>e.x),d=s.map(e=>e.y);return{minX:Math.min(...l),minY:Math.min(...d),maxX:Math.max(...l),maxY:Math.max(...d)}})(e,t),g=a(e),m=r(i(e).image,g),{tlhc:f,brhc:p}=g.displayedArea?g.displayedArea:m,v=f.y-1,x=f.x-1,y=p.y,b=p.x;sn(s,"y",d,h,v,y),sn(s,"x",l,u,x,b);const T=n(e,s);t.top=T.y,t.left=T.x}var ln=an,dn=function(e,t,n,o,a,i,r,s,l,d){const{pixelToCanvas:u}=c.cornerstone,h=u(t,n);l&&(h.x+=l);const g={centering:{x:!1,y:d}};if(et.preventTextBoxOutsideDisplayedArea&&(g.displacer=e=>cn(t,e)),n.boundingBox=on(e,o,h.x,h.y,r,g),n.hasMoved){const o=i(a).map(e=>u(t,e));Kt(o,h,n.boundingBox,e,r,s)}},un=function(e,t,n,o,a,i="pixel",r=0){if("pixel"===i){const e=c.cornerstone;n=e.pixelToCanvas(t,n),o=e.pixelToCanvas(t,o)}const s=c.cornerstone.getViewport(t),{clientWidth:l,clientHeight:d}=t,{scale:u,translation:h}=s,g=s.rotation-r,m={x:l/2+h.x*u,y:d/2+h.y*u};Math.abs(g)>.05&&(n=Vt(n,m,-g),o=Vt(o,m,-g));const f=Math.abs(n.x-o.x),p=Math.abs(n.y-o.y);n={x:Math.min(n.x,o.x),y:Math.min(n.y,o.y)},o={x:n.x+f,y:n.y+p};let v={x:n.x+f,y:n.y},x={x:n.x,y:n.y+p};Math.abs(g)>.05&&(n=Vt(n,m,g),o=Vt(o,m,g),v=Vt(v,m,g),x=Vt(x,m,g)),Ot(e,a,e=>{e.moveTo(n.x,n.y),e.lineTo(v.x,v.y),e.lineTo(o.x,o.y),e.lineTo(x.x,x.y),e.lineTo(n.x,n.y)})},hn=function(e){const t=e.getContext("2d");return t.setTransform(1,0,0,1,0,0),t},gn=function(e,t){return void 0===e?t:e},mn=function(e,t={}){t.shadow&&(e.shadowColor=gn(t.shadowColor,"#000000"),e.shadowBlur=gn(t.shadowBlur,0),e.shadowOffsetX=gn(t.shadowOffsetX,1),e.shadowOffsetY=gn(t.shadowOffsetY,1))};var fn=e=>0===Object.keys(e).length&&e.constructor===Object;const{getters:pn,setters:vn}=ot("segmentation");function xn(){this.handles={start:{},end:{}}}function yn(e){const t=e.detail.element,n=e.detail.currentPoints.image;return fn(this.handles.start)?this.handles.start=n:(this.handles.end=n,this._applyStrategy(e)),c.cornerstone.updateImage(t),!0}function bn(e){const{element:t,currentPoints:n}=e.detail,{image:o}=n;this.handles.end=o,c.cornerstone.updateImage(t)}function Tn(e){e.detail.handles=this.handles;const{element:t}=e.detail,{labelmap2D:n,labelmap3D:o,currentImageIdIndex:a}=pn.labelmap2D(t),i=n.pixelData,r=i.slice(),s={points:{start:{x:this.handles.start.x,y:this.handles.start.y},end:{x:this.handles.end.x,y:this.handles.end.y}},pixelData:i,segmentIndex:o.activeSegmentIndex,segmentationMixinType:"circleSegmentationMixin"};this.applyActiveStrategy(e,s);const l={imageIdIndex:a,diff:pe(r,i)};vn.pushState(this.element,[l]),vn.updateSegmentsOnLabelmap2D(n),c.cornerstone.updateImage(t),this._resetHandles()}var Cn={postTouchStartCallback:yn,postMouseDownCallback:yn,mouseClickCallback:yn,touchDragCallback:bn,mouseDragCallback:bn,mouseMoveCallback:bn,touchEndCallback:Tn,mouseUpCallback:Tn,initializeMixin:xn,renderToolData:function(e){const t=e.detail,{element:n}=t,o=pn.brushColor(n,!0),a=hn(t.canvasContext.canvas),{distance:i}=c.cornerstoneMath.point;_t(a,e=>{if(!this.handles)return null;const t=c.cornerstone.pixelToCanvas(n,this.handles.start),a=c.cornerstone.pixelToCanvas(n,this.handles.end),r=i(t,a);Rt(e,n,this.handles.start,r,{color:o})})},_resetHandles:xn,_applyStrategy:Tn};const Mn=I("tools:ScissorsTool"),{getters:En,setters:wn}=ot("segmentation");function In(e){const t=e.detail.element,n=e.detail.currentPoints.image,o=this.handles.points;if(!o.length)return Mn.warn("Something went wrong, empty handles detected."),null;o.push({x:n.x,y:n.y,lines:[]}),this.currentHandle+=1,c.cornerstone.updateImage(t)}function Sn(e){const t=e.detail,n=e.detail.element;this._addPoint(t),c.cornerstone.updateImage(n)}function _n(e){const t=this.handles.points,{element:n}=e.detail,{labelmap2D:o,labelmap3D:a,currentImageIdIndex:i}=En.labelmap2D(n),r=o.pixelData,s=r.slice(),l={points:t,pixelData:r,segmentIndex:a.activeSegmentIndex,segmentationMixinType:"freehandSegmentationMixin"};this.applyActiveStrategy(e,l);const d={imageIdIndex:i,diff:pe(s,r)};wn.pushState(this.element,[d]),wn.updateSegmentsOnLabelmap2D(o),c.cornerstone.updateImage(n),this._resetHandles()}function Pn(){this.handles={points:[]},this.currentHandle=0}var Dn={postTouchStartCallback:In,postMouseDownCallback:In,mouseClickCallback:In,touchDragCallback:Sn,mouseDragCallback:Sn,mouseMoveCallback:Sn,touchEndCallback:_n,mouseUpCallback:_n,initializeMixin:Pn,renderToolData:function(e){const t=e.detail,{element:n}=t,o=En.brushColor(n,!0),a=hn(t.canvasContext.canvas),i=this.handles.points;i.length<2||_t(a,e=>{for(let t=0;t<i.length;t++){const a=[...i[t].lines];t===i.length-1&&a.push(i[0]),At(e,n,i[t],a,{color:o})}})},_resetHandles:Pn,_addPoint:function(e){const t=this.handles.points;t.length&&t[this.currentHandle-1].lines.push({x:e.currentPoints.image.x,y:e.currentPoints.image.y,lines:[]}),t.push({x:e.currentPoints.image.x,y:e.currentPoints.image.y,lines:[]}),this.currentHandle+=1,c.cornerstone.updateImage(e.element)},_applyStrategy:_n};const{getters:kn}=ot("segmentation");var On=Object.assign({},Dn,{renderToolData:function(e){const t=e.detail,{element:n}=t,o=kn.brushColor(n,!0),a=hn(t.canvasContext.canvas),i=this.handles;_t(a,e=>{if(i.points.length>1)for(let t=0;t<i.points.length;t++){const a=[...i.points[t].lines];At(e,n,this.handles.points[t],a,{color:o})}})}});const{getters:Ln,setters:An}=ot("segmentation");function Hn(e){const t=e.detail.element,n=e.detail.currentPoints.image;return fn(this.handles.start)?this.handles.start=n:(this.handles.end=n,this._applyStrategy(e)),c.cornerstone.updateImage(t),!0}function Rn(e){const{element:t,currentPoints:{image:n}}=e.detail;this.handles.end=n,c.cornerstone.updateImage(t)}function Un(e){e.detail.handles=this.handles;const{element:t}=e.detail,{labelmap2D:n,labelmap3D:o,currentImageIdIndex:a}=Ln.labelmap2D(t),i=n.pixelData,r=i.slice(),s={points:[{x:this.handles.start.x,y:this.handles.start.y},{x:this.handles.end.x,y:this.handles.end.y}],pixelData:i,segmentIndex:o.activeSegmentIndex,segmentationMixinType:"rectangleSegmentationMixin"};this.applyActiveStrategy(e,s);const l={imageIdIndex:a,diff:pe(r,i)};An.pushState(this.element,[l]),An.updateSegmentsOnLabelmap2D(n),c.cornerstone.updateImage(t),this._resetHandles()}function Fn(){this.handles={start:{},end:{}}}var Nn={activeOrDisabledBinaryTool:It,enabledOrDisabledBinaryTool:St,circleSegmentationMixin:Cn,polylineSegmentationMixin:On,freehandSegmentationMixin:Dn,rectangleSegmentationMixin:{postTouchStartCallback:Hn,postMouseDownCallback:Hn,mouseClickCallback:Hn,touchDragCallback:Rn,mouseDragCallback:Rn,mouseMoveCallback:Rn,touchEndCallback:Un,mouseUpCallback:Un,initializeMixin:Fn,renderToolData:function(e){const t=e.detail,{element:n}=t,o=Ln.brushColor(n,!0),a=hn(t.canvasContext.canvas);_t(a,e=>{un(e,n,this.handles.start,this.handles.end,{color:o})})},_resetHandles:Fn,_applyStrategy:Un},renderBrushMixin:{renderBrush:function(e){const{cornerstone:t}=c,{getters:n,configuration:o}=ot("segmentation"),a=e.detail,i=a.viewport;let r;if(this._drawing?r=this._lastImageCoords:this._mouseUpRender?(r=this._lastImageCoords,this._mouseUpRender=!1):r=at.state.mousePositionImage,!r)return;const{rows:s,columns:l}=a.image,{x:d,y:u}=r;if(d<0||d>l||u<0||u>s)return;const h=o.radius,g=a.canvasContext,m=a.element,f=n.brushColor(m,this._drawing);g.setTransform(1,0,0,1,0,0);const p=h*i.scale,v=t.pixelToCanvas(m,r);g.beginPath(),g.strokeStyle=f,g.ellipse(v.x,v.y,p,p,0,0,2*Math.PI),g.stroke()}}};const Bn=e=>e&&"object"==typeof e&&"[object RegExp]"!==Object.prototype.toString.call(e)&&"[object Date]"!==Object.prototype.toString.call(e),Vn=(e,t)=>{return t&&!0===t.clone&&Bn(e)?jn((n=e,Array.isArray(n)?[]:{}),e,t):e;var n},zn=(e,t,n)=>{const o=e.slice();return t.forEach((function(t,a){void 0===o[a]?o[a]=Vn(t,n):Bn(t)?o[a]=jn(e[a],t,n):-1===e.indexOf(t)&&o.push(Vn(t,n))})),o},jn=(e={},t={},n)=>{const o=Array.isArray(t),a=(n||{arrayMerge:zn}).arrayMerge||zn;return o?Array.isArray(e)?a(e,t,n):Vn(t,n):((e,t,n)=>{const o={};return Bn(e)&&Object.keys(e).forEach((function(t){o[t]=Vn(e[t],n)})),Object.keys(t).forEach((function(a){Bn(t[a])&&e[a]?o[a]=jn(e[a],t[a],n):o[a]=Vn(t[a],n)})),o})(e,t,n)};var qn=jn;const Wn=I("tools:base:BaseTool"),Gn=ot("globalConfiguration");var Yn=class{constructor(e,t){this.initialConfiguration=qn(t,e);const{name:n,strategies:o,defaultStrategy:a,configuration:i,supportedInteractionTypes:r,mixins:s,svgCursor:c}=this.initialConfiguration;this.name=n,this.mode="disabled",this.element=void 0,this.supportedInteractionTypes=r||[],this.strategies=o||{},this.defaultStrategy=a||Object.keys(this.strategies)[0]||void 0,this.activeStrategy=this.defaultStrategy,c&&(this.svgCursor=c),this._options={},this._configuration=Object.assign({},i),this.updateOnMouseMove=!1,this.hideDefaultCursor=!1,s&&s.length&&this._applyMixins(s),this._cursors=Object.assign({},this.initialConfiguration.cursors);const l=this.defaultStrategy&&this._cursors[this.activeStrategy];l&&(this.svgCursor=l)}static get configuration(){}get configuration(){return this._configuration}set configuration(e){this._configuration=e}get options(){return this._options}mergeOptions(e){this._options=Object.assign({},this._options,e)}clearOptions(){this._options={}}applyActiveStrategy(e,t){return this.strategies[this.activeStrategy].call(this,e,t)}_applyMixins(e){for(let t=0;t<e.length;t++){const n=Nn["".concat(e[t])];"object"==typeof n?(Object.assign(this,n),"function"==typeof this.initializeMixin&&this.initializeMixin()):Wn.warn("".concat(this.name,": mixin ").concat(Nn[t]," does not exist."))}"function"===this.initializeMixin&&delete this.initializeMixin}setActiveStrategy(e){this.activeStrategy=e,Gn.configuration.showSVGCursors&&this.changeCursor(this.element,e)}changeCursor(e,t){if(!e)return;const n=this._cursors[t];n&&(this.svgCursor=n,"active"===this.mode&&st(e,n))}},Xn=function(e,t){if(e.boundingBox)return c.cornerstoneMath.point.insideRect(t,e.boundingBox)};const Kn=function(e,t,n,o){if(e.hasOwnProperty("pointNearHandle")){if(e.pointNearHandle(t,e,n))return!0}else if(!0===e.hasBoundingBox){if(Xn(e,n))return!0}else{const a=c.cornerstone.pixelToCanvas(t,e);if(c.cornerstoneMath.point.distance(a,n)<=o)return!0}return!1};var Zn=function e(t,n,o,a){let i;if(n){if(Array.isArray(n)){const e=Object.keys(n);for(let r=0;r<e.length;r++){const s=n[e[r]];if(s.hasOwnProperty("x")&&s.hasOwnProperty("y")&&Kn(s,t,o,a)){i=s;break}}}else if("object"==typeof n){const r=Object.keys(n);for(let s=0;s<r.length;s++){const c=r[s];if(Array.isArray(n[c])){if(i=e(t,n[c],o,a),i)break}else{const e=n[c];if(Kn(e,t,o,a)){i=e;break}}}}return i}},$n=function(e,t,n,o){o||(o=6);const a=function(e){let t;return Object.keys(e).forEach((function(n){const o=e[n];!0!==o.active||(t=o)})),t}(t),i=Zn(e,t,n,o);return a!==i&&(void 0!==i&&(i.active=!0),void 0!==a&&(a.active=!1),!0)};var Jn=n(11),Qn=n.n(Jn),eo=function(e,t){const n=e.image,o={left:0,top:0,width:n.width,height:n.height};let a=!1;return Object.keys(t).forEach((function(e){const n=t[e];!0!==n.allowedOutsideImage&&!1===c.cornerstoneMath.point.insideRect(n,o)&&(a=!0)})),a},to=function(e,t){const{currentPoints:n,element:o}=e,{page:a}=n,{handleTouchOffset:i}=et;let r=0,s=0;return"touch"===t&&(r=i.x,s=i.y),c.cornerstone.pageToPixel(o,a.x+r,a.y+s)},no=function(e,t,n){return t.filter(t=>t.element===e&&"active"===t.mode&&(void 0===n||t.options["is".concat(n,"Active")]))},oo=function(e,t){return"active"===it(e,t).mode};const ao=ot("segmentation");var io=class extends Yn{constructor(e,t={}){t.configuration||(t.configuration={alwaysEraseOnClick:!1}),super(e,t),this.updateOnMouseMove=!0,this.hideDefaultCursor=!0,this._drawing=!1,this._drawingMouseUpCallback=this._drawingMouseUpCallback.bind(this)}renderBrush(e){throw new Error("Method renderBrush not implemented for ".concat(this.name,"."))}_paint(e){throw new Error("Method _paint not implemented for ".concat(this.name,"."))}mouseDragCallback(e){const{currentPoints:t}=e.detail;this._lastImageCoords=t.image,this._drawing&&this._paint(e)}preMouseDownCallback(e){const t=e.detail,{element:n,currentPoints:o}=t;return this._startPainting(e),this._lastImageCoords=o.image,this._drawing=!0,this._startListeningForMouseUp(n),this._paint(e),!0}_startPainting(e){const t=e.detail,n=t.element,{configuration:o,getters:a}=ao,{labelmap2D:i,labelmap3D:r,currentImageIdIndex:s,activeLabelmapIndex:c}=a.labelmap2D(n),l=this._isCtrlDown(t)||this.configuration.alwaysEraseOnClick;if(this.paintEventData={labelmap2D:i,labelmap3D:r,currentImageIdIndex:s,activeLabelmapIndex:c,shouldErase:l},o.storeHistory){const e=i.pixelData.slice();this.paintEventData.previousPixelData=e}}_endPainting(e){const{configuration:t,setters:n}=ao,{labelmap2D:o,currentImageIdIndex:a}=this.paintEventData,i=new Set(o.pixelData).values(),r=[];let s=!1;for(;!s;){const e=i.next();s=e.done,s||r.push(e.value)}if(o.segmentsOnLabelmap=r,t.storeHistory){const{previousPixelData:e}=this.paintEventData,t={imageIdIndex:a,diff:pe(e,o.pixelData)};n.pushState(this.element,[t])}fe(this.element)}mouseMoveCallback(e){const{currentPoints:t}=e.detail;this._lastImageCoords=t.image}renderToolData(e){const t=e.detail.element;oo(t,this.name)&&this.renderBrush(e)}passiveCallback(e){try{c.cornerstone.updateImage(this.element)}catch(e){return}}_drawingMouseUpCallback(e){const t=e.detail.element;this._endPainting(e),this._drawing=!1,this._mouseUpRender=!0,this._stopListeningForMouseUp(t)}newImageCallback(e){this._drawing&&(this._endPainting(e),this._startPainting(e))}_startListeningForMouseUp(e){e.removeEventListener(l.MOUSE_UP,this._drawingMouseUpCallback),e.removeEventListener(l.MOUSE_CLICK,this._drawingMouseUpCallback),e.addEventListener(l.MOUSE_UP,this._drawingMouseUpCallback),e.addEventListener(l.MOUSE_CLICK,this._drawingMouseUpCallback),c.cornerstone.updateImage(e)}_stopListeningForMouseUp(e){e.removeEventListener(l.MOUSE_UP,this._drawingMouseUpCallback),e.removeEventListener(l.MOUSE_CLICK,this._drawingMouseUpCallback),c.cornerstone.updateImage(e)}increaseBrushSize(){const{configuration:e,setters:t}=ao,n=e.radius;let o=Math.floor(1.2*n);o===n&&(o+=1),t.radius(o)}decreaseBrushSize(){const{configuration:e,setters:t}=ao,n=e.radius,o=Math.floor(.8*n);t.radius(o)}_isCtrlDown(e){return e.event&&e.event.ctrlKey||e.ctrlKey}},ro=function(e){return e.filter(e=>!(e.isMultiPartTool||e instanceof Vo||e instanceof io))};function so(e,t,n="mouse"){let o;if("touch"===n?(o=no(e,tt.touchTools()),o=o.filter(e=>e.options.isTouchActive)):(o=no(e,tt.mouseTools()),o=o.filter(e=>Array.isArray(e.options.mouseButtonMask)&&t&&e.options.mouseButtonMask.includes(t)&&e.options.isMouseActive),et.isMultiPartToolActive&&(o=ro(o))),0!==o.length)return o[0]}const co=I("manipulators:moveAllHandles"),lo=ot("manipulatorState"),uo={mouse:[l.MOUSE_DRAG],touch:[l.TOUCH_DRAG]},ho={mouse:[l.MOUSE_UP,l.MOUSE_CLICK],touch:[l.TOUCH_END,l.TOUCH_DRAG_END,l.TOUCH_PINCH,l.TOUCH_PRESS,l.TAP]};var go=function({element:e},t,n,o,a={},i="mouse",r){a=Object.assign({deleteIfHandleOutsideImage:et.deleteIfHandleOutsideImage,preventHandleOutsideImage:et.preventHandleOutsideImage},a);const s=mo.bind(this,t,n,a,i),c=e=>{!function(e,t,n={},o,{dragHandler:a,upOrEndHandler:i},r,s){const c=r.detail,{element:l}=c;lo.setters.removeActiveManipulatorForElement(l),n.deleteIfHandleOutsideImage&&eo(c,t.handles)&&T(l,e,t);po(t,n,o,{dragHandler:a,upOrEndHandler:i},l,s,!0)}(t,n,a,i,{dragHandler:s,upOrEndHandler:c},e,r)};lo.setters.addActiveManipulatorForElement(e,fo.bind(null,n,a,i,{dragHandler:s,upOrEndHandler:c},e,r)),n.active=!0,et.isToolLocked=!0,uo[i].forEach(t=>{e.addEventListener(t,s)}),ho[i].forEach(t=>{e.addEventListener(t,c)})};function mo(e,t,n={},o,a){const{element:i,image:r,buttons:s}=a.detail,{x:u,y:h}=a.detail.deltaPoints.image;t.active=!0,t.invalidated=!0;const g=Object.keys(t.handles);for(let e=0;e<g.length;e++){const o=g[e],a=t.handles[o];!0!==a.movesIndependently&&a.hasOwnProperty("x")&&a.hasOwnProperty("y")&&(a.x+=u,a.y+=h,n.preventHandleOutsideImage&&rn(a,r))}c.cornerstone.updateImage(i);const m=so(i,s,o);m instanceof Vo&&m.updateCachedStats(r,i,t),d(i,l.MEASUREMENT_MODIFIED,{toolName:e,toolType:e,element:i,measurementData:t}),a.preventDefault(),a.stopPropagation()}function fo(e,t={},n,{dragHandler:o,upOrEndHandler:a},i,r){po(e,t,n,{dragHandler:o,upOrEndHandler:a},i,r,!1)}function po(e,t={},n,{dragHandler:o,upOrEndHandler:a},i,r,s=!0){e.active=!1,e.invalidated=!0,et.isToolLocked=!1,uo[n].forEach(e=>{i.removeEventListener(e,o)}),ho[n].forEach(e=>{i.removeEventListener(e,a)}),"function"==typeof t.doneMovingCallback&&(co.warn("`options.doneMovingCallback` has been depricated. See https://github.com/cornerstonejs/cornerstoneTools/pull/915 for details."),t.doneMovingCallback(s)),"function"==typeof r&&r(s),c.cornerstone.updateImage(i)}const vo=I("manipulators:moveHandle"),xo=ot("manipulatorState"),yo={value:!1},bo={mouse:[l.MOUSE_DRAG],touch:[l.TOUCH_DRAG]},To={mouse:[l.MOUSE_UP,l.MOUSE_CLICK],touch:[l.TOUCH_END,l.TOUCH_DRAG_END,l.TOUCH_PINCH,l.TOUCH_PRESS,l.TAP]};var Co=function(e,t,n,o,a={},i="mouse",r){a=Object.assign({deleteIfHandleOutsideImage:et.deleteIfHandleOutsideImage,preventHandleOutsideImage:et.preventHandleOutsideImage},a);const s=e.element,l=Mo.bind(this,t,n,o,a,i),d=()=>{!function(e,t,n,o,a={},i,{dragHandler:r,upOrEndHandler:s},c){const{element:l}=t;xo.setters.removeActiveManipulatorForElement(l),wo(e,t,n,o,a,i,{dragHandler:r,upOrEndHandler:s},c,!0)}(t,e,n,o,a,i,{dragHandler:l,upOrEndHandler:d},r)};if(xo.setters.addActiveManipulatorForElement(s,Eo.bind(null,t,e,n,o,a,i,{dragHandler:l,upOrEndHandler:d},r)),o.active=!0,o.moving=!0,n.active=!0,et.isToolLocked=!0,bo[i].forEach(e=>{s.addEventListener(e,l)}),To[i].forEach(e=>{s.addEventListener(e,d)}),"touch"===i){yo.value=!0;const t=c.cornerstone.getEnabledElement(s),n=to(e,i);!function e(t,n,o,a){if(!n.value)return;const i=Math.abs(t.y-a.y),r=i/10;if(i<1)return t.y=a.y,void(n.value=!1);t.y>a.y?t.y-=r:t.y<a.y&&(t.y+=r);c.cornerstone.updateImage(o.element),c.cornerstone.requestAnimationFrame((function(){e(t,n,o,a)}))}(o,yo,t,n)}};function Mo(e,t,n,o,a,i){const{image:r,element:s,buttons:u}=i.detail,h=to(i.detail,a);yo.value=!1,n.active=!0,n.hasMoved=!0,n.x=h.x,n.y=h.y,t.invalidated=!0,o.preventHandleOutsideImage&&rn(n,r),c.cornerstone.updateImage(s);const g=so(s,u,a);g instanceof Vo&&g.updateCachedStats(r,s,t),d(s,l.MEASUREMENT_MODIFIED,{toolName:e,toolType:e,element:s,measurementData:t})}function Eo(e,t,n,o,a={},i,{dragHandler:r,upOrEndHandler:s},c){wo(e,t,n,o,a,i,{dragHandler:r,upOrEndHandler:s},c,!1)}function wo(e,t,n,o,a={},i,{dragHandler:r,upOrEndHandler:s},l,d=!0){const u=t.element;o.active=!1,o.moving=!1,n.active=!1,n.invalidated=!0,yo.value=!1,et.isToolLocked=!1,bo[i].forEach(e=>{u.removeEventListener(e,r)}),To[i].forEach(e=>{u.removeEventListener(e,s)}),a.deleteIfHandleOutsideImage&&eo(t,n.handles)&&T(u,e,n),"function"==typeof a.doneMovingCallback&&(vo.warn("`options.doneMovingCallback` has been depricated. See https://github.com/cornerstonejs/cornerstoneTools/pull/915 for details."),a.doneMovingCallback(d)),"function"==typeof l&&l(d),c.cornerstone.updateImage(u)}const Io=I("manipulators:moveNewHandle"),So=ot("manipulatorState"),_o={mouse:[l.MOUSE_MOVE,l.MOUSE_DRAG],touch:[l.TOUCH_DRAG]},Po={mouse:[l.MOUSE_UP,l.MOUSE_CLICK],touch:[l.TOUCH_END,l.TOUCH_PINCH,l.TAP]};var Do=function(e,t,n,o,a,i="mouse",r){(a=Object.assign({deleteIfHandleOutsideImage:et.deleteIfHandleOutsideImage,preventHandleOutsideImage:et.preventHandleOutsideImage},a)).hasMoved=!1;const{element:s}=e;function u(e){!function(e,t,n,o,a,i){const{image:r,element:s,buttons:u}=i.detail,h=to(i.detail,a);o.hasMoved=!0,t.invalidated=!0,n.active=!0,n.x=h.x,n.y=h.y,o&&o.preventHandleOutsideImage&&rn(n,r);c.cornerstone.updateImage(s);const g=so(s,u,a);g instanceof Vo&&g.updateCachedStats(r,s,t);d(s,l.MEASUREMENT_MODIFIED,{toolName:e,toolType:e,element:s,measurementData:t})}(t,n,o,a,i,e)}function h(e){!function(e,t,n,o,a,{moveHandler:i,moveEndHandler:r},s,c){const l=s.detail,{element:d}=l;let u=!0;if(!1===o.hasMoved)return;const h=to(l,a);t.active=!1,t.invalidated=!0,n.active=!1,n.moving=!1,n.x=h.x,n.y=h.y,So.setters.removeActiveManipulatorForElement(d),o.preventHandleOutsideImage&&rn(n,s.detail.image);o.deleteIfHandleOutsideImage&&eo(s.detail,t.handles)&&(t.cancelled=!0,u=!1,T(d,e,t));ko(a,o,d,{moveHandler:i,moveEndHandler:r},c,u)}(t,n,o,a,i,{moveHandler:u,moveEndHandler:h},e,r)}n.active=!0,o.moving=!0,o.active=!0,et.isToolLocked=!0,_o[i].forEach(e=>{s.addEventListener(e,u)}),s.addEventListener(l.TOUCH_START,Lo),Po[i].forEach(e=>{s.addEventListener(e,h)}),So.setters.addActiveManipulatorForElement(s,Oo.bind(null,n,o,a,i,{moveHandler:u,moveEndHandler:h},s,r))};function ko(e,t,n,{moveHandler:o,moveEndHandler:a},i,r=!0){_o[e].forEach(e=>{n.removeEventListener(e,o)}),Po[e].forEach(e=>{n.removeEventListener(e,a)}),n.removeEventListener(l.TOUCH_START,Lo),et.isToolLocked=!1,"function"==typeof i&&i(r),"function"==typeof t.doneMovingCallback&&(Io.warn("`options.doneMovingCallback` has been depricated. See https://github.com/cornerstonejs/cornerstoneTools/pull/915 for details."),t.doneMovingCallback(r)),c.cornerstone.updateImage(n)}function Oo(e,t,n,o,{moveHandler:a,moveEndHandler:i},r,s){e.active=!1,e.invalidated=!0,t.active=!1,ko(o,n,r,{moveHandler:a,moveEndHandler:i},s,!1)}function Lo(e){return e.stopImmediatePropagation(),!1}function Ao(e,t){let{clickProximity:n,touchProximity:o}=et;const a=et.tools.find(({name:e})=>e===t);return a&&a.configuration&&(n=a.configuration.clickProximity||n,o=a.configuration.touchProximity||o),"mouse"===e?n:o}function Ho(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function Ro(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ho(n,!0).forEach((function(t){Qn()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ho(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Uo=function(e,t,n,o,a){n.active=!0,et.isToolLocked=!0;Co(e.detail,t.name,n,o,t.options,a,t=>{const{element:o}=e.detail,a=n.toolType||n.toolName,i={toolName:a,toolType:a,element:o,measurementData:Ro({},n,{active:!1})};d(o,l.MEASUREMENT_COMPLETED,i)}),e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()},Fo=function(e,t,n,o,a="mouse"){for(let i=0;i<t.data.length;i++){const r=t.data[i],s=Zn(e,r.handles,o,Ao(a,n));if(s)return{handle:s,data:r}}},No=function(e,t,n,o="mouse"){n.active=!0,et.isToolLocked=!0,go(e.detail,t.name,n,0,t.options,o,()=>{n.active=!1,et.isToolLocked=!1}),e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()},Bo=I("baseAnnotationTool");var Vo=class extends Yn{createNewMeasurement(e){throw new Error("Method createNewMeasurement not implemented for ".concat(this.name,"."))}pointNearTool(e,t,n,o="mouse"){throw new Error("Method pointNearTool not implemented for ".concat(this.name,"."))}distanceFromPoint(e,t,n){throw new Error("Method distanceFromPoint not implemented for ".concat(this.name,"."))}renderToolData(e){throw new Error("renderToolData not implemented for ".concat(this.name,"."))}mouseMoveCallback(e){const{element:t,currentPoints:n}=e.detail,o=n.canvas,a=b(t,this.name);let i=!1;for(let e=0;e<a.data.length;e++){const n=a.data[e];!0===$n(t,n.handles,o)&&(i=!0);const r=this.pointNearTool(t,n,o,"mouse")&&!n.active,s=!this.pointNearTool(t,n,o,"mouse")&&n.active;(r||s)&&(n.active=!n.active,i=!0)}return i}handleSelectedCallback(e,t,n,o="mouse"){Uo(e,this,t,n,o)}toolSelectedCallback(e,t,n="mouse"){No(e,this,t,n)}updateCachedStats(e,t,n){Bo.warn("updateCachedStats not implemented for ".concat(this.name,"."))}},zo=function(e,t,n,o){const a=c.cornerstone,i={start:a.pixelToCanvas(e,t),end:a.pixelToCanvas(e,n)};return c.cornerstoneMath.lineSegment.distanceToPoint(i,o)},jo=function(e,t){const n=Math.pow(10,t);return Math.round(e*n)/n};const qo=nt.cursor;class Wo{constructor(e,t){this.iconGroupString=e,this.options=Object.assign({},qo.getters.defaultOptions(),t)}getIconSVG(e={}){const t=this._generateIconSVGString(e);return new Blob([t],{type:"image/svg+xml"})}getIconSVGString(e={}){return this._generateIconSVGString(e)}getIconWithPointerSVG(e={}){const t=this._generateIconWithPointerSVGString(e);return new Blob([t],{type:"image/svg+xml"})}getIconWithPointerString(e={}){return this._generateIconWithPointerSVGString(e)}get mousePoint(){const e=this.options.mousePoint;return"".concat(e.x," ").concat(e.y)}_generateIconWithPointerSVGString(e={}){const t=Object.assign({},this.options,e),{mousePointerGroupString:n,iconSize:o,viewBox:a}=t,i=o/Math.max(a.x,a.y),r=16+o,s='\n        <svg\n        data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n        width="'.concat(r,'" height="').concat(r,'" viewBox="0 0 ').concat(r," ").concat(r,'"\n      >\n        <g>\n          ').concat(n,'\n        </g>\n        <g transform="translate(16, 16) scale(').concat(i,')">\n          ').concat(this.iconGroupString,"\n        </g>\n      </svg>");return this._injectColors(s,t)}_generateIconSVGString(e={}){const t=Object.assign({},this.options,e),{iconSize:n,viewBox:o}=t,a='\n      <svg\n        data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n        width="'.concat(n,'" height="').concat(n,'" viewBox="0 0\n        ').concat(o.x," ").concat(o.y,'"\n      >\n        ').concat(this.iconGroupString,"\n      </svg>");return this._injectColors(a,t)}_injectColors(e,t={}){const n=t.activeColor||Gt.getActiveColor(),o=t.toolColor||Gt.getToolColor(),a=t.fillColor||Gt.getFillColor();return e.replace(/ACTIVE_COLOR/g,"".concat(n)).replace(/TOOL_COLOR/g,"".concat(o)).replace(/FILL_COLOR/g,"".concat(a))}}const Go=new Wo('<path fill="ACTIVE_COLOR" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n        50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n        10l50 50q10 10 10 23z"\n      />',{viewBox:{x:1792,y:1792}}),Yo=new Wo('<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="ACTIVE_COLOR" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',{viewBox:{x:24,y:24}}),Xo=new Wo('<g fill="ACTIVE_COLOR" stroke-width="3" stroke="ACTIVE_COLOR">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',{viewBox:{x:48,y:48}}),Ko=new Wo('<g stroke="ACTIVE_COLOR" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',{viewBox:{x:32,y:32}}),Zo=new Wo('<circle stroke="ACTIVE_COLOR" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',{viewBox:{x:32,y:32}}),$o=new Wo('<path stroke="ACTIVE_COLOR" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z"\n    />',{viewBox:{x:32,y:32}}),Jo=new Wo('\n  <g fill="ACTIVE_COLOR" stroke="ACTIVE_COLOR" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',{viewBox:{x:18,y:18}}),Qo=new Wo('<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="ACTIVE_COLOR" stroke-linecap="round" stroke-linejoin="round">\n      <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n      <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n      <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n      <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n      <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n      <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n      <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n      <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n      <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n      <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n      <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n      <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n      <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n      <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n      <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n      <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n      <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n      <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n      <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n      <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n      <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n      <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n      <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n      <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n      <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n      <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n      <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n      <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n      <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n      <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n      <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n      <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n    </g>',{viewBox:{x:18,y:18}}),ea=new Wo('<g id="length-group" fill="none" stroke-width="1" stroke="ACTIVE_COLOR" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',{viewBox:{x:24,y:24}}),ta=new Wo('<path fill="ACTIVE_COLOR" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z"\n  />',{viewBox:{x:1792,y:1792}}),na=new Wo('<path fill="ACTIVE_COLOR" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z"\n  />',{viewBox:{x:1792,y:1792}}),oa=new Wo('<path fill="ACTIVE_COLOR" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z"\n  />',{viewBox:{x:1792,y:1792}}),aa=new Wo('<path fill="ACTIVE_COLOR" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z"\n  />',{viewBox:{x:1792,y:1792}}),ia=new Wo('<path transform="translate(0,1792) scale(1,-1)" fill="ACTIVE_COLOR" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n      34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n      0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n      0 69.5 20.5t47.5 54.5z"\n    />',{viewBox:{x:2048,y:1792}}),ra=new Wo('<path fill="ACTIVE_COLOR" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n      312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n      0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n      0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n      32s176 78.7 176 176-78.7 176-176 176z"\n    />',{viewBox:{x:512,y:512}}),sa=new Wo('<path fill="ACTIVE_COLOR" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n      39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n      355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n      39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n      0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n      144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n      45v448q0 42-39 59-13 5-25 5-26 0-45-19z"\n    />',{viewBox:{x:1792,y:1792}}),ca=new Wo('<path fill="ACTIVE_COLOR" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n      14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n      163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n      225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n      132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n      164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n      39 17 39 59z"\n    />',{viewBox:{x:1792,y:1792}}),la=new Wo('<path fill="ACTIVE_COLOR" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n      0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n      0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n      0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n      0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z"\n      />',{viewBox:{x:24,y:28}}),da=new Wo('<path fill="ACTIVE_COLOR" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z"\n  />',{viewBox:{x:1792,y:1792}}),ua=new Wo('<path fill="ACTIVE_COLOR" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="ACTIVE_COLOR" />',{viewBox:{x:18,y:18}}),ha=new Wo('<path fill="ACTIVE_COLOR" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n      312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n      0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n      0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n      32s176 78.7 176 176-78.7 176-176 176z"\n    />\n    <path fill="ACTIVE_COLOR" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n      320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n      19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n      0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z"\n    />',{viewBox:{x:640,y:512}}),ga={x:127,y:60},ma=(e="ACTIVE_COLOR")=>'<rect fill="'.concat(e,'" x="80.19" y="25.03" width="47.14" height="15.85"/>'),fa=(e="ACTIVE_COLOR")=>'<rect fill="'.concat(e,'" x="80.19" y="25.03" width="47.14" height="15.85"/>\n      <rect fill="').concat(e,'" x="95.84" y="9.38" width="15.85" height="47.14"/>'),pa='<path fill="ACTIVE_COLOR" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',va='<path fill="ACTIVE_COLOR" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',xa='<path fill="ACTIVE_COLOR" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',ya=new Wo("".concat(pa," ").concat(ma()),{viewBox:ga}),ba=new Wo("".concat(pa," ").concat(fa()),{viewBox:ga}),Ta=new Wo("".concat(pa," ").concat(ma()),{viewBox:ga}),Ca=new Wo("".concat(pa," ").concat(fa()),{viewBox:ga}),Ma=new Wo("".concat(va," ").concat(ma()),{viewBox:ga}),Ea=new Wo("".concat(va," ").concat(fa()),{viewBox:ga}),wa=new Wo("".concat(va," ").concat(ma()),{viewBox:ga}),Ia=new Wo("".concat(va," ").concat(fa()),{viewBox:ga}),Sa=new Wo("".concat(xa," ").concat(ma()),{viewBox:ga}),_a=new Wo("".concat(xa," ").concat(fa()),{viewBox:ga}),Pa=new Wo("".concat(xa," ").concat(ma()),{viewBox:ga}),Da=new Wo("".concat(xa," ").concat(fa()),{viewBox:ga});function ka(e){const t=c.cornerstone.metaData.get("imagePlaneModule",e.imageId);return t?{rowPixelSpacing:t.rowPixelSpacing||t.rowImagePixelSpacing,colPixelSpacing:t.columnPixelSpacing||t.colImagePixelSpacing}:{rowPixelSpacing:e.rowPixelSpacing,colPixelSpacing:e.columnPixelSpacing}}var Oa=function(e){const t=typeof e;return null!==e&&("object"===t||"function"===t)};var La=function(e,t,n){let o,a,i,r,s,c,l=0,d=!1,u=!1,h=!0;const g=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function m(t){const n=o,i=a;return o=a=void 0,l=t,r=e.apply(i,n),r}function f(e,t){return g?window.requestAnimationFrame(e):setTimeout(e,t)}function p(e){const n=e-c;return void 0===c||n>=t||n<0||u&&e-l>=i}function v(){const e=Date.now();if(p(e))return x(e);s=f(v,function(e){const n=e-l,o=t-(e-c);return u?Math.min(o,i-n):o}(e))}function x(e){return s=void 0,h&&o?m(e):(o=a=void 0,r)}function y(...e){const n=Date.now(),i=p(n);if(o=e,a=this,c=n,i){if(void 0===s)return function(e){return l=e,s=f(v,t),d?m(e):r}(c);if(u)return s=f(v,t),m(c)}return void 0===s&&(s=f(v,t)),r}return t=Number(t)||0,Oa(n)&&(d=Boolean(n.leading),u="maxWait"in n,i=u?Math.max(Number(n.maxWait)||0,t):i,h="trailing"in n?Boolean(n.trailing):h),y.cancel=function(){void 0!==s&&function(e){if(g)return window.cancelAnimationFrame(e);clearTimeout(e)}(s),l=0,o=c=a=s=void 0},y.flush=function(){return void 0===s?r:x(Date.now())},y.pending=function(){return void 0!==s},y};var Aa=function(e,t,n){let o=!0,a=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return Oa(n)&&(o="leading"in n?Boolean(n.leading):o,a="trailing"in n?Boolean(n.trailing):a),La(e,t,{leading:o,trailing:a,maxWait:t})};class Ha extends Vo{constructor(e={}){super(e,{name:"Angle",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Go,configuration:{drawHandles:!0,drawHandlesOnHover:!1,hideHandlesIfMoving:!1,renderDashed:!1}}),this.preventNewMeasurement=!1,this.throttledUpdateCachedStats=Aa(this.updateCachedStats,110)}createNewMeasurement(e){return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},middle:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}}pointNearTool(e,t,n){return!1!==t.visible&&(zo(e,t.handles.start,t.handles.middle,n)<25||zo(e,t.handles.middle,t.handles.end,n)<25)}updateCachedStats(e,t,n){const o=Ua(e,n.handles.middle,n.handles.start),a=Ua(e,n.handles.end,n.handles.middle),i=Ua(e,n.handles.end,n.handles.start),r=Ra(o),s=Ra(a),c=Ra(i);let l=Math.acos((Math.pow(r,2)+Math.pow(s,2)-Math.pow(c,2))/(2*r*s));l*=180/Math.PI,n.rAngle=jo(l,2),n.invalidated=!1}renderToolData(e){const t=e.detail,n=t.enabledElement,{handleRadius:o,drawHandlesOnHover:a,hideHandlesIfMoving:i,renderDashed:r}=this.configuration,s=b(e.currentTarget,this.name),l=ot("globalConfiguration").configuration.lineDash;if(!s)return;const d=hn(t.canvasContext.canvas),{image:u,element:h}=t,{rowPixelSpacing:g,colPixelSpacing:m}=ka(u),f=kt.getToolWidth();for(let e=0;e<s.data.length;e++){const x=s.data[e];!1!==x.visible&&_t(d,e=>{mn(e,this.configuration);const s=Gt.getColorIfActive(x),d=c.cornerstone.pixelToCanvas(t.element,x.handles.start),y=c.cornerstone.pixelToCanvas(t.element,x.handles.middle),b={color:s};r&&(b.lineDash=l),At(e,t.element,x.handles.start,[x.handles.middle,x.handles.end],b);const T={color:s,handleRadius:o,drawHandlesIfActive:a,hideHandlesIfMoving:i};if(this.configuration.drawHandles&&Yt(e,t,x.handles,T),!0===x.invalidated&&(x.rAngle?this.throttledUpdateCachedStats(u,h,x):this.updateCachedStats(u,h,x)),x.rAngle){const o=p(x,g,m),a=15;let i;if(!x.handles.textBox.hasMoved){i={x:y.x,y:y.y};const t=nn(e,o,5);y.x<d.x?i.x-=a+t+10:i.x+=a;const r=c.cornerstone.internal.getTransform(n);r.invert();const s=r.transformPoint(i.x,i.y);x.handles.textBox.x=s.x,x.handles.textBox.y=s.y}dn(e,t.element,x.handles.textBox,o,x.handles,v,s,f,0,!0)}})}function p(e,t,n){const o=t&&n?"":" (isotropic)";return e.rAngle.toString()+String.fromCharCode(parseInt("00B0",16))+o}function v(e){return[e.start,e.middle,e.end]}}addNewMeasurement(e,t){if(this.preventNewMeasurement)return;this.preventNewMeasurement=!0,e.preventDefault(),e.stopPropagation();const n=e.detail,o=this.createNewMeasurement(n),a=e.detail.element;y(a,this.name,o),c.cornerstone.updateImage(a),Do(n,this.name,o,o.handles.middle,this.options,t,e=>{if(o.active=!1,!e)return T(a,this.name,o),void(this.preventNewMeasurement=!1);o.handles.end.active=!0,c.cornerstone.updateImage(a),Do(n,this.name,o,o.handles.end,this.options,t,e=>{e?(o.active=!1,c.cornerstone.updateImage(a)):T(a,this.name,o),this.preventNewMeasurement=!1,c.cornerstone.updateImage(a);const t={toolName:this.name,toolType:this.name,element:a,measurementData:o};d(a,l.MEASUREMENT_COMPLETED,t)})})}}function Ra(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))}function Ua(e,t,n){const{rowPixelSpacing:o,colPixelSpacing:a}=ka(e);return{x:(t.x-n.x)*(a||1),y:(t.y-n.y)*(o||1)}}class Fa extends Vo{constructor(e={}){super(e,{name:"ArrowAnnotate",supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:Na,changeTextCallback:Ba,drawHandles:!0,drawHandlesOnHover:!1,hideHandlesIfMoving:!1,arrowFirst:!0,renderDashed:!1,allowEmptyLabel:!1},svgCursor:Yo}),this.preventNewMeasurement=!1}createNewMeasurement(e){return{visible:!0,active:!0,color:void 0,handles:{start:{x:e.detail.currentPoints.image.x,y:e.detail.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.detail.currentPoints.image.x,y:e.detail.currentPoints.image.y,highlight:!0,active:!1},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}}pointNearTool(e,t,n){return!1!==t.visible&&zo(e,t.handles.start,t.handles.end,n)<25}updateCachedStats(){}renderToolData(e){const{element:t,enabledElement:n}=e.detail,{handleRadius:o,drawHandlesOnHover:a,hideHandlesIfMoving:i,renderDashed:r}=this.configuration,s=b(t,this.name);if(!s)return;const l=e.detail.canvasContext.canvas,d=hn(l),u=kt.getToolWidth();let h;r&&(h=ot("globalConfiguration").configuration.lineDash);for(let r=0;r<s.data.length;r++){const l=s.data[r];!1!==l.visible&&_t(d,r=>{mn(r,this.configuration);const s=Gt.getColorIfActive(l),d=c.cornerstone.pixelToCanvas(t,l.handles.start),f=c.cornerstone.pixelToCanvas(t,l.handles.end);this.configuration.arrowFirst?Ht(r,f,d,s,u,h):Ht(r,d,f,s,u,h);const p={color:s,handleRadius:o,drawHandlesIfActive:a,hideHandlesIfMoving:i};this.configuration.drawHandles&&Yt(r,e.detail,l.handles,p);const v=g(l);if(v&&""!==v){const e=nn(r,v,5),o=Qt.getFontSize()+10;let a=Math.max(e,o)/2+5;if(f.x<d.x&&(a=-a),!l.handles.textBox.hasMoved){let t;t=this.configuration.arrowFirst?{x:f.x-e/2+a,y:f.y-o/2}:{x:d.x-e/2-a,y:d.y-o/2};const i=c.cornerstone.internal.getTransform(n);i.invert();const r=i.transformPoint(t.x,t.y);l.handles.textBox.x=r.x,l.handles.textBox.y=r.y}dn(r,t,l.handles.textBox,v,l.handles,m,s,u,0,!1)}})}function g(e){return e.text}function m(e){const t={x:(e.start.x+e.end.x)/2,y:(e.start.y+e.end.y)/2};return[e.start,t,e.end]}}addNewMeasurement(e,t){const n=e.detail.element,o=this.createNewMeasurement(e),{allowEmptyLabel:a}=this.configuration;y(n,this.name,o),c.cornerstone.updateImage(n),Do(e.detail,this.name,o,o.handles.end,this.options,t,t=>{t?void 0===o.text&&this.configuration.getTextCallback(e=>{if(e||a){o.text=e,o.active=!1;const t={toolName:this.name,toolType:this.name,element:n,measurementData:o};c.cornerstone.updateImage(n),d(n,l.MEASUREMENT_COMPLETED,t)}else T(n,this.name,o)},e.detail):T(n,this.name,o),c.cornerstone.updateImage(n)})}doubleClickCallback(e){return this._updateTextForNearbyAnnotation(e)}touchPressCallback(e){return this._updateTextForNearbyAnnotation(e)}_updateTextForNearbyAnnotation(e){const t=e.detail.element,n=e.detail.currentPoints.canvas,o=b(t,this.name);if(!o)return!1;for(let a=0;a<o.data.length;a++){const i=o.data[a];if(this.pointNearTool(t,i,n)||Xn(i.handles.textBox,n))return i.active=!0,c.cornerstone.updateImage(t),this.configuration.changeTextCallback(i,e.detail,this._doneChangingTextCallback.bind(this,t,i)),e.stopImmediatePropagation(),e.preventDefault(),e.stopPropagation(),!0}}_doneChangingTextCallback(e,t,n,o){!0===o?T(e,this.name,t):t.text=n,t.active=!1,c.cornerstone.updateImage(e),d(e,l.MEASUREMENT_MODIFIED,{toolName:this.name,toolType:this.name,element:e,measurementData:t})}}function Na(e){e(prompt("Enter your annotation:"))}function Ba(e,t,n){n(prompt("Change your annotation:"))}const Va=(e,t,n,o={})=>Object.assign({x:e,y:t,index:n,drawnIndependently:!1,allowedOutsideImage:!1,highlight:!0,active:!1},o);var za=function(e){const{x:t,y:n}=e.currentPoints.image;return{toolName:this.name,toolType:this.name,isCreating:!0,visible:!0,active:!0,invalidated:!0,handles:{start:Va(t,n,0),end:Va(t,n,1,{active:!0}),perpendicularStart:Va(t,n,2,{locked:!0}),perpendicularEnd:Va(t,n,3),textBox:Va(t-50,n-70,null,{highlight:!1,hasMoved:!0,active:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0})},longestDiameter:0,shortestDiameter:0}};var ja=function(e,t,n,o="mouse"){const a=c.cornerstone,i=c.cornerstoneMath,{handles:r}=t,s={start:a.pixelToCanvas(e,r.start),end:a.pixelToCanvas(e,r.end)},l=i.lineSegment.distanceToPoint(s,n);if(Xn(r.textBox,n))return!0;const d=Ao(o,"Bidirectional");return!!((e,t,n,o)=>{const a=c.cornerstone,i=c.cornerstoneMath,r={start:a.pixelToCanvas(e,t.perpendicularStart),end:a.pixelToCanvas(e,t.perpendicularEnd)};return i.lineSegment.distanceToPoint(r,n)<o})(e,r,n,d)||l<d};function qa(e,t,n,o){const a=(n.x-o.x)*e,i=(n.y-o.y)*t,r=Math.sqrt(a*a+i*i);return{x:a/r,y:i/r,length:r}}function Wa(e,t){if(!t.handles.perpendicularStart.locked)return!1;let n,o,a,i;const{start:r,end:s}=t.handles,{columnPixelSpacing:c=1,rowPixelSpacing:l=1}=e.image;if(r.x===s.x&&r.y===s.y)n=r.x,o=r.y,a=s.x,i=s.y;else{const e={x:(r.x+s.x)/2,y:(r.y+s.y)/2},t=qa(c,l,r,s),d=t.length/2,u=d/(2*l),h=d/(2*c);n=e.x+h*t.y,o=e.y-u*t.x,a=e.x-h*t.y,i=e.y+u*t.x}return t.handles.perpendicularStart.x=n,t.handles.perpendicularStart.y=o,t.handles.perpendicularEnd.x=a,t.handles.perpendicularEnd.y=i,!0}var Ga=function(e){const t=e.detail,{element:n,canvasContext:o,image:a}=t,{handleRadius:i,drawHandlesOnHover:r,hideHandlesIfMoving:s,renderDashed:c}=this.configuration,l=ot("globalConfiguration").configuration.lineDash,d=b(n,this.name);if(!d)return;const{rowPixelSpacing:u,colPixelSpacing:h}=ka(a);if(!u||!h)return;const g=hn(o.canvas);let m;const f=Gt.getActiveColor(),p=kt.getToolWidth();for(let e=0;e<d.data.length;e++){const o=d.data[e];!1!==o.visible&&(m=o.active?f:Gt.getToolColor(),!0===o.invalidated&&(o.longestDiameter&&o.shortestDiameter?this.throttledUpdateCachedStats(a,n,o):this.updateCachedStats(a,n,o)),_t(g,e=>{mn(e,this.configuration);const{start:a,end:d,perpendicularStart:g,perpendicularEnd:f,textBox:v}=o.handles,x={color:m},y={color:m,strokeWidth:b};c&&(x.lineDash=l,y.lineDash=l),Lt(e,n,a,d,x);const b=p;Wa(t,o),Lt(e,n,g,f,y);const T={color:m,handleRadius:i,drawHandlesIfActive:r,hideHandlesIfMoving:s};this.configuration.drawHandles&&Yt(e,t,o.handles,T);const C=Ya(o,u,h);dn(e,n,v,C,o.handles,e=>[e.start,e.end,e.perpendicularStart,e.perpendicularEnd],m,p,10,!0)}))}};const Ya=(e,t,n)=>{let o=" mm";t&&n||(o=" pixels");const a=" L ".concat(e.longestDiameter).concat(o),i=" W ".concat(e.shortestDiameter).concat(o),{labels:r}=e;return r&&Array.isArray(r)?[...r,a,i]:[a,i]};var Xa=function(e,t){const n=e.detail,{element:o,image:a,buttons:i}=n,r=this.configuration;if(Ka(a))return;const s=this.createNewMeasurement(n),u=()=>{s.active=!1,c.cornerstone.updateImage(o)};y(o,this.name,s),c.cornerstone.updateImage(o);const h=(new Date).getTime(),{end:g,perpendicularStart:m}=s.handles;Do(n,this.name,s,g,{},t,e=>{if(!e)return void T(o,this.name,s);const{handles:g,longestDiameter:f,shortestDiameter:p}=s,v=eo(n,g),x=parseFloat(f)||0,y=parseFloat(p)||0,b=x<1||y<1,C=(new Date).getTime()-h<150;v||b||C?(s.cancelled=!0,T(o,this.name,s)):r.getMeasurementLocationCallback(s,n,u),Wa(n,s),m.locked=!1,s.invalidated=!0,c.cornerstone.updateImage(o);const M=so(o,i,t);M instanceof wi&&M.updateCachedStats(a,o,s);const E={toolName:this.name,toolType:this.name,element:o,measurementData:s};d(o,l.MEASUREMENT_MODIFIED,E),d(o,l.MEASUREMENT_COMPLETED,E)})};const Ka=e=>{const t=c.cornerstone.metaData.get("imagePlaneModule",e.imageId);let n=e.rowPixelSpacing,o=e.columnPixelSpacing;return t&&(n=t.rowPixelSpacing||t.rowImagePixelSpacing,o=t.columnPixelSpacing||t.colImagePixelSpacing),!n||!o};let Za;var $a={setCoords:function(e){Za=e.currentPoints.canvas},getCoords:function(){return Za}};const Ja=(e,t,n,o=6)=>{const a=Zn(e,t,n,o);let i=!1;return Object.keys(t).forEach(e=>{if("textBox"===e)return;const n=t[e],o=n===a;n.active!==o&&(i=!0),n.active=o}),i};var Qa=function(e){const t=e.detail,{element:n}=t;$a.setCoords(t);const o=b(n,this.name);if(!o)return;let a=!1;for(let e=0;e<o.data.length;e++){const i=t.currentPoints.canvas,r=o.data[e],s=Ja(n,r.handles,i);Object.keys(r.handles).forEach(e=>{if("textBox"===e)return;const t=r.handles[e];t.hover=t.active}),s&&(a=!0);const c=this.pointNearTool(n,r,i,"mouse"),l=c&&!r.active,d=!c&&r.active;(l||d)&&(r.active=!r.active,a=!0)}!0===a&&c.cornerstone.updateImage(n)},ei=function(e,t,n,o="mouse"){"touch"===o?this.handleSelectedTouchCallback(e):this.handleSelectedMouseCallback(e)};function ti(e,t,n,o){const a=(n.x-o.x)/t,i=(n.y-o.y)/e;return Math.sqrt(a*a+i*i)}function ni(e,t){return{start:e,end:t}}function oi(e,t,n){const{lineSegment:o}=c.cornerstoneMath,{start:a,end:i,perpendicularStart:r,perpendicularEnd:s}=e.handles,{columnPixelSpacing:l=1,rowPixelSpacing:d=1}=t.image,u=ni(a,i),h=ni(r,s),g=o.intersectLine(u,h);return{columnPixelSpacing:l,rowPixelSpacing:d,start:a,end:i,perpendicularStart:r,perpendicularEnd:s,longLine:u,intersection:g,distanceToFixed:ti(l,d,n,g),fixedPoint:n}}function ai(e,t,n,o){const a=oi(t,n,o),{columnPixelSpacing:i,rowPixelSpacing:r,distanceToFixed:s}=a,c=ti(i,r,o,e);if(c<=s)return!1;const l=s/c,d=function(e,t){const{columnPixelSpacing:n,rowPixelSpacing:o,start:a,perpendicularStart:i,perpendicularEnd:r,intersection:s,fixedPoint:c}=e,l=ti(n,o,i,s),d=ti(n,o,r,s),u=qa(n,o,c,t),h=c===a?1:-1,g=h*o,m=h*n;return{start:{x:t.x+u.y*l*g,y:t.y+u.x*l*m*-1},end:{x:t.x+u.y*d*g*-1,y:t.y+u.x*d*m}}}(a,{x:o.x+(e.x-o.x)*l,y:o.y+(e.y-o.y)*l});return t.handles.perpendicularStart.x=d.start.x,t.handles.perpendicularStart.y=d.start.y,t.handles.perpendicularEnd.x=d.end.x,t.handles.perpendicularEnd.y=d.end.y,!0}function ii(e,t){return e===t}function ri(e,t){return ii(e,t)?-1:1}function si(e,t,n,o){const{columnPixelSpacing:a,rowPixelSpacing:i,fixedPoint:r,perpendicularStart:s,perpendicularEnd:c,distanceToFixed:l}=e,d=ri(r,c)*l,u=function(e,t,n){return ii(e,n)?t:n}(r,s,c)===s,h=u?"end":"start";return{[u?"start":"end"]:{x:n.start.x,y:n.start.y},[h]:{x:t.x+o.y*i*d,y:t.y+o.x*a*d*-1}}}function ci(e,t,n,o){const{lineSegment:a}=c.cornerstoneMath,i=oi(t,n,o),{columnPixelSpacing:r,rowPixelSpacing:s,start:l,longLine:d,intersection:u}=i;if(!function(e,t,n){return 0!==ti(e,t,n.start,n.end)}(r,s,d))return!1;const h=qa(r,s,l,u),g=function(e,t,n){const{columnPixelSpacing:o,rowPixelSpacing:a,perpendicularEnd:i,fixedPoint:r}=e,s=Number.MAX_SAFE_INTEGER,c=ri(r,i)*s;return{start:t,end:{x:t.x+n.y*a*c,y:t.y+n.x*o*c*-1}}}(i,e,h),m=a.intersectLine(d,g);if(!m)return!1;const f=si(i,m,g,h);return t.handles.perpendicularStart.x=f.start.x,t.handles.perpendicularStart.y=f.start.y,t.handles.perpendicularEnd.x=f.end.x,t.handles.perpendicularEnd.y=f.end.y,!0}var li=function(e,t,n,o){let a,i,r,s,l,d;const u={},h={},g={x:t.currentPoints.image.x+o.x,y:t.currentPoints.image.y+o.y};0===e.index?(r=ai(g,n,t,n.handles.end),r?(e.x=g.x,e.y=g.y):(t.currentPoints.image.x=e.x,t.currentPoints.image.y=e.y)):1===e.index?(r=ai(g,n,t,n.handles.start),r?(e.x=g.x,e.y=g.y):(t.currentPoints.image.x=e.x,t.currentPoints.image.y=e.y)):2===e.index?(i=!1,u.start={x:n.handles.start.x,y:n.handles.start.y},u.end={x:n.handles.end.x,y:n.handles.end.y},h.start={x:n.handles.perpendicularEnd.x,y:n.handles.perpendicularEnd.y},h.end={x:g.x,y:g.y},s=c.cornerstoneMath.lineSegment.intersectLine(u,h),s||(h.end={x:n.handles.perpendicularStart.x,y:n.handles.perpendicularStart.y},s=c.cornerstoneMath.lineSegment.intersectLine(u,h),l=c.cornerstoneMath.point.distance(s,n.handles.start),d=c.cornerstoneMath.point.distance(s,n.handles.end),(!s||l<3||d<3)&&(i=!0)),a=!1,i||(a=ci(g,n,t,n.handles.perpendicularEnd),a||(t.currentPoints.image.x=n.handles.perpendicularStart.x,t.currentPoints.image.y=n.handles.perpendicularStart.y))):3===e.index&&(i=!1,u.start={x:n.handles.start.x,y:n.handles.start.y},u.end={x:n.handles.end.x,y:n.handles.end.y},h.start={x:n.handles.perpendicularStart.x,y:n.handles.perpendicularStart.y},h.end={x:g.x,y:g.y},s=c.cornerstoneMath.lineSegment.intersectLine(u,h),s||(h.end={x:n.handles.perpendicularEnd.x,y:n.handles.perpendicularEnd.y},s=c.cornerstoneMath.lineSegment.intersectLine(u,h),l=c.cornerstoneMath.point.distance(s,n.handles.start),d=c.cornerstoneMath.point.distance(s,n.handles.end),(!s||l<3||d<3)&&(i=!0)),a=!1,i||(a=ci(g,n,t,n.handles.perpendicularStart),a||(t.currentPoints.image.x=n.handles.perpendicularEnd.x,t.currentPoints.image.y=n.handles.perpendicularEnd.y)))},di=function(e,t,n,o,a,i){const{element:r,image:s,buttons:d}=e,u={x:o.x-e.currentPoints.image.x,y:o.y-e.currentPoints.image.y},h=e=>{const a=e.detail;o.hasMoved=!0,void 0===o.index||null===o.index?(o.x=a.currentPoints.image.x+u.x,o.y=a.currentPoints.image.y+u.y):li(o,a,n,u),i&&(o.x=Math.max(o.x,0),o.x=Math.min(o.x,a.image.width),o.y=Math.max(o.y,0),o.y=Math.min(o.y,a.image.height)),n.invalidated=!0,c.cornerstone.updateImage(r);const h=so(r,d,"mouse");h instanceof Vo&&h.updateCachedStats(s,r,n);const g={toolName:t,toolType:t,element:r,measurementData:n};c.cornerstone.triggerEvent(r,l.MEASUREMENT_MODIFIED,g)};o.active=!0,o.moving=!0,et.isToolLocked=!0,r.addEventListener(l.MOUSE_DRAG,h),r.addEventListener(l.TOUCH_DRAG,h);const g=c.cornerstone.getImage(r),m=()=>{c.cornerstone.getImage(r).imageId!==g.imageId&&f()};r.addEventListener(c.cornerstone.EVENTS.IMAGE_RENDERED,m);const f=()=>{o.active=!1,et.isToolLocked=!1,r.removeEventListener(c.cornerstone.EVENTS.IMAGE_RENDERED,m),r.removeEventListener(l.MOUSE_DRAG,h),r.removeEventListener(l.MOUSE_UP,f),r.removeEventListener(l.MOUSE_CLICK,f),r.removeEventListener(l.TOUCH_DRAG,h),r.removeEventListener(l.TOUCH_DRAG_END,f),r.removeEventListener(l.TAP,f),c.cornerstone.updateImage(r),"function"==typeof a&&a()};r.addEventListener(l.MOUSE_UP,f),r.addEventListener(l.MOUSE_CLICK,f),r.addEventListener(l.TOUCH_DRAG_END,f),r.addEventListener(l.TAP,f)};const ui=(e,t,n)=>{const o=e[n],a=t[n];e[n]=a,t[n]=o},hi=(e,t)=>{ui(e,t,"x"),ui(e,t,"y"),ui(e,t,"moving"),ui(e,t,"hover"),ui(e,t,"active"),ui(e,t,"selected")};function gi(e,t,n){const{rowPixelSpacing:o,columnPixelSpacing:a}=e.image,{handles:i}=t,{start:r,end:s,perpendicularStart:c,perpendicularEnd:l}=i,d=(r.x-s.x)*(a||1),u=(r.y-s.y)*(o||1),h=Math.sqrt(d*d+u*u),g=(c.x-l.x)*(a||1),m=(c.y-l.y)*(o||1);return(Math.sqrt(g*g+m*m)||0)>h?(hi(r,s),hi(r,c),hi(s,l),Object.values(i).find(e=>!0===e.moving)):n}var mi=function(e){const t=e.detail,{element:n}=t;let o;const a=Ao("mouse",this.name),i=e=>{o.invalidated=!0,eo(t,o.handles)&&T(n,this.name,o),e&&(e.moving=!1,e.selected=!0),st(this.element,this.svgCursor),c.cornerstone.updateImage(n),n.addEventListener(l.MOUSE_MOVE,this._moveCallback),n.addEventListener(l.TOUCH_START,this._moveCallback)},r=t.startPoints.canvas,s=b(e.currentTarget,this.name);if(!s)return;for(let c=0;c<s.data.length;c++){o=s.data[c];const d=[n,o.handles,r,a];let u=Zn(...d);if(u)return n.removeEventListener(l.MOUSE_MOVE,this._moveCallback),n.removeEventListener(l.TOUCH_START,this._moveCallback),o.active=!0,fi(o.handles),u.moving=!0,u=gi(t,o,u),u.hasBoundingBox||ct(this.element),di(t,this.name,o,u,()=>i(u)),vi(e),!0}const d=e=>()=>{pi(e,!1),i()};for(let a=0;a<s.data.length;a++)if(o=s.data[a],this.pointNearTool(n,o,r,"mouse")){n.removeEventListener(l.MOUSE_MOVE,this._moveCallback),n.removeEventListener(l.TOUCH_START,this._moveCallback),o.active=!0,fi(o.handles),pi(o.handles,!0);const a=d(o.handles);return go(t,this.name,o,0,{deleteIfHandleOutsideImage:!0,preventHandleOutsideImage:!1},"mouse",a),vi(e),!0}};const fi=e=>{let t=!1;return Object.keys(e).forEach(n=>{"textBox"!==n&&(e[n].selected=!1,t=e[n].active||t,e[n].active=!1)}),t},pi=(e,t)=>{Object.keys(e).forEach(n=>{"textBox"!==n&&(e[n].moving=t)})},vi=e=>{e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()},xi=[l.TOUCH_END,l.TOUCH_DRAG_END,l.TOUCH_PINCH,l.TOUCH_PRESS,l.TAP];var yi=function(e,t,n,o,a,i){const{element:r,image:s,buttons:d}=e,u={x:o.x-e.currentPoints.image.x,y:o.y-e.currentPoints.image.y},h=e=>{const a=e.detail;o.hasMoved=!0,void 0===o.index||null===o.index?(o.x=a.currentPoints.image.x+u.x,o.y=a.currentPoints.image.y+u.y):li(o,a,n,u),i&&(o.x=Math.max(o.x,0),o.x=Math.min(o.x,a.image.width),o.y=Math.max(o.y,0),o.y=Math.min(o.y,a.image.height)),n.invalidated=!0,c.cornerstone.updateImage(r);const h=so(r,d,"touch");h instanceof Vo&&h.updateCachedStats(s,r,n);const g={toolName:t,toolType:t,element:r,measurementData:n};c.cornerstone.triggerEvent(r,l.MEASUREMENT_MODIFIED,g)};o.active=!0,et.isToolLocked=!0,r.addEventListener(l.TOUCH_DRAG,h);const g=()=>{o.active=!1,et.isToolLocked=!1,r.removeEventListener(l.TOUCH_DRAG,h),xi.forEach(e=>{r.removeEventListener(e,g)}),c.cornerstone.updateImage(r),"function"==typeof a&&a()};xi.forEach(e=>{r.addEventListener(e,g)})},bi=function(e){const t=e.detail,{element:n}=t;let o;const a=et.touchProximity,i=e=>{o.invalidated=!0,eo(t,o.handles)&&T(n,this.name,o),e&&(e.moving=!1,e.selected=!0),c.cornerstone.updateImage(n),n.addEventListener(l.TOUCH_DRAG,this._moveCallback)},r=t.startPoints.canvas,s=b(e.currentTarget,this.name);if(!s)return;for(let c=0;c<s.data.length;c++){o=s.data[c];const d=[n,o.handles,r,a],u=Zn(...d);if(u)return n.removeEventListener(l.TOUCH_DRAG,this._moveCallback),o.active=!0,Ti(o.handles),u.moving=!0,yi(t,this.name,o,u,()=>i(u)),Mi(e),!0}const d=e=>()=>{Ci(e,!1),i()};for(let a=0;a<s.data.length;a++)if(o=s.data[a],this.pointNearTool(n,o,r,"touch")){n.removeEventListener(l.TOUCH_DRAG,this._moveCallback),o.active=!0,Ti(o.handles),Ci(o.handles,!0);const a=d(o.handles);return go(t,this.name,o,0,{deleteIfHandleOutsideImage:!0,preventHandleOutsideImage:!1},"touch",a),Mi(e),!0}};const Ti=e=>{let t=!1;return Object.keys(e).forEach(n=>{"textBox"!==n&&(e[n].selected=!1,t=e[n].active||t,e[n].active=!1)}),t},Ci=(e,t)=>{Object.keys(e).forEach(n=>{"textBox"!==n&&(e[n].moving=t)})},Mi=e=>{e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()};const Ei=(e,t,n)=>n();class wi extends Vo{constructor(e){super(e,{name:"Bidirectional",supportedInteractionTypes:["Mouse","Touch"],configuration:{changeMeasurementLocationCallback:Ei,getMeasurementLocationCallback:Ei,textBox:"",shadow:"",drawHandles:!0,drawHandlesOnHover:!0,hideHandlesIfMoving:!1,renderDashed:!1,additionalData:[]},svgCursor:Xo}),this.throttledUpdateCachedStats=Aa(this.updateCachedStats,110),this.createNewMeasurement=za.bind(this),this.pointNearTool=ja.bind(this),this.renderToolData=Ga.bind(this),this.addNewMeasurement=Xa.bind(this),this._moveCallback=Qa.bind(this),this.handleSelectedCallback=ei.bind(this),this.handleSelectedMouseCallback=mi.bind(this),this.handleSelectedTouchCallback=bi.bind(this)}updateCachedStats(e,t,n){if(n.toolName!==this.name)return;const o=ka(e),{longestDiameter:a,shortestDiameter:i}=function(e,t){const{rowPixelSpacing:n,colPixelSpacing:o}=t,{start:a,end:i,perpendicularStart:r,perpendicularEnd:s}=e.handles,c=(a.x-i.x)*(o||1),l=(a.y-i.y)*(n||1);let d=Math.sqrt(c*c+l*l);const u=(r.x-s.x)*(o||1),h=(r.y-s.y)*(n||1);let g=Math.sqrt(u*u+h*h);if(g||(g=0),g>d){const e=d;d=g,g=e}return{longestDiameter:d.toFixed(1),shortestDiameter:g.toFixed(1)}}(n,o);n.longestDiameter=a,n.shortestDiameter=i,n.invalidated=!1}}var Ii=function(e,t,n=!1){const o=c.cornerstone,a=o.metaData.get("patientStudyModule",e.imageId),i=o.metaData.get("generalSeriesModule",e.imageId);if(!a||!i)return;if("PT"!==i.modality)return;const r=n?t:t*e.slope+e.intercept,s=a.patientWeight;if(!s)return;const l=o.metaData.get("petIsotopeModule",e.imageId);if(!l)return;const d=l.radiopharmaceuticalInfo,u=d.radiopharmaceuticalStartTime,h=d.radionuclideTotalDose,g=d.radionuclideHalfLife,m=i.seriesTime;if(!(u&&h&&g&&m))return;const f=Si(m.fractionalSeconds||0)+m.seconds+60*m.minutes+60*m.hours*60-(Si(u.fractionalSeconds||0)+u.seconds+60*u.minutes+60*u.hours*60);return r*s/(h*Math.exp(-f*Math.log(2)/g))*1e3};function Si(e){return parseFloat(".".concat(e))}var _i=function(e,t){const n=e.width/2,o=e.height/2;if(n<=0||o<=0)return!1;const a=e.left+n,i=e.top+o,r=t.x-a,s=t.y-i;return r*r/(n*n)+s*s/(o*o)<=1},Pi=function(e,t){let n=0,o=0,a=0,i=0,r=null,s=null;for(let c=t.top;c<t.top+t.height;c++)for(let l=t.left;l<t.left+t.width;l++){_i(t,{x:l,y:c})&&(null===r&&(r=e[i],s=e[i]),n+=e[i],o+=e[i]*e[i],r=Math.min(r,e[i]),s=Math.max(s,e[i]),a++),i++}if(0===a)return{count:a,mean:0,variance:0,stdDev:0,min:0,max:0};const c=n/a,l=o/a-c*c;return{count:a,mean:c,variance:l,stdDev:Math.sqrt(l),min:r,max:s}},Di={calculateEllipseStatistics:Pi,pointInEllipse:_i};function ki(e,t){const n=function(e){const t=[e.start,e.end].sort((function(e,t){return e.x<t.x?-1:1})),n=[e.start,e.end].sort((function(e,t){return e.y<t.y?-1:1})),o=t[0],a=t[t.length-1],i=n[0],r=n[n.length-1];return{top:i,left:o,bottom:r,right:a}}(t),o=(n.left.x+n.right.x)/2,a=(n.top.y+n.bottom.y)/2,i={};return e.rotation>=0&&e.rotation<90&&(i.x=e.hflip?n.left.x:n.right.x,i.y=a),e.rotation>=90&&e.rotation<180&&(i.x=o,i.y=e.vflip?n.bottom.y:n.top.y),e.rotation>=180&&e.rotation<270&&(i.x=e.hflip?n.right.x:n.left.x,i.y=a),e.rotation>=270&&e.rotation<360&&(i.x=o,i.y=e.vflip?n.top.y:n.bottom.y),i}var Oi=function(e){const t=e.toString().split(".");return t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),t.join(".")};const Li=I("tools:annotation:CircleRoiTool");class Ai extends Vo{constructor(e={}){super(e,{name:"CircleRoi",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Zo,configuration:{renderDashed:!1,hideHandlesIfMoving:!1}}),this.throttledUpdateCachedStats=Aa(this.updateCachedStats,110)}createNewMeasurement(e){if(e&&e.currentPoints&&e.currentPoints.image)return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},initialRotation:e.viewport.rotation,textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};Li.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}pointNearTool(e,t,n,o){const a=t&&t.handles&&t.handles.start&&t.handles.end,i=c.cornerstoneMath.point.distance;if(a||Li.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!a||!1===t.visible)return!1;const r="mouse"===o?15:25,s=c.cornerstone.pixelToCanvas(e,t.handles.start),l=c.cornerstone.pixelToCanvas(e,t.handles.end),d=i(s,n),u=i(s,l);return d>u-r/2&&d<u+r/2}updateCachedStats(e,t,n){const o=(c.cornerstone.metaData.get("generalSeriesModule",e.imageId)||{}).modality,a=ka(e),i=function(e,t,n,o,a){const i=te(n.start,n.end),r=c.cornerstone.getPixels(t,i.left,i.top,i.width,i.height),s=Pi(r,i);let l;"PT"===o&&(l={mean:Ii(e,s.mean,!0)||0,stdDev:Ii(e,s.stdDev,!0)||0});return{area:Math.PI*(i.width*(a.colPixelSpacing||1)/2)*(i.height*(a.rowPixelSpacing||1)/2)||0,count:s.count||0,mean:s.mean||0,variance:s.variance||0,stdDev:s.stdDev||0,min:s.min||0,max:s.max||0,meanStdDevSUV:l}}(e,t,n.handles,o,a);n.cachedStats=i,n.invalidated=!1}renderToolData(e){const t=b(e.currentTarget,this.name);if(!t)return;const n=c.cornerstoneMath.point.distance,o=e.detail,{image:a,element:i,canvasContext:r}=o,s=kt.getToolWidth(),{handleRadius:l,drawHandlesOnHover:d,hideHandlesIfMoving:u,renderDashed:h}=this.configuration,g=hn(r.canvas),{rowPixelSpacing:m,colPixelSpacing:f}=ka(a),p=ot("globalConfiguration").configuration.lineDash,v=(c.cornerstone.metaData.get("generalSeriesModule",a.imageId)||{}).modality,x=m&&f;_t(g,e=>{for(let r=0;r<t.data.length;r++){const g=t.data[r];if(!1===g.visible)continue;const m=Gt.getColorIfActive(g),f={color:m,handleRadius:l,drawHandlesIfActive:d,hideHandlesIfMoving:u};mn(e,this.configuration);const y=c.cornerstone.pixelToCanvas(i,g.handles.start),b=c.cornerstone.pixelToCanvas(i,g.handles.end),T=n(y,b),C={color:m};if(h&&(C.lineDash=p),Rt(e,i,g.handles.start,T,C,"pixel"),Yt(e,o,g.handles,f),!0===g.invalidated&&(g.cachedStats?this.throttledUpdateCachedStats(a,i,g):this.updateCachedStats(a,i,g)),!g.handles.textBox.hasMoved){const e=ki(o.viewport,g.handles);Object.assign(g.handles.textBox,e)}const M=e=>Hi(e.start,e.end),E=Ui(e,a.color,g.cachedStats,v,x,this.configuration);g.unit=Ri(v,this.configuration.showHounsfieldUnits),dn(e,i,g.handles.textBox,E,g.handles,M,m,s,10,!0)}})}}function Hi(e,t){const{left:n,top:o,width:a,height:i}=te(e,t);return[{x:n+a/2,y:o},{x:n,y:o+i/2},{x:n+a/2,y:o+i},{x:n+a,y:o+i/2}]}function Ri(e,t){return"CT"===e&&!1!==t?"HU":""}function Ui(e,t,{area:n,mean:o,stdDev:a,min:i,max:r,meanStdDevSUV:s}={},c,l,d={}){const u=d.showMinMax||!1,h=[],g=[];if(!t){const t=s&&0!==s.mean,n=Ri(c,d.showHounsfieldUnits);let l="Mean: ".concat(Oi(o.toFixed(2))," ").concat(n);const h="Std Dev: ".concat(Oi(a.toFixed(2))," ").concat(n);if(t){const t=" SUV: ",n="".concat(t).concat(Oi(s.mean.toFixed(2))),o="".concat(t).concat(Oi(s.stdDev.toFixed(2))),a=Math.floor(e.measureText("".concat(h,"     ")).width);for(;e.measureText(l).width<a;)l+=" ";g.push("".concat(l).concat(n)),g.push("".concat(h,"     ").concat(o))}else g.push("".concat(l,"     ").concat(h));if(u){let o="Min: ".concat(i," ").concat(n);const a="Max: ".concat(r," ").concat(n),s=t?Math.floor(e.measureText("".concat(h,"     ")).width):Math.floor(e.measureText("".concat(l,"     ")).width);for(;e.measureText(o).width<s;)o+=" ";g.push("".concat(o).concat(a))}}return h.push(function(e,t){const n=t?" mm".concat(String.fromCharCode(178)):" px".concat(String.fromCharCode(178));return"Area: ".concat(Oi(e.toFixed(2))).concat(n)}(n,l)),g.forEach(e=>h.push(e)),h}class Fi extends Vo{constructor(e={}){super(e,{name:"CobbAngle",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Ko,configuration:{drawHandles:!0,drawHandlesOnHover:!1,hideHandlesIfMoving:!1,renderDashed:!1}}),this.hasIncomplete=!1,this.throttledUpdateCachedStats=Aa(this.updateCachedStats,110)}createNewMeasurement(e){return this.hasIncomplete=!0,{visible:!0,active:!0,color:void 0,invalidated:!0,complete:!1,value:"",handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},start2:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1,drawnIndependently:!0},end2:{x:e.currentPoints.image.x+1,y:e.currentPoints.image.y,highlight:!0,active:!1,drawnIndependently:!0},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}}pointNearTool(e,t,n){if(!1===t.visible)return!1;if(this.hasIncomplete)return!1;const o=zo(e,t.handles.start,t.handles.end,n)<25,a=zo(e,t.handles.start2,t.handles.end2,n)<25;return o||a}updateCachedStats(e,t,n){const{rowPixelSpacing:o,colPixelSpacing:a}=ka(e),i=(Math.ceil(n.handles.start.x)-Math.ceil(n.handles.end.x))*(a||1),r=(Math.ceil(n.handles.start.y)-Math.ceil(n.handles.end.y))*(o||1),s=(Math.ceil(n.handles.start2.x)-Math.ceil(n.handles.end2.x))*(a||1),c=(Math.ceil(n.handles.start2.y)-Math.ceil(n.handles.end2.y))*(o||1);let l=Math.acos(Math.abs((i*s+r*c)/(Math.sqrt(i*i+r*r)*Math.sqrt(s*s+c*c))));l*=180/Math.PI,n.rAngle=jo(l,2),n.invalidated=!1}renderToolData(e){const t=e.detail,{handleRadius:n,drawHandlesOnHover:o,hideHandlesIfMoving:a,renderDashed:i}=this.configuration,r=b(e.currentTarget,this.name);if(!r)return;const s=hn(t.canvasContext.canvas),l=kt.getToolWidth(),d=ot("globalConfiguration").configuration.lineDash,u=Qt.getFont(),{element:h}=e.detail,g=c.cornerstone.getEnabledElement(h).image,{rowPixelSpacing:m,colPixelSpacing:f}=ka(g);for(let e=0;e<r.data.length;e++){const c=r.data[e];!1!==c.visible&&(c.value||(c.value=this.textBoxText(c,m,f)),_t(s,e=>{mn(e,this.configuration);const r=Gt.getColorIfActive(c),s={color:r};i&&(s.lineDash=d),Lt(e,t.element,c.handles.start,c.handles.end,s),c.complete&&Lt(e,t.element,c.handles.start2,c.handles.end2,s);const h={color:r,handleRadius:n,drawHandlesIfActive:o,hideHandlesIfMoving:a};this.configuration.drawHandles&&Yt(e,t,c.handles,h),e.fillStyle=r;const g=c.value;if(!c.handles.textBox.hasMoved){const t={x:(c.handles.start.x+c.handles.end.x)/2,y:(c.handles.start.y+c.handles.end.y)/2-10};e.font=u,c.handles.textBox.x=t.x,c.handles.textBox.y=t.y}dn(e,t.element,c.handles.textBox,g,c.handles,p,r,l,0,!0)}))}function p(e){return[e.start,e.start2,e.end,e.end2]}}getIncomplete(e){const t=b(e,this.name);if(t&&Array.isArray(t.data))return t.data.find(({complete:e})=>!1===e)}addNewMeasurement(e,t){e.preventDefault(),e.stopPropagation();const n=e.detail;let o,a,i=e=>{if(!e)return void T(r,this.name,o);const t=l.MEASUREMENT_COMPLETED,n={toolName:this.name,toolType:this.name,element:r,measurementData:o};d(r,t,n)};const r=e.detail.element,s=this.getIncomplete(r);s?(o=s,o.complete=!0,o.handles.start2={x:n.currentPoints.image.x,y:n.currentPoints.image.y,drawnIndependently:!1,highlight:!0,active:!1},o.handles.end2={x:n.currentPoints.image.x,y:n.currentPoints.image.y,drawnIndependently:!1,highlight:!0,active:!0},a=o.handles.end2,this.hasIncomplete=!1,i=e=>{if(!e)return void T(r,this.name,o);const t=l.MEASUREMENT_COMPLETED,n={toolName:this.name,toolType:this.name,element:r,measurementData:o};d(r,t,n)}):(o=this.createNewMeasurement(n),y(r,this.name,o),a=o.handles.end),c.cornerstone.updateImage(r),Do(n,this.name,o,a,this.options,t,i)}onMeasureModified(e){const{element:t}=e.detail,n=c.cornerstone.getEnabledElement(t).image,{rowPixelSpacing:o,colPixelSpacing:a}=ka(n);if(e.detail.toolName!==this.name)return;const i=e.detail.measurementData;!0===i.invalidated&&(i.rAngle?this.throttledUpdateCachedStats(n,t,i):this.updateCachedStats(n,t,i)),i.value=this.textBoxText(i,o,a)}textBoxText({rAngle:e},t,n){if(void 0===e)return"";if(Number.isNaN(e))return"";const o=t&&n?"":" (isotropic)";return"".concat(e,"°").concat(o)}activeCallback(e){this.onMeasureModified=this.onMeasureModified.bind(this),e.addEventListener(l.MEASUREMENT_MODIFIED,this.onMeasureModified)}passiveCallback(e){this.onMeasureModified=this.onMeasureModified.bind(this),e.addEventListener(l.MEASUREMENT_MODIFIED,this.onMeasureModified)}enabledCallback(e){e.removeEventListener(l.MEASUREMENT_MODIFIED,this.onMeasureModified)}disabledCallback(e){e.removeEventListener(l.MEASUREMENT_MODIFIED,this.onMeasureModified)}}const Ni=I("tools:annotation:EllipticalRoiTool");class Bi extends Vo{constructor(e={}){super(e,{name:"EllipticalRoi",supportedInteractionTypes:["Mouse","Touch"],configuration:{drawHandlesOnHover:!1,hideHandlesIfMoving:!1,renderDashed:!1},svgCursor:$o}),this.throttledUpdateCachedStats=Aa(this.updateCachedStats,110)}createNewMeasurement(e){if(e&&e.currentPoints&&e.currentPoints.image)return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},initialRotation:e.viewport.rotation,textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};Ni.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}pointNearTool(e,t,n,o){const a=t&&t.handles&&t.handles.start&&t.handles.end;if(a||Ni.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!a||!1===t.visible)return!1;if(Zn(e,t.handles,n,6))return!0;const i="mouse"===o?15:25,r=c.cornerstone.pixelToCanvas(e,t.handles.start),s=c.cornerstone.pixelToCanvas(e,t.handles.end),l={left:Math.min(r.x,s.x)+i/2,top:Math.min(r.y,s.y)+i/2,width:Math.abs(r.x-s.x)-i,height:Math.abs(r.y-s.y)-i},d={left:Math.min(r.x,s.x)-i/2,top:Math.min(r.y,s.y)-i/2,width:Math.abs(r.x-s.x)+i,height:Math.abs(r.y-s.y)+i},u=_i(l,n);return!(!_i(d,n)||u)}updateCachedStats(e,t,n){const o=(c.cornerstone.metaData.get("generalSeriesModule",e.imageId)||{}).modality,a=ka(e),i=function(e,t,n,o,a){const i=qi(n.start,n.end),r=c.cornerstone.getPixels(t,i.left,i.top,i.width,i.height),s=Pi(r,i);let l;"PT"===o&&(l={mean:Ii(e,s.mean,!0)||0,stdDev:Ii(e,s.stdDev,!0)||0});return{area:Math.PI*(i.width*(a.colPixelSpacing||1)/2)*(i.height*(a.rowPixelSpacing||1)/2)||0,count:s.count||0,mean:s.mean||0,variance:s.variance||0,stdDev:s.stdDev||0,min:s.min||0,max:s.max||0,meanStdDevSUV:l}}(e,t,n.handles,o,a);n.cachedStats=i,n.invalidated=!1}renderToolData(e){const t=b(e.currentTarget,this.name);if(!t)return;const n=e.detail,{image:o,element:a}=n,i=kt.getToolWidth(),r=ot("globalConfiguration").configuration.lineDash,{handleRadius:s,drawHandlesOnHover:l,hideHandlesIfMoving:d,renderDashed:u}=this.configuration,h=hn(n.canvasContext.canvas),{rowPixelSpacing:g,colPixelSpacing:m}=ka(o),f=(c.cornerstone.metaData.get("generalSeriesModule",o.imageId)||{}).modality,p=g&&m;_t(h,e=>{for(let c=0;c<t.data.length;c++){const h=t.data[c];if(!1===h.visible)continue;const g=Gt.getColorIfActive(h),m={color:g,handleRadius:s,drawHandlesIfActive:l,hideHandlesIfMoving:d};mn(e,this.configuration);const v={color:g};if(u&&(v.lineDash=r),zt(e,a,h.handles.start,h.handles.end,v,"pixel",h.handles.initialRotation),Yt(e,n,h.handles,m),!0===h.invalidated&&(h.cachedStats?this.throttledUpdateCachedStats(o,a,h):this.updateCachedStats(o,a,h)),!h.handles.textBox.hasMoved){const e=ki(n.viewport,h.handles);Object.assign(h.handles.textBox,e)}const x=e=>Vi(e.start,e.end),y=ji(e,o.color,h.cachedStats,f,p,this.configuration);h.unit=zi(f,this.configuration.showHounsfieldUnits),dn(e,a,h.handles.textBox,y,h.handles,x,g,i,10,!0)}})}}function Vi(e,t){const{left:n,top:o,width:a,height:i}=qi(e,t);return[{x:n+a/2,y:o},{x:n,y:o+i/2},{x:n+a/2,y:o+i},{x:n+a,y:o+i/2}]}function zi(e,t){return"CT"===e&&!1!==t?"HU":""}function ji(e,t,{area:n,mean:o,stdDev:a,min:i,max:r,meanStdDevSUV:s}={},c,l,d={}){const u=d.showMinMax||!1,h=[],g=[];if(!t){const t=s&&0!==s.mean,n=zi(c,d.showHounsfieldUnits);let l="Mean: ".concat(Oi(o.toFixed(2))," ").concat(n);const h="Std Dev: ".concat(Oi(a.toFixed(2))," ").concat(n);if(t){const t=" SUV: ",n="".concat(t).concat(Oi(s.mean.toFixed(2))),o="".concat(t).concat(Oi(s.stdDev.toFixed(2))),a=Math.floor(e.measureText("".concat(h,"     ")).width);for(;e.measureText(l).width<a;)l+=" ";g.push("".concat(l).concat(n)),g.push("".concat(h,"     ").concat(o))}else g.push("".concat(l)),g.push("".concat(h));if(u){let o="Min: ".concat(i," ").concat(n);const a="Max: ".concat(r," ").concat(n),s=t?Math.floor(e.measureText("".concat(h,"     ")).width):Math.floor(e.measureText("".concat(l,"     ")).width);for(;e.measureText(o).width<s;)o+=" ";g.push("".concat(o).concat(a))}}return h.push(function(e,t){const n=t?" mm".concat(String.fromCharCode(178)):" px".concat(String.fromCharCode(178));return"Area: ".concat(Oi(e.toFixed(2))).concat(n)}(n,l)),g.forEach(e=>h.push(e)),h}function qi(e,t){return{left:Math.round(Math.min(e.x,t.x)),top:Math.round(Math.min(e.y,t.y)),width:Math.round(Math.abs(e.x-t.x)),height:Math.round(Math.abs(e.y-t.y))}}var Wi=n(21),Gi=n(0);function Yi(e){throw Error(e)}const Xi={errors:e=>e[Gi.a]||Yi("Error observable not found. Make sure to pass a thread instance as returned by the spawn() promise."),events:e=>e[Gi.b]||Yi("Events observable not found. Make sure to pass a thread instance as returned by the spawn() promise."),terminate:e=>e[Gi.c]()};var Ki=n(12),Zi=n.n(Ki);function $i(){return Zi()('/*! cornerstone-tools - 0.0.0-semantically-released - 2021-11-08 | (c) 2017 Chris Hafey | https://github.com/cornerstonejs/cornerstoneTools */!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=9)}([function(e,t,r){"use strict";(function(e){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,s){function i(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}u((n=n.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.expose=t.isWorkerRuntime=t.Transfer=t.registerSerializer=void 0;const s=o(r(4)),i=r(1),a=r(2),u=r(7),c=o(r(8));var l=r(1);Object.defineProperty(t,"registerSerializer",{enumerable:!0,get:function(){return l.registerSerializer}});var f=r(2);Object.defineProperty(t,"Transfer",{enumerable:!0,get:function(){return f.Transfer}}),t.isWorkerRuntime=c.default.isWorkerRuntime;let d=!1;const p=new Map,y=e=>e&&e.type===u.MasterMessageType.run,b=e=>s.default(e)||function(e){return e&&"object"==typeof e&&"function"==typeof e.subscribe}(e);function m(e){return a.isTransferDescriptor(e)?{payload:e.send,transferables:e.transferables}:{payload:e,transferables:void 0}}function g(e,t){const{payload:r,transferables:n}=m(t),o={type:u.WorkerMessageType.error,uid:e,error:i.serialize(r)};c.default.postMessageToMaster(o,n)}function h(e,t,r){const{payload:n,transferables:o}=m(r),s={type:u.WorkerMessageType.result,uid:e,complete:!!t||void 0,payload:n};c.default.postMessageToMaster(s,o)}function v(e){try{const t={type:u.WorkerMessageType.uncaughtError,error:i.serialize(e)};c.default.postMessageToMaster(t)}catch(e){}}function M(e,t,r){return n(this,void 0,void 0,(function*(){let n;try{n=t(...r)}catch(t){return g(e,t)}const o=b(n)?"observable":"promise";if(function(e,t){const r={type:u.WorkerMessageType.running,uid:e,resultType:t};c.default.postMessageToMaster(r)}(e,o),b(n)){const t=n.subscribe(t=>h(e,!1,i.serialize(t)),t=>{g(e,i.serialize(t)),p.delete(e)},()=>{h(e,!0),p.delete(e)});p.set(e,t)}else try{const t=yield n;h(e,!0,i.serialize(t))}catch(t){g(e,i.serialize(t))}}))}t.expose=function(e){if(!c.default.isWorkerRuntime())throw Error("expose() called in the master thread.");if(d)throw Error("expose() called more than once. This is not possible. Pass an object to expose() if you want to expose multiple functions.");if(d=!0,"function"==typeof e)c.default.subscribeToMasterMessages(t=>{y(t)&&!t.method&&M(t.uid,e,t.args.map(i.deserialize))}),function(){const e={type:u.WorkerMessageType.init,exposed:{type:"function"}};c.default.postMessageToMaster(e)}();else{if("object"!=typeof e||!e)throw Error(`Invalid argument passed to expose(). Expected a function or an object, got: ${e}`);c.default.subscribeToMasterMessages(t=>{y(t)&&t.method&&M(t.uid,e[t.method],t.args.map(i.deserialize))}),function(e){const t={type:u.WorkerMessageType.init,exposed:{type:"module",methods:e}};c.default.postMessageToMaster(t)}(Object.keys(e).filter(t=>"function"==typeof e[t]))}c.default.subscribeToMasterMessages(e=>{if((t=e)&&t.type===u.MasterMessageType.cancel){const t=e.uid,r=p.get(t);r&&(r.unsubscribe(),p.delete(t))}var t})},"undefined"!=typeof self&&"function"==typeof self.addEventListener&&c.default.isWorkerRuntime()&&(self.addEventListener("error",e=>{setTimeout(()=>v(e.error||e),250)}),self.addEventListener("unhandledrejection",e=>{const t=e.reason;t&&"string"==typeof t.message&&setTimeout(()=>v(t),250)})),void 0!==e&&"function"==typeof e.on&&c.default.isWorkerRuntime()&&(e.on("uncaughtException",e=>{setTimeout(()=>v(e),250)}),e.on("unhandledRejection",e=>{e&&"string"==typeof e.message&&setTimeout(()=>v(e),250)}))}).call(this,r(3))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serialize=t.deserialize=t.registerSerializer=void 0;const n=r(5);let o=n.DefaultSerializer;t.registerSerializer=function(e){o=n.extendSerializer(o,e)},t.deserialize=function(e){return o.deserialize(e)},t.serialize=function(e){return o.serialize(e)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Transfer=t.isTransferDescriptor=void 0;const n=r(6);t.isTransferDescriptor=function(e){return e&&"object"==typeof e&&e[n.$transferable]},t.Transfer=function(e,t){if(!t){if(!(r=e)||"object"!=typeof r)throw Error();t=[e]}var r;return{[n.$transferable]:!0,send:e,transferables:t}}},function(e,t){var r,n,o=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function a(e){if(r===setTimeout)return setTimeout(e,0);if((r===s||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:s}catch(e){r=s}try{n="function"==typeof clearTimeout?clearTimeout:i}catch(e){n=i}}();var u,c=[],l=!1,f=-1;function d(){l&&u&&(l=!1,u.length?c=u.concat(c):f=-1,c.length&&p())}function p(){if(!l){var e=a(d);l=!0;for(var t=c.length;t;){for(u=c,c=[];++f<t;)u&&u[f].run();f=-1,t=c.length}u=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===i||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function y(e,t){this.fun=e,this.array=t}function b(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new y(e,t)),1!==c.length||l||a(p)},y.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=b,o.addListener=b,o.once=b,o.off=b,o.removeListener=b,o.removeAllListeners=b,o.emit=b,o.prependListener=b,o.prependOnceListener=b,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t,r){"use strict";e.exports=e=>!!e&&("symbol"==typeof Symbol.observable&&"function"==typeof e[Symbol.observable]?e===e[Symbol.observable]():"function"==typeof e["@@observable"]&&e===e["@@observable"]())},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultSerializer=t.extendSerializer=void 0,t.extendSerializer=function(e,t){const r=e.deserialize.bind(e),n=e.serialize.bind(e);return{deserialize:e=>t.deserialize(e,r),serialize:e=>t.serialize(e,n)}};const n={deserialize:e=>Object.assign(Error(e.message),{name:e.name,stack:e.stack}),serialize:e=>({__error_marker:"$$error",message:e.message,name:e.name,stack:e.stack})};t.DefaultSerializer={deserialize(e){return(t=e)&&"object"==typeof t&&"__error_marker"in t&&"$$error"===t.__error_marker?n.deserialize(e):e;var t},serialize:e=>e instanceof Error?n.serialize(e):e}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.$worker=t.$transferable=t.$terminate=t.$events=t.$errors=void 0,t.$errors=Symbol("thread.errors"),t.$events=Symbol("thread.events"),t.$terminate=Symbol("thread.terminate"),t.$transferable=Symbol("thread.transferable"),t.$worker=Symbol("thread.worker")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorkerMessageType=t.MasterMessageType=void 0,function(e){e.cancel="cancel",e.run="run"}(t.MasterMessageType||(t.MasterMessageType={})),function(e){e.error="error",e.init="init",e.result="result",e.running="running",e.uncaughtError="uncaughtError"}(t.WorkerMessageType||(t.WorkerMessageType={}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default={isWorkerRuntime:function(){const e="undefined"!=typeof self&&"undefined"!=typeof Window&&self instanceof Window;return!("undefined"==typeof self||!self.postMessage||e)},postMessageToMaster:function(e,t){self.postMessage(e,t)},subscribeToMasterMessages:function(e){const t=t=>{e(t.data)};return self.addEventListener("message",t),()=>{self.removeEventListener("message",t)}}}},function(e,t,r){"use strict";r.r(t);var n=r(0);const o=n.expose;n.registerSerializer,n.Transfer;function s(e,t,r){return n=e.y,o=t.y,s=r.y,!(!(o<n&&n<s||s<n&&n<o)||!function(e,t,r){if(t.x>e.x&&r.x>e.x)return!0;if(t.x===r.x)return e.x<t.x;if(t.x>r.x){const e=t;t=r,r=e}const n=function(e,t,r){const n=(r.y-t.y)/(r.x-t.x);return{value:t.y+n*(e.x-t.x),gradient:n}}(e,t,r);return Math.sign(n.gradient)*e.y>Math.sign(n.gradient)*n.value}(e,t,r));var n,o,s}function i(e,t,r,n){(function(e,t){let r=!1,n=e.length-1;for(let o=0;o<e.length;o++)s(t,e[o],e[n])&&(r=!r),n=o;return r})(e,t)&&(r.value+=n,r.squared+=n*n,r.count++)}o({calculateFreehandStatistics:function(e,t,r){const n={count:0,mean:0,variance:0,stdDev:0},o=function(e,t,r){const n={value:0,squared:0,count:0};let o=0;for(let s=t.top;s<t.top+t.height;s++)for(let a=t.left;a<t.left+t.width;a++){i(r,{x:a,y:s},n,e[o]),o++}return n}(e,t,r);return 0===o.count||(n.count=o.count,n.mean=o.value/o.count,n.variance=o.squared/o.count-n.mean*n.mean,n.stdDev=Math.sqrt(n.variance)),n}})}]);\n',"Worker",void 0,void 0)}class Ji{constructor(e,t){this.toolIndex=e,this.handleIndexArray=t}}class Qi{constructor(e,t=!0,n=!0){this.x=e.x,this.y=e.y,this.highlight=t,this.active=n,this.lines=[]}}function er(e,t,n,o){let a=e.length-1;for(let i=0;i<e.length;i++){if(-1!==o.indexOf(i)||-1!==o.indexOf(a)){a=i;continue}if(tr(t,n,nr(e[a]),nr(e[i])))return!0;a=i}return!1}function tr(e,t,n,o){let a=!1;const i=[or(e,t,n),or(e,t,o),or(n,o,e),or(n,o,t)];return i[0]!==i[1]&&i[2]!==i[3]||((0===i[0]&&ar(e,n,t)||0===i[1]&&ar(e,o,t)||0===i[2]&&ar(n,e,o)||0===i[3]&&ar(n,t,o))&&(a=!0),a)}function nr(e){return{x:e.x,y:e.y}}function or(e,t,n){const o=(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y);return 0===o?0:o>0?1:2}function ar(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}class ir{constructor(e,t){this._eventData=e,this._toolName=t}findLine(){const e=this.findTool();if(null===e)return null;const t=this._getCloseLinesInTool(e);if(t){return this._findCorrectLine(e,t)}return null}findTool(){if(this._toolData=b(this._eventData.element,this._toolName),this._mousePoint=this._eventData.currentPoints.canvas,!this._toolData)return null;return this._nearestHandleToPointAllTools().toolIndex}_nearestHandleToPointAllTools(){const e=this._toolData;let t={toolIndex:null,handleIndex:null,distance:1/0};for(let n=0;n<e.data.length;n++){const e=this._nearestHandleToPoint(n);null!==e&&(e.distance<t.distance&&(t=e))}return t}_nearestHandleToPoint(e){const t=this._eventData,n=this._toolData.data[e],o=n.handles.points;if(void 0===o)return null;if(!1===n.visible)return null;const a={toolIndex:e,handleIndex:null,distance:1/0};for(let e=0;e<o.length;e++){const n=c.cornerstone.pixelToCanvas(t.element,o[e]),i=c.cornerstoneMath.point.distance(n,this._mousePoint);i<a.distance&&(a.handleIndex=e,a.distance=i)}return a}_getCloseLinesInTool(e){const t=this._toolData.data[e].handles.points,n=[];for(let e=0;e<t.length;e++){const o=ir.getNextHandleIndex(e,t.length);this._distanceOfPointfromLine(t[e],t[o])<10&&n.push([e,o])}return n}_findCorrectLine(e,t){for(let n=0;n<t.length;n++)if(this._pointProjectsToLineSegment(e,t[n]))return new Ji(e,t[n]);return null}_pointProjectsToLineSegment(e,t){const n=this._eventData,o=this._toolData.data[e],a=o.handles.points;if(void 0===o.handles.points)return;if(!1===o.visible)return!1;const i=a[t[0]],r=a[t[1]],s=ir.getCanvasPointsFromHandles(i,r,n.element),c=ir.getLineAsVector(s),l=this._getLineOriginToMouseAsVector(s),d=(l[0]*c[0]+l[1]*c[1])/c.magnitude;return d>0&&d<c.magnitude}static getCanvasPointsFromHandles(e,t,n){const o=[];return e.x<t.x?(o.push(c.cornerstone.pixelToCanvas(n,e)),o.push(c.cornerstone.pixelToCanvas(n,t))):(o.push(c.cornerstone.pixelToCanvas(n,t)),o.push(c.cornerstone.pixelToCanvas(n,e))),o}static getLineAsVector(e){const t=[e[1].x-e[0].x,e[1].y-e[0].y];return t.magnitude=c.cornerstoneMath.point.distance(e[0],e[1]),t}_getLineOriginToMouseAsVector(e){return[this._mousePoint.x-e[0].x,this._mousePoint.y-e[0].y]}_distanceOfPointfromLine(e,t){const n=this._eventData,o=c.cornerstone.pixelToCanvas(n.element,e),a=c.cornerstone.pixelToCanvas(n.element,t),i=this._mousePoint;return Math.abs((a.y-o.y)*i.x-(a.x-o.x)*i.y+a.x*o.y-a.y*o.x)/c.cornerstoneMath.point.distance(o,a)}static getNextHandleIndex(e,t){let n;return n=e<t-1?e+1:0,n}}var rr=function(e,t){t===e.length-1?e[t].lines.push(e[0]):e[t].lines.push(e[t+1])};function sr(e,t){const n=b(e.element,this.name);if(void 0===n)return;const o=t.handleIndex,a=t.toolIndex,i=n.data[a],r=i.handles.points;r.length<=3||(o===r.length-1?(r[o-1].lines.pop(),r[o-1].lines.push(r[0])):0===o?(r[r.length-1].lines.pop(),r[r.length-1].lines.push(r[o+1])):(r[o-1].lines.pop(),r[o-1].lines.push(r[o+1])),r.splice(o,1),i.invalidated=!0,i.active=!0,i.highlight=!0,c.cornerstone.updateImage(e.element))}function cr(e,t){const n=b(e.element,this.name);if(void 0===n)return;const o=n.data[t.toolIndex],a=function(e){const t=e.handleIndexArray;let n=1/0;const o=t.includes(0);for(let e=0;e<t.length;e++){const o=t[e];0!==o&&o<n&&(n=o)}o&&1===n&&(n=0);return n++,n}(t);if(a===1/0)return;const i=new Qi(e.currentPoints.image),r=o.handles.points;r.splice(a,0,i),r[a-1].lines.pop(),r[a-1].lines.push(e.currentPoints.image),rr(r,a),o.active=!0,o.highlight=!0,o.invalidated=!0,c.cornerstone.updateImage(e.element)}function lr(e,t,n){return o=e.y,a=t.y,i=n.y,!(!(a<o&&o<i||i<o&&o<a)||!function(e,t,n){if(t.x>e.x&&n.x>e.x)return!0;if(t.x===n.x)return e.x<t.x;if(t.x>n.x){const e=t;t=n,n=e}const o=function(e,t,n){const o=(n.y-t.y)/(n.x-t.x);return{value:t.y+o*(e.x-t.x),gradient:o}}(e,t,n);return Math.sign(o.gradient)*e.y>Math.sign(o.gradient)*o.value}(e,t,n));var o,a,i}var dr={calculateFreehandStatistics:function(e,t,n,o){setTimeout(async()=>{const a=await Object(Wi.a)(new $i),i=await a.calculateFreehandStatistics(e,t,n);o(i),await Xi.terminate(a)},0)},ClickedLineData:Ji,freehandArea:function(e,t){let n=0,o=e.length-1;t=t||1;for(let t=0;t<e.length;t++)n+=(e[o].x+e[t].x)*(e[o].y-e[t].y),o=t;return Math.abs(n*t/2)},FreehandHandleData:Qi,freehandIntersect:{newHandle:function(e,t){const n=t.length-1;return er(t,nr(t[n]),nr(e),[n])},end:function(e){const t=e.length-1;return er(e,nr(e[t]),nr(e[0]),[t,0])},modify:function(e,t){const n=nr(e[t]);let o=t-1;0===t&&(o=e.length-1);let a=nr(e[o]);return!!er(e,n,a,[t,o])||(o=t===e.length-1?0:t+1,a=nr(e[o]),er(e,n,a,[t,o]))}},FreehandLineFinder:ir,insertOrDelete:function(e,t){const n=e.detail;if(t&&null!==t.handleNearby){const e={toolIndex:t.toolIndex,handleIndex:t.handleNearby};sr.call(this,n,e)}else{const e=new ir(n,this.name).findLine();e&&cr.call(this,n,e)}},pointInFreehand:function(e,t){let n=!1,o=e.length-1;for(let a=0;a<e.length;a++)lr(t,e[a],e[o])&&(n=!n),o=a;return n},addLine:rr};const ur=I("tools:annotation:FreehandRoiTool"),{insertOrDelete:hr,freehandArea:gr,calculateFreehandStatistics:mr,freehandIntersect:fr,FreehandHandleData:pr}=dr;class vr extends Vo{constructor(e={}){super(e,{name:"FreehandRoi",supportedInteractionTypes:["Mouse","Touch"],configuration:{mouseLocation:{handles:{start:{highlight:!0,active:!0}}},spacing:1,activeHandleRadius:3,completeHandleRadius:6,completeHandleRadiusTouch:28,alwaysShowHandles:!1,invalidColor:"crimson",currentHandle:0,currentTool:-1,drawHandles:!0,renderDashed:!1},svgCursor:Jo}),this.isMultiPartTool=!0,this._drawing=!1,this._dragging=!1,this._modifying=!1,this._drawingMouseDownCallback=this._drawingMouseDownCallback.bind(this),this._drawingMouseMoveCallback=this._drawingMouseMoveCallback.bind(this),this._drawingMouseDragCallback=this._drawingMouseDragCallback.bind(this),this._drawingMouseUpCallback=this._drawingMouseUpCallback.bind(this),this._drawingMouseDoubleClickCallback=this._drawingMouseDoubleClickCallback.bind(this),this._editMouseUpCallback=this._editMouseUpCallback.bind(this),this._editMouseDragCallback=this._editMouseDragCallback.bind(this),this._drawingTouchStartCallback=this._drawingTouchStartCallback.bind(this),this._drawingTouchDragCallback=this._drawingTouchDragCallback.bind(this),this._drawingDoubleTapClickCallback=this._drawingDoubleTapClickCallback.bind(this),this._editTouchDragCallback=this._editTouchDragCallback.bind(this),this.throttledUpdateCachedStats=Aa(this.updateCachedStats,110)}createNewMeasurement(e){if(!(e&&e.currentPoints&&e.currentPoints.image))return void ur.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"));const t={visible:!0,active:!0,invalidated:!0,color:void 0,handles:{points:[]}};return t.handles.textBox={active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0},t}pointNearTool(e,t,n){const o=t&&t.handles&&t.handles.points;if(!o)throw new Error("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool"));return!(!o||!1===t.visible)&&void 0!==this._pointNearHandle(e,t,n)}distanceFromPoint(e,t,n){let o=1/0;for(let e=0;e<t.handles.points.length;e++){const a=c.cornerstoneMath.point.distance(t.handles.points[e],n);o=Math.min(o,a)}return o===1/0?-1:o}distanceFromPointCanvas(e,t,n){let o=1/0;if(!t)return-1;const a=c.cornerstone.pixelToCanvas(e,n),i=t.handles.points;for(let t=0;t<i.length;t++){const n=c.cornerstone.pixelToCanvas(e,i[t]),r=c.cornerstoneMath.point.distance(n,a);o=Math.min(o,r)}return o===1/0?-1:o}updateCachedStats(e,t,n){let o;const a=c.cornerstone.metaData.get("generalSeriesModule",e.imageId),i=a?a.modality:null,r=n.handles.points,s={left:r[0].x,right:r[0].x,bottom:r[0].y,top:r[0].x};for(let e=0;e<r.length;e++)s.left=Math.min(s.left,r[e].x),s.right=Math.max(s.right,r[e].x),s.bottom=Math.min(s.bottom,r[e].y),s.top=Math.max(s.top,r[e].y);const l={left:s.left,top:s.bottom,width:Math.abs(s.right-s.left),height:Math.abs(s.top-s.bottom)};if(n.polyBoundingBox=l,!e.color){const a=c.cornerstone.getPixels(t,l.left,l.top,l.width,l.height);mr.call(this,a,l,n.handles.points,t=>{"PT"===i&&(o={mean:Ii(e,(t.mean-e.intercept)/e.slope),stdDev:Ii(e,(t.stdDev-e.intercept)/e.slope)}),t&&!isNaN(t.mean)&&(n.meanStdDev=t,n.meanStdDevSUV=o)})}const{colPixelSpacing:d,rowPixelSpacing:u}=ka(e),h=(d||1)*(u||1),g=gr(n.handles.points,h);isNaN(g)||(n.area=g),n.invalidated=!1}renderToolData(e){const t=e.detail,n=b(e.currentTarget,this.name);if(!n)return;const{image:o,element:a}=t,i=this.configuration,r=c.cornerstone.metaData.get("generalSeriesModule",o.imageId),s=r?r.modality:null,l=hn(t.canvasContext.canvas),d=kt.getToolWidth(),{renderDashed:u}=i,h=ot("globalConfiguration").configuration.lineDash;for(let e=0;e<n.data.length;e++){const r=n.data[e];!1!==r.visible&&_t(l,e=>{let n,s=Gt.getColorIfActive(r);r.active?r.handles.invalidHandlePlacement?(s=i.invalidColor,n=i.invalidColor):(s=Gt.getColorIfActive(r),n=Gt.getFillColor()):n=Gt.getToolColor();let c={color:s};if(u&&(c.lineDash=h),r.handles.points.length){const t=r.handles.points;At(e,a,t[0],t,c),r.polyBoundingBox?At(e,a,t[t.length-1],[t[0]],c):At(e,a,t[t.length-1],[i.mouseLocation.handles.start],c)}if(c={color:s,fill:n},(i.alwaysShowHandles||r.active&&r.polyBoundingBox)&&(c.handleRadius=i.activeHandleRadius,this.configuration.drawHandles&&Yt(e,t,r.handles.points,c)),r.canComplete){c.handleRadius=i.completeHandleRadius;const n=r.handles.points[0];this.configuration.drawHandles&&Yt(e,t,[n],c)}if(r.active&&!r.polyBoundingBox){c.handleRadius=i.activeHandleRadius,this.configuration.drawHandles&&Yt(e,t,i.mouseLocation.handles,c);const n=r.handles.points[0];this.configuration.drawHandles&&Yt(e,t,[n],c)}if(!0!==r.invalidated||r.active||(r.meanStdDev&&r.meanStdDevSUV&&r.area?this.throttledUpdateCachedStats(o,a,r):this.updateCachedStats(o,a,r)),r.polyBoundingBox&&!r.handles.textBox.freehand){r.handles.textBox.hasMoved||(r.handles.textBox.x=r.polyBoundingBox.left+r.polyBoundingBox.width,r.handles.textBox.y=r.polyBoundingBox.top+r.polyBoundingBox.height/2);const t=g.call(this,r);dn(e,a,r.handles.textBox,t,r.handles.points,m,s,d,0,!0)}})}function g(e){const{meanStdDev:t,meanStdDevSUV:n,area:a}=e,i=[];if(t&&void 0!==t.mean){let o="";"CT"===s&&(o="HU"),e.unit=o;let a="Mean: ".concat(Oi(t.mean.toFixed(2))," ").concat(o),r="StdDev: ".concat(Oi(t.stdDev.toFixed(2))," ").concat(o);if(n&&void 0!==n.mean){const e=" SUV: ";a+=e+Oi(n.mean.toFixed(2)),r+=e+Oi(n.stdDev.toFixed(2))}i.push(a),i.push(r)}if(a){let e=" mm".concat(String.fromCharCode(178));const{rowPixelSpacing:t,colPixelSpacing:n}=ka(o);t&&n||(e=" pixels".concat(String.fromCharCode(178)));const r="Area: ".concat(Oi(a.toFixed(2))).concat(e);i.push(r)}return i}function m(e){return e}}addNewMeasurement(e){const t=e.detail;this._startDrawing(e),this._addPoint(t),xr(e)}preMouseDownCallback(e){const t=e.detail,n=this._pointNearHandleAllTools(t);return!!t.event.ctrlKey&&(void 0!==n&&n.handleNearby.hasBoundingBox||hr.call(this,e,n),xr(e),!0)}handleSelectedCallback(e,t,n,o="mouse"){const{element:a}=e.detail,i=b(a,this.name);if(n.hasBoundingBox)return void Uo(e,this,t,n,o);const r=this.configuration;r.dragOrigin={x:n.x,y:n.y};for(let e=0;e<i.data.length;e++){const t=i.data[e].handles.points;for(let o=0;o<t.length;o++)t[o]===n&&(r.currentHandle=o,r.currentTool=e)}this._modifying=!0,this._activateModify(a),xr(e)}_drawingMouseMoveCallback(e){const t=e.detail,{currentPoints:n,element:o}=t,a=b(o,this.name),i=this.configuration,r=i.currentTool,s=a.data[r],l=n.canvas;this._getMouseLocation(t),this._checkInvalidHandleLocation(s,t);const d=this._pointNearHandle(o,s,l),u=s.handles.points;void 0!==d&&!d.hasBoundingBox&&d<u.length-1&&(i.mouseLocation.handles.start.x=u[d].x,i.mouseLocation.handles.start.y=u[d].y),c.cornerstone.updateImage(o)}_drawingMouseDragCallback(e){this.options.mouseButtonMask.includes(e.detail.buttons)&&this._drawingDrag(e)}_drawingTouchDragCallback(e){this._drawingDrag(e)}_drawingDrag(e){const t=e.detail,{element:n}=t,o=b(n,this.name),a=this.configuration.currentTool,i=o.data[a];this._getMouseLocation(t),this._checkInvalidHandleLocation(i,t),this._addPointPencilMode(t,i.handles.points),this._dragging=!0,c.cornerstone.updateImage(n)}_drawingMouseUpCallback(e){const{element:t}=e.detail;if(!this._dragging)return;this._dragging=!1;const n=this.configuration,o=n.currentTool,a=b(t,this.name).data[o];if(!fr.end(a.handles.points)&&a.canComplete){const e=n.currentHandle;this._endDrawing(t,e)}xr(e)}_drawingMouseDownCallback(e){const t=e.detail,{buttons:n,currentPoints:o,element:a}=t;if(!this.options.mouseButtonMask.includes(n))return;const i=o.canvas,r=this.configuration,s=r.currentTool,c=b(a,this.name).data[s],l=this._pointNearHandle(a,c,i);if(!fr.end(c.handles.points)&&c.canComplete){const e=r.currentHandle;this._endDrawing(a,e)}else void 0===l&&this._addPoint(t);xr(e)}_drawingTouchStartCallback(e){const t=e.detail,{currentPoints:n,element:o}=t,a=n.canvas,i=this.configuration,r=i.currentTool,s=b(o,this.name).data[r],c=this._pointNearHandle(o,s,a);if(!fr.end(s.handles.points)&&s.canComplete){const e=i.currentHandle;this._endDrawing(o,e)}else void 0===c&&this._addPoint(t);xr(e)}completeDrawing(e){if(!this._drawing)return;const t=b(e,this.name),n=this.configuration,o=t.data[n.currentTool];if(!fr.end(o.handles.points)&&o.handles.points.length>=2){const t=n.currentHandle;o.polyBoundingBox={},this._endDrawing(e,t)}}_drawingMouseDoubleClickCallback(e){const{element:t}=e.detail;this.completeDrawing(t),xr(e)}_drawingDoubleTapClickCallback(e){const{element:t}=e.detail;this.completeDrawing(t),xr(e)}_editMouseDragCallback(e){const t=e.detail,{element:n,buttons:o}=t;if(!this.options.mouseButtonMask.includes(o))return;const a=b(n,this.name),i=this.configuration,r=a.data[i.currentTool],s=i.currentHandle,l=r.handles.points;let d=-1;if(this._getMouseLocation(t),r.handles.invalidHandlePlacement=fr.modify(l,s),r.active=!0,r.highlight=!0,l[s].x=i.mouseLocation.handles.start.x,l[s].y=i.mouseLocation.handles.start.y,d=this._getPrevHandleIndex(s,l),s>=0){const e=l[d].lines.length-1,t=l[d].lines[e];t.x=i.mouseLocation.handles.start.x,t.y=i.mouseLocation.handles.start.y}c.cornerstone.updateImage(n)}_editTouchDragCallback(e){const t=e.detail,{element:n}=t,o=b(n,this.name),a=this.configuration,i=o.data[a.currentTool],r=a.currentHandle,s=i.handles.points;let l=-1;if(this._getMouseLocation(t),i.handles.invalidHandlePlacement=fr.modify(s,r),i.active=!0,i.highlight=!0,s[r].x=a.mouseLocation.handles.start.x,s[r].y=a.mouseLocation.handles.start.y,l=this._getPrevHandleIndex(r,s),r>=0){const e=s[l].lines.length-1,t=s[l].lines[e];t.x=a.mouseLocation.handles.start.x,t.y=a.mouseLocation.handles.start.y}c.cornerstone.updateImage(n)}_getPrevHandleIndex(e,t){return 0===e?t.length-1:e-1}_editMouseUpCallback(e){const t=e.detail,{element:n}=t,o=b(n,this.name);this._deactivateModify(n),this._dropHandle(t,o),this._endDrawing(n),c.cornerstone.updateImage(n)}_dropHandle(e,t){const n=this.configuration,o=n.currentTool,a=t.data[o].handles,i=a.points;if(a.invalidHandlePlacement){const e=n.currentHandle,t=i[e];let o;if(0===e){o=i[i.length-1]}else o=i[e-1];t.x=n.dragOrigin.x,t.y=n.dragOrigin.y,o.lines[0]=t,a.invalidHandlePlacement=!1}}_startDrawing(e){const t=e.detail,n=this.createNewMeasurement(t),{element:o}=t,a=this.configuration;let i;e.type===l.MOUSE_DOWN_ACTIVATE?i="Mouse":e.type===l.TOUCH_START_ACTIVE&&(i="Touch"),this._activateDraw(o,i),this._getMouseLocation(t),y(o,this.name,n);const r=b(o,this.name);a.currentTool=r.data.length-1,this._activeDrawingToolReference=r.data[a.currentTool]}_addPoint(e){const{currentPoints:t,element:n}=e,o=b(n,this.name),a=this.configuration,i=o.data[a.currentTool];if(i.handles.invalidHandlePlacement)return;const r=new pr(t.image);i.handles.points.length&&i.handles.points[a.currentHandle-1].lines.push(t.image),i.handles.points.push(r),a.currentHandle+=1,c.cornerstone.updateImage(n),this.fireModifiedEvent(n,i)}_addPointPencilMode(e,t){const n=this.configuration,{element:o}=e,a=n.mouseLocation.handles.start;t.every(e=>this._isDistanceLargerThanSpacing(o,e,a))&&this._addPoint(e)}_endDrawing(e,t){const n=b(e,this.name),o=this.configuration,a=n.data[o.currentTool];if(a.active=!1,a.highlight=!1,a.handles.invalidHandlePlacement=!1,void 0!==t){const e=a.handles.points;e[o.currentHandle-1].lines.push(e[0])}this._modifying&&(this._modifying=!1,a.invalidated=!0),o.currentHandle=0,o.currentTool=-1,a.canComplete=!1,this._drawing&&this._deactivateDraw(e),c.cornerstone.updateImage(e),this.fireModifiedEvent(e,a),this.fireCompletedEvent(e,a)}_pointNearHandle(e,t,n){if(void 0!==t.handles&&void 0!==t.handles.points&&!1!==t.visible){for(let o=0;o<t.handles.points.length;o++){const a=c.cornerstone.pixelToCanvas(e,t.handles.points[o]);if(c.cornerstoneMath.point.distance(a,n)<6)return o}return t.handles.textBox&&Xn(t.handles.textBox,n)?t.handles.textBox:void 0}}_pointNearHandleAllTools(e){const{currentPoints:t,element:n}=e,o=t.canvas,a=b(n,this.name);if(!a)return;let i;for(let e=0;e<a.data.length;e++)if(i=this._pointNearHandle(n,a.data[e],o),void 0!==i)return{handleNearby:i,toolIndex:e}}_getMouseLocation(e){const{currentPoints:t,image:n}=e,o=this.configuration;o.mouseLocation.handles.start.x=t.image.x,o.mouseLocation.handles.start.y=t.image.y,rn(o.mouseLocation.handles.start,n)}_checkInvalidHandleLocation(e,t){if(e.handles.points.length<2)return!0;let n;n=this._dragging?this._checkHandlesPencilMode(e,t):this._checkHandlesPolygonMode(e,t),e.handles.invalidHandlePlacement=n}_checkHandlesPolygonMode(e,t){const n=this.configuration,{element:o}=t,a=n.mouseLocation.handles.start,i=e.handles.points;let r=!1;return e.canComplete=!1,this._isDistanceSmallerThanCompleteSpacingCanvas(o,i[0],a)&&!fr.end(i)&&i.length>2?(e.canComplete=!0,r=!1):r=fr.newHandle(a,i),r}_checkHandlesPencilMode(e,t){const n=this.configuration.mouseLocation.handles.start,o=e.handles.points;let a=fr.newHandle(n,o);return!1===a&&(a=this._invalidHandlePencilMode(e,t)),a}_invalidHandlePencilMode(e,t){const n=this.configuration,{element:o}=t,a=n.mouseLocation.handles.start,i=e.handles.points;if(this._isDistanceSmallerThanCompleteSpacingCanvas(o,i[0],a))return e.canComplete=!0,!1;e.canComplete=!1;for(let e=1;e<i.length-1;e++)if(this._isDistanceSmallerThanSpacing(o,i[e],a))return!0;return!1}_isDistanceSmallerThanCompleteSpacingCanvas(e,t,n){const o=c.cornerstone.pixelToCanvas(e,t),a=c.cornerstone.pixelToCanvas(e,n);let i;return"Mouse"===this._drawingInteractionType?i=this.configuration.completeHandleRadius:"Touch"===this._drawingInteractionType&&(i=this.configuration.completeHandleRadiusTouch),this._compareDistanceToSpacing(e,o,a,"<",i)}_isDistanceSmallerThanSpacing(e,t,n){return this._compareDistanceToSpacing(e,t,n,"<")}_isDistanceLargerThanSpacing(e,t,n){return this._compareDistanceToSpacing(e,t,n,">")}_compareDistanceToSpacing(e,t,n,o=">",a=this.configuration.spacing){return">"===o?c.cornerstoneMath.point.distance(t,n)>a:c.cornerstoneMath.point.distance(t,n)<a}_activateDraw(e,t="Mouse"){this._drawing=!0,this._drawingInteractionType=t,et.isMultiPartToolActive=!0,ct(this.element),e.addEventListener(l.MOUSE_DOWN,this._drawingMouseDownCallback),e.addEventListener(l.MOUSE_MOVE,this._drawingMouseMoveCallback),e.addEventListener(l.MOUSE_DOUBLE_CLICK,this._drawingMouseDoubleClickCallback),e.addEventListener(l.MOUSE_DRAG,this._drawingMouseDragCallback),e.addEventListener(l.MOUSE_UP,this._drawingMouseUpCallback),e.addEventListener(l.TOUCH_START,this._drawingMouseMoveCallback),e.addEventListener(l.TOUCH_START,this._drawingTouchStartCallback),e.addEventListener(l.TOUCH_DRAG,this._drawingTouchDragCallback),e.addEventListener(l.TOUCH_END,this._drawingMouseUpCallback),e.addEventListener(l.DOUBLE_TAP,this._drawingDoubleTapClickCallback),c.cornerstone.updateImage(e)}_deactivateDraw(e){this._drawing=!1,et.isMultiPartToolActive=!1,this._activeDrawingToolReference=null,this._drawingInteractionType=null,st(this.element,this.svgCursor),e.removeEventListener(l.MOUSE_DOWN,this._drawingMouseDownCallback),e.removeEventListener(l.MOUSE_MOVE,this._drawingMouseMoveCallback),e.removeEventListener(l.MOUSE_DOUBLE_CLICK,this._drawingMouseDoubleClickCallback),e.removeEventListener(l.MOUSE_DRAG,this._drawingMouseDragCallback),e.removeEventListener(l.MOUSE_UP,this._drawingMouseUpCallback),e.removeEventListener(l.TOUCH_START,this._drawingTouchStartCallback),e.removeEventListener(l.TOUCH_DRAG,this._drawingTouchDragCallback),e.removeEventListener(l.TOUCH_START,this._drawingMouseMoveCallback),e.removeEventListener(l.TOUCH_END,this._drawingMouseUpCallback),c.cornerstone.updateImage(e)}_activateModify(e){et.isToolLocked=!0,e.addEventListener(l.MOUSE_UP,this._editMouseUpCallback),e.addEventListener(l.MOUSE_DRAG,this._editMouseDragCallback),e.addEventListener(l.MOUSE_CLICK,this._editMouseUpCallback),e.addEventListener(l.TOUCH_END,this._editMouseUpCallback),e.addEventListener(l.TOUCH_DRAG,this._editTouchDragCallback),c.cornerstone.updateImage(e)}_deactivateModify(e){et.isToolLocked=!1,e.removeEventListener(l.MOUSE_UP,this._editMouseUpCallback),e.removeEventListener(l.MOUSE_DRAG,this._editMouseDragCallback),e.removeEventListener(l.MOUSE_CLICK,this._editMouseUpCallback),e.removeEventListener(l.TOUCH_END,this._editMouseUpCallback),e.removeEventListener(l.TOUCH_DRAG,this._editTouchDragCallback),c.cornerstone.updateImage(e)}passiveCallback(e){this._closeToolIfDrawing(e)}enabledCallback(e){this._closeToolIfDrawing(e)}disabledCallback(e){this._closeToolIfDrawing(e)}_closeToolIfDrawing(e){if(this._drawing){const t=this.configuration.currentHandle;this._endDrawing(e,t),c.cornerstone.updateImage(e)}}fireModifiedEvent(e,t){d(e,l.MEASUREMENT_MODIFIED,{toolName:this.name,toolType:this.name,element:e,measurementData:t})}fireCompletedEvent(e,t){d(e,l.MEASUREMENT_COMPLETED,{toolName:this.name,toolType:this.name,element:e,measurementData:t})}get spacing(){return this.configuration.spacing}set spacing(e){if("number"!=typeof e)throw new Error("Attempting to set freehand spacing to a value other than a number.");this.configuration.spacing=e,c.cornerstone.updateImage(this.element)}get activeHandleRadius(){return this.configuration.activeHandleRadius}set activeHandleRadius(e){if("number"!=typeof e)throw new Error("Attempting to set freehand activeHandleRadius to a value other than a number.");this.configuration.activeHandleRadius=e,c.cornerstone.updateImage(this.element)}get completeHandleRadius(){return this.configuration.completeHandleRadius}set completeHandleRadius(e){if("number"!=typeof e)throw new Error("Attempting to set freehand completeHandleRadius to a value other than a number.");this.configuration.completeHandleRadius=e,c.cornerstone.updateImage(this.element)}get alwaysShowHandles(){return this.configuration.alwaysShowHandles}set alwaysShowHandles(e){if("boolean"!=typeof e)throw new Error("Attempting to set freehand alwaysShowHandles to a value other than a boolean.");this.configuration.alwaysShowHandles=e,c.cornerstone.updateImage(this.element)}get invalidColor(){return this.configuration.invalidColor}set invalidColor(e){this.configuration.invalidColor=e,c.cornerstone.updateImage(this.element)}cancelDrawing(e){if(!this._drawing)return;const t=b(e,this.name),n=this.configuration,o=t.data[n.currentTool];o.active=!1,o.highlight=!1,o.handles.invalidHandlePlacement=!1,n.currentHandle=0,n.currentTool=-1,o.canComplete=!1,T(e,this.name,o),this._deactivateDraw(e),c.cornerstone.updateImage(e)}newImageCallback(e){const t=this.configuration;if(!this._drawing||!this._activeDrawingToolReference)return;const n=e.detail.element,o=this._activeDrawingToolReference;o.active=!1,o.highlight=!1,o.handles.invalidHandlePlacement=!1;const a=o.handles.points;a[t.currentHandle-1].lines.push(a[0]),t.currentHandle=0,t.currentTool=-1,o.canComplete=!1,this._deactivateDraw(n),c.cornerstone.updateImage(n)}}function xr(e){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()}const yr=I("tools:annotation:LengthTool");class br extends Vo{constructor(e={}){super(e,{name:"Length",supportedInteractionTypes:["Mouse","Touch"],svgCursor:ea,configuration:{drawHandles:!0,drawHandlesOnHover:!1,hideHandlesIfMoving:!1,renderDashed:!1,digits:2}}),this.throttledUpdateCachedStats=Aa(this.updateCachedStats,110)}createNewMeasurement(e){if(!(e&&e.currentPoints&&e.currentPoints.image))return void yr.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"));const{x:t,y:n}=e.currentPoints.image;return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:t,y:n,highlight:!0,active:!1},end:{x:t,y:n,highlight:!0,active:!0},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}}pointNearTool(e,t,n){return t&&t.handles&&t.handles.start&&t.handles.end?!1!==t.visible&&zo(e,t.handles.start,t.handles.end,n)<25:(yr.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!1)}updateCachedStats(e,t,n){const{rowPixelSpacing:o,colPixelSpacing:a}=ka(e),i=(n.handles.end.x-n.handles.start.x)*(a||1),r=(n.handles.end.y-n.handles.start.y)*(o||1),s=Math.sqrt(i*i+r*r);n.length=s,n.invalidated=!1}renderToolData(e){const t=e.detail,{handleRadius:n,drawHandlesOnHover:o,hideHandlesIfMoving:a,renderDashed:i,digits:r}=this.configuration,s=b(e.currentTarget,this.name);if(!s)return;const c=hn(t.canvasContext.canvas),{image:l,element:d}=t,{rowPixelSpacing:u,colPixelSpacing:h}=ka(l),g=kt.getToolWidth(),m=ot("globalConfiguration").configuration.lineDash;for(let e=0;e<s.data.length;e++){const r=s.data[e];!1!==r.visible&&_t(c,e=>{mn(e,this.configuration);const s=Gt.getColorIfActive(r),c={color:s};i&&(c.lineDash=m),Lt(e,d,r.handles.start,r.handles.end,c);const v={color:s,handleRadius:n,drawHandlesIfActive:o,hideHandlesIfMoving:a};if(this.configuration.drawHandles&&Yt(e,t,r.handles,v),!r.handles.textBox.hasMoved){const e={x:Math.max(r.handles.start.x,r.handles.end.x)};e.x===r.handles.start.x?e.y=r.handles.start.y:e.y=r.handles.end.y,r.handles.textBox.x=e.x,r.handles.textBox.y=e.y}!0===r.invalidated&&(r.length?this.throttledUpdateCachedStats(l,d,r):this.updateCachedStats(l,d,r));const x=f(r,u,h);dn(e,d,r.handles.textBox,x,r.handles,p,s,g,10,!0)})}function f(e,t,n){const o=function(e){const t=Number(e);return isNaN(t)?void 0:t}(e.length);if(!o)return"";let a="mm";return t&&n||(a="pixels"),e.unit=a,"".concat(o.toFixed(r)," ").concat(a)}function p(e){const t={x:(e.start.x+e.end.x)/2,y:(e.start.y+e.end.y)/2};return[e.start,t,e.end]}}}var Tr=function(e,t,n,o,a){if(!e)throw new Error("getRGBPixels: parameter element must not be undefined");t=Math.round(t),n=Math.round(n);const i=c.cornerstone.getEnabledElement(e),r=[];let s=0;const l=i.image.getPixelData();let d,u,h;if(i.image.color)for(u=0;u<a;u++)for(h=0;h<o;h++){d=4*((u+n)*i.image.columns+(h+t));const e=l[d],o=l[d+1],a=l[d+2],c=l[d+3];r[s++]=e,r[s++]=o,r[s++]=a,r[s++]=c}return r};const Cr=I("tools:annotation:ProbeTool");class Mr extends Vo{constructor(e={}){super(e,{name:"Probe",supportedInteractionTypes:["Mouse","Touch"],svgCursor:ta,configuration:{drawHandles:!0,renderDashed:!1}}),this.throttledUpdateCachedStats=Aa(this.updateCachedStats,110)}createNewMeasurement(e){if(e&&e.currentPoints&&e.currentPoints.image)return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0}}};Cr.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}pointNearTool(e,t,n){const o=t&&t.handles&&t.handles.end;if(o||Cr.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!o||!1===t.visible)return!1;const a=c.cornerstone.pixelToCanvas(e,t.handles.end);return c.cornerstoneMath.point.distance(a,n)<5}updateCachedStats(e,t,n){const o=Math.round(n.handles.end.x),a=Math.round(n.handles.end.y),i={};o>=0&&a>=0&&o<e.columns&&a<e.rows&&(i.x=o,i.y=a,e.color?i.storedPixels=Tr(t,o,a,1,1):(i.storedPixels=c.cornerstone.getStoredPixels(t,o,a,1,1),i.sp=i.storedPixels[0],i.mo=i.sp*e.slope+e.intercept,i.suv=Ii(e,i.sp))),n.cachedStats=i,n.invalidated=!1}renderToolData(e){const t=e.detail,{handleRadius:n,renderDashed:o}=this.configuration,a=b(e.currentTarget,this.name);if(!a)return;const i=hn(t.canvasContext.canvas),{image:r,element:s}=t,l=Qt.getFontSize(),d=ot("globalConfiguration").configuration.lineDash;for(let e=0;e<a.data.length;e++){const u=a.data[e];!1!==u.visible&&_t(i,e=>{const a=Gt.getColorIfActive(u);if(this.configuration.drawHandles){const i={handleRadius:n,color:a};o&&(i.lineDash=d),Yt(e,t,u.handles,i)}let i,h;!0===u.invalidated&&(u.cachedStats?this.throttledUpdateCachedStats(r,s,u):this.updateCachedStats(r,s,u));const{x:g,y:m,storedPixels:f,sp:p,mo:v,suv:x}=u.cachedStats;if(g>=0&&m>=0&&g<r.columns&&m<r.rows){i="".concat(g,", ").concat(m),r.color?h="R: ".concat(f[0]," G: ").concat(f[1]," B: ").concat(f[2]):(h="SP: ".concat(p," MO: ").concat(parseFloat(v.toFixed(3))),x&&(h+=" SUV: ".concat(parseFloat(x.toFixed(3)))));const n={x:u.handles.end.x+3,y:u.handles.end.y-3},o=c.cornerstone.pixelToCanvas(t.element,n);on(e,h,o.x,o.y+l+5,a),on(e,i,o.x,o.y,a)}})}}}const Er=I("tools:annotation:RectangleRoiTool");class wr extends Vo{constructor(e={}){super(e,{name:"RectangleRoi",supportedInteractionTypes:["Mouse","Touch"],configuration:{drawHandles:!0,drawHandlesOnHover:!1,hideHandlesIfMoving:!1,renderDashed:!1},svgCursor:na}),this.throttledUpdateCachedStats=Aa(this.updateCachedStats,110)}createNewMeasurement(e){if(e&&e.currentPoints&&e.currentPoints.image)return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},initialRotation:e.viewport.rotation,textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};Er.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}pointNearTool(e,t,n,o){const a=t&&t.handles&&t.handles.start&&t.handles.end;if(a||Er.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!a||!1===t.visible)return!1;const i="mouse"===o?15:25,r=c.cornerstone.pixelToCanvas(e,t.handles.start),s=c.cornerstone.pixelToCanvas(e,t.handles.end),l={left:Math.min(r.x,s.x),top:Math.min(r.y,s.y),width:Math.abs(r.x-s.x),height:Math.abs(r.y-s.y)};return c.cornerstoneMath.rect.distanceToPoint(l,n)<i}updateCachedStats(e,t,n){const o=(c.cornerstone.metaData.get("generalSeriesModule",e.imageId)||{}).modality,a=ka(e),i=function(e,t,n,o,a){const i=Ir(n.start,n.end),r=function(e,t){let n=0,o=0,a=0,i=0,r=e?e[0]:null,s=e?e[0]:null;for(let c=t.top;c<t.top+t.height;c++)for(let c=t.left;c<t.left+t.width;c++)n+=e[i],o+=e[i]*e[i],r=Math.min(r,e[i]),s=Math.max(s,e[i]),a++,i++;if(0===a)return{count:a,mean:0,variance:0,stdDev:0,min:0,max:0};const c=n/a,l=o/a-c*c;return{count:a,mean:c,variance:l,stdDev:Math.sqrt(l),min:r,max:s}}(c.cornerstone.getPixels(t,i.left,i.top,i.width,i.height),i);let s;"PT"===o&&(s={mean:Ii(e,r.mean,!0)||0,stdDev:Ii(e,r.stdDev,!0)||0});const l=i.width*(a.colPixelSpacing||1)*(i.height*(a.rowPixelSpacing||1)),d=2*i.width*(a.colPixelSpacing||1)+2*i.height*(a.rowPixelSpacing||1);return{area:l||0,perimeter:d,count:r.count||0,mean:r.mean||0,variance:r.variance||0,stdDev:r.stdDev||0,min:r.min||0,max:r.max||0,meanStdDevSUV:s}}(e,t,n.handles,o,a);n.cachedStats=i,n.invalidated=!1}renderToolData(e){const t=b(e.currentTarget,this.name);if(!t)return;const n=e.detail,{image:o,element:a}=n,i=kt.getToolWidth(),r=ot("globalConfiguration").configuration.lineDash,{handleRadius:s,drawHandlesOnHover:l,hideHandlesIfMoving:d,renderDashed:u}=this.configuration,h=hn(n.canvasContext.canvas),{rowPixelSpacing:g,colPixelSpacing:m}=ka(o),f=(c.cornerstone.metaData.get("generalSeriesModule",o.imageId)||{}).modality,p=g&&m;_t(h,e=>{for(let c=0;c<t.data.length;c++){const h=t.data[c];if(!1===h.visible)continue;const g=Gt.getColorIfActive(h),m={color:g,handleRadius:s,drawHandlesIfActive:l,hideHandlesIfMoving:d};mn(e,this.configuration);const v={color:g};if(u&&(v.lineDash=r),un(e,a,h.handles.start,h.handles.end,v,"pixel",h.handles.initialRotation),this.configuration.drawHandles&&Yt(e,n,h.handles,m),!0===h.invalidated&&(h.cachedStats?this.throttledUpdateCachedStats(o,a,h):this.updateCachedStats(o,a,h)),!h.handles.textBox.hasMoved){const e=ki(n.viewport,h.handles);Object.assign(h.handles.textBox,e)}const x=e=>Sr(e.start,e.end),y=Pr(e,o.color,h.cachedStats,f,p,this.configuration);h.unit=_r(f,this.configuration.showHounsfieldUnits),dn(e,a,h.handles.textBox,y,h.handles,x,g,i,10,!0)}})}}function Ir(e,t){return{left:Math.min(e.x,t.x),top:Math.min(e.y,t.y),width:Math.abs(e.x-t.x),height:Math.abs(e.y-t.y)}}function Sr(e,t){const{left:n,top:o,width:a,height:i}=Ir(e,t);return[{x:n+a/2,y:o},{x:n,y:o+i/2},{x:n+a/2,y:o+i},{x:n+a,y:o+i/2}]}function _r(e,t){return"CT"===e&&!1!==t?"HU":""}function Pr(e,t,{area:n,mean:o,stdDev:a,min:i,max:r,meanStdDevSUV:s},c,l,d={}){const u=d.showMinMax||!1,h=[],g=[];if(!t){const t=s&&0!==s.mean,n=_r(c,d.showHounsfieldUnits);let l="Mean: ".concat(Oi(o.toFixed(2))," ").concat(n);const h="Std Dev: ".concat(Oi(a.toFixed(2))," ").concat(n);if(t){const t=" SUV: ",n="".concat(t).concat(Oi(s.mean.toFixed(2))),o="".concat(t).concat(Oi(s.stdDev.toFixed(2))),a=Math.floor(e.measureText("".concat(h,"     ")).width);for(;e.measureText(l).width<a;)l+=" ";g.push("".concat(l).concat(n)),g.push("".concat(h,"     ").concat(o))}else g.push("".concat(l)),g.push("".concat(h));if(u){let o="Min: ".concat(i," ").concat(n);const a="Max: ".concat(r," ").concat(n),s=t?Math.floor(e.measureText("".concat(h,"     ")).width):Math.floor(e.measureText("".concat(l,"     ")).width);for(;e.measureText(o).width<s;)o+=" ";g.push("".concat(o).concat(a))}}return h.push(function(e,t){const n=t?" mm".concat(String.fromCharCode(178)):" px".concat(String.fromCharCode(178));return"Area: ".concat(Oi(e.toFixed(2))).concat(n)}(n,l)),g.forEach(e=>h.push(e)),h}class Dr extends Vo{constructor(e={}){super(e,{name:"TextMarker",supportedInteractionTypes:["Mouse","Touch"],configuration:{markers:[],current:"",ascending:!0,loop:!1,changeTextCallback:kr},svgCursor:oa}),this.touchPressCallback=this._changeText.bind(this),this.doubleClickCallback=this._changeText.bind(this)}createNewMeasurement(e){const t=this.configuration;if(!t.current)return;const n={visible:!0,active:!0,text:t.current,color:void 0,handles:{end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0,hasBoundingBox:!0}}},o={left:0,top:0,width:e.image.width,height:e.image.height};if(!c.cornerstoneMath.point.insideRect(n.handles.end,o))return;let a=t.markers.indexOf(t.current);return a+=t.ascending?1:-1,a>=t.markers.length?a=t.loop?0:-1:a<0&&(a=t.loop?t.markers.length:-1),t.current=t.markers[a],n}pointNearTool(e,t,n){if(!1===t.visible)return!1;if(!t.handles.end.boundingBox)return;const o=c.cornerstoneMath.rect.distanceToPoint(t.handles.end.boundingBox,n),a=Xn(t.handles.end,n);return o<10||a}updateCachedStats(){}renderToolData(e){const t=e.detail,n=this.configuration,o=b(t.element,this.name);if(!o)return;const a=hn(t.canvasContext.canvas);for(let e=0;e<o.data.length;e++){const i=o.data[e];if(!1===i.visible)continue;const r=Gt.getColorIfActive(i);_t(a,e=>{mn(e,n);const o=c.cornerstone.pixelToCanvas(t.element,i.handles.end);i.handles.end.boundingBox=on(e,i.text,o.x,o.y-10,r,{centering:{x:!0,y:!0}})})}}_changeText(e){const t=e.detail,{element:n,currentPoints:o}=t;let a;function i(e,t,o){!0===o?T(n,this.name,e):e.text=t,e.active=!1,c.cornerstone.updateImage(n)}const r=this.configuration,s=o.canvas,l=b(n,this.name);if(l)for(let o=0;o<l.data.length;o++)if(a=l.data[o],this.pointNearTool(n,a,s))return a.active=!0,c.cornerstone.updateImage(n),r.changeTextCallback(a,t,i),e.stopImmediatePropagation(),e.preventDefault(),void e.stopPropagation()}}const kr=(e,t,n)=>{n(e,prompt("Change your annotation:"))};I("tools:BrushTool");const Or=ot("segmentation");class Lr extends io{constructor(e={}){super(e,{name:"Brush",supportedInteractionTypes:["Mouse","Touch"],configuration:{},mixins:["renderBrushMixin"]}),this.touchDragCallback=this._paint.bind(this)}_paint(e){const{configuration:t}=Or,n=e.detail,{rows:o,columns:a}=(n.element,n.image),{x:i,y:r}=n.currentPoints.image;if(i<0||i>a||r<0||r>o)return;const s=ae(t.radius,o,a,i,r),{labelmap2D:l,labelmap3D:d,shouldErase:u}=this.paintEventData;V(s,l.pixelData,d.activeSegmentIndex,a,u),c.cornerstone.updateImage(e.detail.element)}}const Ar=I("tools:SphericalBrushTool"),Hr=ot("segmentation");class Rr extends io{constructor(e={}){super(e,{name:"SphericalBrush",supportedInteractionTypes:["Mouse","Touch"],configuration:{alwaysEraseOnClick:!1},mixins:["renderBrushMixin"]}),this.touchDragCallback=this._paint.bind(this)}_startPainting(e){const{configuration:t,getters:n}=Hr,o=e.detail,{element:a,image:i}=o,{cornerstone:r}=c,s=t.radius,{rows:l,columns:d}=i,u=Math.max(i.rowPixelSpacing,i.columnPixelSpacing),h=b(a,"stack").data[0],{imageIds:g}=h,{labelmap2D:m,labelmap3D:f,currentImageIdIndex:p,activeLabelmapIndex:v}=n.labelmap2D(a),x=this._isCtrlDown(o)||this.configuration.alwaysEraseOnClick,y=r.metaData.get("imagePlaneModule",i.imageId);let T;if(y){const e=y.imagePositionPatient;T=this._getImagesInRange(p,e,g,s,u)}else Ar.warn("No imagePlane metadata found for image, defaulting to circle brush application."),T=[{imageIdIndex:p,radiusOnImage:s}];if(this.paintEventData={labelmap2D:m,labelmap3D:f,currentImageIdIndex:p,activeLabelmapIndex:v,shouldErase:x,imagesInRange:T},t.storeHistory){const e=[];for(let t=0;t<T.length;t++){const{imageIdIndex:o}=T[t],a=n.labelmap2DByImageIdIndex(f,o,l,d).pixelData.slice();e.push(a)}this.paintEventData.previousPixeldataForImagesInRange=e}}_paint(e){const{getters:t}=Hr,n=e.detail,o=(n.element,n.image),{rows:a,columns:i}=o,{x:r,y:s}=n.currentPoints.image;if(r<0||r>i||s<0||s>a)return;const{labelmap3D:l,imagesInRange:d,shouldErase:u}=this.paintEventData;for(let e=0;e<d.length;e++){const{imageIdIndex:n,radiusOnImage:o}=d[e];V(ae(o,a,i,r,s),t.labelmap2DByImageIdIndex(l,n,a,i).pixelData,l.activeSegmentIndex,i,u)}c.cornerstone.updateImage(e.detail.element)}_getImagesInRange(e,t,n,o,a){const i=o*a,r=[{imageIdIndex:e,radiusOnImage:o}];for(let o=e+1;o<n.length;o++){const e=this._getRadiusOnImage(n[o],t,i,a);if(!e)break;r.push({imageIdIndex:o,radiusOnImage:e})}for(let o=e-1;o>=0;o--){const e=this._getRadiusOnImage(n[o],t,i,a);if(!e)break;r.push({imageIdIndex:o,radiusOnImage:e})}return r}_getRadiusOnImage(e,t,n,o){const a=c.cornerstone.metaData.get("imagePlaneModule",e);if(!a)return void Ar.warn("Can't find imagePlane metadata for image, cancelling spherical brushing on: ".concat(e,","));const i=a.imagePositionPatient,r=Math.sqrt(Math.pow(i[0]-t[0],2)+Math.pow(i[1]-t[1],2)+Math.pow(i[2]-t[2],2));return r>n?void 0:Math.floor(Math.sqrt(Math.pow(n,2)-Math.pow(r,2))/o)}_endPainting(e){const{labelmap3D:t,imagesInRange:n}=this.paintEventData,o=[],{configuration:a,setters:i}=Hr;for(let e=0;e<n.length;e++){const{imageIdIndex:i}=n[e],r=t.labelmaps2D[i],s=new Set(r.pixelData).values(),c=[];let l=!1;for(;!l;){const e=s.next();l=e.done,l||c.push(e.value)}if(r.segmentsOnLabelmap=c,a.storeHistory){const{previousPixeldataForImagesInRange:n}=this.paintEventData,a=n[e],r=t.labelmaps2D[i].pixelData;o.push({imageIdIndex:i,diff:pe(a,r)})}}a.storeHistory&&i.pushState(this.element,o),fe(this.element)}}const Ur=I("util:segmentation:operations:correction");function Fr(e,t){const{pixelData:n,segmentIndex:o,segmentationMixinType:a}=t;if("freehandSegmentationMixin"!==a)return void Ur.error("correction operation requires freehandSegmentationMixin operationData, recieved ".concat(a));const i=function(e,t){const{pixelData:n,points:o}=t,{image:a}=e.detail,i=a.width,r=a.height,s=[];for(let e=0;e<o.length;e++){const t=o[e];let a=Math.floor(t.x),c=Math.floor(t.y);a=ln(a,0,i-1),c=ln(c,0,r-1);const l=s[s.length-1];l&&a===l.x&&c===l.y||s.push({x:a,y:c,segment:n[c*i+a]})}return s}(e,t),r=function(e,t){let n=!0,o=!0;for(let a=0;a<e.length;a++){if(e[a].segment===t?o=!1:n=!1,!n&&!o)break}if(o)return{isScissorOperation:!0,operation:"fillInsideFreehand"};if(n)return{isScissorOperation:!0,operation:"eraseInsideFreehand"};return{isScissorOperation:!1}}(i,o);if(r.isScissorOperation)return void("fillInsideFreehand"===r.operation?(Ur.warn("The line never intersects a segment."),Qr(e,t)):"eraseInsideFreehand"===r.operation&&(Ur.warn("The line is only ever inside the segment."),Wr(e,t)));const s=new Uint8Array(n.length);(function(e,t){let n=e[0].segment===t;const o=[];o.push({additive:!n,nodes:[]});let a=0;for(let i=0;i<e.length;i++){const r=e[i];n?(o[a].nodes.push(r),r.segment!==t&&(a++,n=!n,o.push({additive:!0,nodes:[]}),o[a].nodes.push(e[i-1]),o[a].nodes.push(r))):(o[a].nodes.push(r),r.segment===t&&(a++,n=!n,o.push({additive:!1,nodes:[]}),o[a].nodes.push(e[i-1]),o[a].nodes.push(r)))}return o.pop(),o.shift(),o})(i,o).forEach(t=>{!function(e,t,n,o,a){const{width:i,height:r}=a.detail.image,{nodes:s,additive:c}=e,l=c?0:1,d=e=>e.y*i+e.x;c?Ur.warn("additive operation..."):Ur.warn("subtractive operation...");const{pixelPath:u,leftPath:h,rightPath:g}=function(e){const t=[];for(let n=0;n<e.length-1;n++)t.push(e[n]),t.push(...se(e[n],e[n+1]));t.push[e[e.length-1]];const n=[],o=[];for(let e=0;e<t.length-1;e++){const{left:a,right:i}=Vr(t[e],t[e+1]);n.push(a),o.push(i)}return{pixelPath:t,leftPath:n,rightPath:o}}(s),m=u[0],f={xMin:m.x,xMax:m.x,yMin:m.y,yMax:m.y};for(let e=0;e<n.length;e++)if(t[e]===o){const t={x:(p=e)%i,y:Math.floor(p/i)};Nr(f,t),n[e]=1}else n[e]=0;var p;for(let e=0;e<u.length;e++){const t=u[e];n[d(t)]=2,Nr(f,t)}!function(e,t,n){e.xMax=Math.min(e.xMax+2,n),e.xMin=Math.max(e.xMin-2,0),e.yMax=Math.min(e.yMax+2,t),e.yMin=Math.max(e.yMin-2,0)}(f,r,i);const{xMin:v,xMax:x,yMin:y,yMax:b}=f;function T(e,t){if(!(e>=x||e<v||t>=b||t<y))return n[t*i+e]}let C=0,M=0;for(let e=0;e<h.length;e++){const t=h[e];n[d(t)]===l&&Pe(t,r,i)&&(C+=Br(t,3,n,T,i));const o=g[e];n[d(o)]===l&&Pe(o,r,i)&&(M+=Br(o,4,n,T,i))}if(0===C||0===M)return;const E=c?o:0,w=C<M?3:4;for(let e=0;e<n.length;e++)n[e]===w&&(t[e]=E);if(E===o)for(let e=0;e<u.length;e++)t[d(u[e])]=o;else for(let e=0;e<u.length;e++){const n=d(u[e]);t[n]===o&&(t[n]=0)}}(t,n,s,o,e)})}function Nr(e,t){const{x:n,y:o}=t;n<e.xMin&&(e.xMin=n),n>e.xMax&&(e.xMax=n),o<e.yMin&&(e.yMin=o),o>e.yMax&&(e.yMax=o)}function Br(e,t,n,o,a){const i=J(o,[e.x,e.y]).flooded;for(let e=0;e<i.length;e++){const o=i[e];n[o[1]*a+o[0]]=t}return i.length}function Vr(e,t){const n={x:t.x-e.x,y:t.y-e.y};return-1===n.x&&1===n.y?{left:{x:e.x-1,y:e.y-1},right:{x:e.x+1,y:e.y+1}}:0===n.x&&1===n.y?{left:{x:e.x-1,y:e.y},right:{x:e.x+1,y:e.y}}:1===n.x&&1===n.y?{left:{x:e.x-1,y:e.y+1},right:{x:e.x+1,y:e.y-1}}:1===n.x&&0===n.y?{left:{x:e.x,y:e.y+1},right:{x:e.x,y:e.y-1}}:1===n.x&&-1===n.y?{left:{x:e.x+1,y:e.y+1},right:{x:e.x-1,y:e.y-1}}:0===n.x&&-1===n.y?{left:{x:e.x+1,y:e.y},right:{x:e.x-1,y:e.y}}:-1===n.x&&-1===n.y?{left:{x:e.x+1,y:e.y-1},right:{x:e.x-1,y:e.y+1}}:-1===n.x&&0===n.y?{left:{x:e.x,y:e.y-1},right:{x:e.x,y:e.y+1}}:void Ur.error("Unable to find left and right paths for flood fill ",e,t,n)}function zr(e,t){const n=e[0],o=e[1];let a=!1;for(let e=0,i=t.length-1;e<t.length;i=e++){const r=t[e][0],s=t[e][1],c=t[i][0],l=t[i][1];s>o!=l>o&&n<(c-r)*(o-s)/(l-s)+r&&(a=!a)}return a}const jr=I("util:segmentation:operations:eraseInsideFreehand");function qr(e,t,n=!0){const{points:o,segmentationMixinType:a}=t;if("freehandSegmentationMixin"!==a)return void jr.error("eraseInsideFreehand operation requires freehandSegmentationMixin operationData, recieved ".concat(a));const{image:i}=e.detail,r=o.map(e=>[e.x,e.y]),[s,c]=oe(r,i);n?W(e,t,e=>zr([e.x,e.y],r),s,c):G(e,t,e=>zr([e.x,e.y],r),s,c)}function Wr(e,t){qr(e,t,!0)}function Gr(e,t){qr(e,t,!1)}const Yr=I("util:segmentation:operations:eraseInsideRectangle");function Xr(e,t,n=!0){const{points:o,segmentationMixinType:a}=t;if("rectangleSegmentationMixin"!==a)return void Yr.error("eraseInsideRectangle operation requires rectangleSegmentationMixin operationData, recieved ".concat(a));const i=e.detail,{image:r}=i,s=o.map(e=>[e.x,e.y]),[c,l]=oe(s,r);n?W(e,t,()=>!0,c,l):z(e,t,c,l)}function Kr(e,t){Xr(e,t,!0)}function Zr(e,t){Xr(e,t,!1)}const $r=I("util:segmentation:operations:fillInsideFreehand");function Jr(e,t,n=!0){const{points:o,segmentationMixinType:a}=t;if("freehandSegmentationMixin"!==a)return void $r.error("eraseInsideFreehand operation requires freehandSegmentationMixin operationData, recieved ".concat(a));const{image:i}=e.detail,r=o.map(e=>[e.x,e.y]),[s,c]=oe(r,i);n?Z(e,t,e=>zr([e.x,e.y],r),s,c):$(e,t,e=>zr([e.x,e.y],r),s,c)}function Qr(e,t){Jr(e,t,!0)}function es(e,t){Jr(e,t,!1)}const ts=I("util:segmentation:operations:fillInsideRectangle");function ns(e,t,n=!0){const{points:o,segmentationMixinType:a}=t;if("rectangleSegmentationMixin"!==a)return void ts.error("eraseInsideRectangle operation requires rectangleSegmentationMixin operationData, recieved ".concat(a));const{image:i}=e.detail,r=o.map(e=>[e.x,e.y]),[s,c]=oe(r,i);n?Z(e,t,()=>!0,s,c):Y(e,t,s,c)}function os(e,t){ns(e,t,!0)}function as(e,t){ns(e,t,!1)}const is=I("util:segmentation:operations:fillCircle");function rs(e,t,n=!0){const{segmentationMixinType:o}=t;if("circleSegmentationMixin"!==o)return void is.error("fillInsideCircle operation requires circleSegmentationMixin operationData, recieved ".concat(o));const a=e.detail,[i,r]=ne(e),s=te(a.handles.start,a.handles.end);n?Z(e,t,e=>_i(s,e),i,r):$(e,t,e=>_i(s,e),i,r)}function ss(e,t){rs(e,t,!0)}function cs(e,t){rs(e,t,!1)}const ls=I("util:segmentation:operations:eraseInsideCircle");function ds(e,t,n=!0){const{segmentationMixinType:o}=t;if("circleSegmentationMixin"!==o)return void ls.error("eraseInsideCircle operation requires circleSegmentationMixin operationData, recieved ".concat(o));const a=e.detail,[i,r]=ne(e),s=te(a.handles.start,a.handles.end);n?W(e,t,e=>_i(s,e),i,r):G(e,t,e=>_i(s,e),i,r)}function us(e,t){ds(e,t,!0)}function hs(e,t){ds(e,t,!1)}class gs extends Yn{constructor(e={}){super(e,{name:"FreehandScissors",strategies:{FILL_INSIDE:Qr,FILL_OUTSIDE:es,ERASE_OUTSIDE:Gr,ERASE_INSIDE:Wr},cursors:{FILL_INSIDE:ba,FILL_OUTSIDE:Ca,ERASE_OUTSIDE:Ta,ERASE_INSIDE:ya},defaultStrategy:"FILL_INSIDE",supportedInteractionTypes:["Mouse","Touch"],svgCursor:ba,mixins:["freehandSegmentationMixin"]})}}class ms extends Yn{constructor(e={}){super(e,{name:"RectangleScissors",strategies:{FILL_INSIDE:os,FILL_OUTSIDE:as,ERASE_OUTSIDE:Zr,ERASE_INSIDE:Kr},cursors:{FILL_INSIDE:Ea,FILL_OUTSIDE:Ia,ERASE_OUTSIDE:wa,ERASE_INSIDE:Ma},defaultStrategy:"FILL_INSIDE",supportedInteractionTypes:["Mouse","Touch"],mixins:["rectangleSegmentationMixin"]})}}class fs extends Yn{constructor(e={}){super(e,{name:"CircleScissors",strategies:{FILL_INSIDE:ss,FILL_OUTSIDE:cs,ERASE_OUTSIDE:hs,ERASE_INSIDE:us},cursors:{FILL_INSIDE:_a,FILL_OUTSIDE:Da,ERASE_OUTSIDE:Pa,ERASE_INSIDE:Sa},defaultStrategy:"FILL_INSIDE",supportedInteractionTypes:["Mouse","Touch"],svgCursor:_a,mixins:["circleSegmentationMixin"]})}}class ps extends Yn{constructor(e={}){super(e,{name:"CorrectionScissors",strategies:{CORRECTION:Fr},cursors:{CORRECTION:ba},defaultStrategy:"CORRECTION",supportedInteractionTypes:["Mouse","Touch"],svgCursor:ba,mixins:["polylineSegmentationMixin"]})}}const vs={},xs={},ys={};function bs(e){if(!e)return"DEFAULT";const t=c.cornerstone.getEnabledElement(e).uuid;if(!t)throw new Error("Something went wrong when getting uuid from element");return t}var Ts={setStartLoadHandler:function(e,t){if(!e)throw new Error("The Handler function must be defined");const n=bs(t);vs[n]=e},getStartLoadHandler:function(e){const t=bs(e);return vs[t]||vs.DEFAULT},setEndLoadHandler:function(e,t){if(!e)throw new Error("The Handler function must be defined");const n=bs(t);xs[n]=e},getEndLoadHandler:function(e){const t=bs(e);return xs[t]||xs.DEFAULT},setErrorLoadingHandler:function(e,t){if(!e)throw new Error("The Handler function must be defined");const n=bs(t);ys[n]=e},getErrorLoadingHandler:function(e){const t=bs(e);return ys[t]||ys.DEFAULT},removeHandlers:function(e){const t=bs(e);delete vs[t],delete xs[t],delete ys[t]}};const Cs={};function Ms(e,t){if(!Cs[e])return{};const n=Cs[e].find(e=>e.element===t);return n?n.options:{}}function Es(e,t,n){if(!Cs[e])return void(Cs[e]=[{element:t,options:n}]);const o=Cs[e].findIndex(e=>e.element===t);if(-1===o)Cs[e].push({element:t,options:n});else{const t=Cs[e][o].options||{};Cs[e][o].options=Object.assign(t,n)}}class ws extends Yn{constructor(e={}){super(e,{name:"Crosshairs",supportedInteractionTypes:["Mouse","Touch"],svgCursor:aa}),this.preMouseDownCallback=this._chooseLocation.bind(this),this.mouseDragCallback=this._chooseLocation.bind(this),this.touchDragCallback=this._chooseLocation.bind(this)}_chooseLocation(e){const t=e.detail,{element:n}=t;e.stopImmediatePropagation();const o=b(n,this.name);if(!o)return;const a=n,i=c.cornerstone.getEnabledElement(a).image.imageId,r=c.cornerstone.metaData.get("imagePlaneModule",i);if(!r)return;const s=Nt(t.currentPoints.image,r);o.data[0].synchronizationContext.getSourceElements().forEach((function(e){if(e===a)return;let t=Number.MAX_VALUE,n=-1;const o=b(e,"stack");if(void 0===o)return;const i=o.data[0];if(i.imageIds.forEach((function(e,o){const a=c.cornerstone.metaData.get("imagePlaneModule",e);if(!(a&&a.imagePositionPatient&&a.rowCosines&&a.columnCosines))return;const i=Ut(a.imagePositionPatient),r=Ut(a.rowCosines),l=Ut(a.columnCosines).clone().cross(r.clone()),d=Math.abs(l.clone().dot(i)-l.clone().dot(s));d<t&&(t=d,n=o)})),n!==i.currentImageIdIndex&&-1!==n&&void 0!==i.imageIds[n]){const t=Ts.getStartLoadHandler(e),o=Ts.getEndLoadHandler(e),a=Ts.getErrorLoadingHandler(e);let r;t&&t(e),r=!0===i.preventCache?c.cornerstone.loadImage(i.imageIds[n]):c.cornerstone.loadAndCacheImage(i.imageIds[n]),r.then((function(t){const a=c.cornerstone.getViewport(e);i.currentImageIdIndex=n,c.cornerstone.displayImage(e,t,a),o&&o(e,t)}),(function(t){const o=i.imageIds[n];a&&a(e,o,t)}))}}))}activeCallback(e,{mouseButtonMask:t,synchronizationContext:n}){Es(this.name,e,{mouseButtonMask:t}),C(e,this.name),y(e,this.name,{synchronizationContext:n})}}class Is extends Yn{constructor(e={}){super(e,{name:"DoubleTapFitToWindow",supportedInteractionTypes:["DoubleTap"]})}doubleTapCallback(e){const t=e.detail;c.cornerstone.fitToWindow(t.element)}}class Ss extends Yn{constructor(e={}){super(e,{name:"DragProbe",strategies:{default:_s,minimal:Ps},defaultStrategy:"default",supportedInteractionTypes:["Mouse","Touch"],svgCursor:ta}),this.touchDragCallback=this._movingEventCallback.bind(this),this.touchEndCallback=this._endMovingEventCallback.bind(this),this.mouseDragCallback=this._movingEventCallback.bind(this),this.mouseUpCallback=this._endMovingEventCallback.bind(this),this.dragEventData={}}_movingEventCallback(e){const t=e.detail,{element:n}=t;this.dragEventData=t,c.cornerstone.updateImage(n)}_endMovingEventCallback(e){const t=e.detail,{element:n}=t;this.dragEventData={},c.cornerstone.updateImage(n)}renderToolData(e){this.dragEventData.currentPoints&&e&&e.detail&&Boolean(Object.keys(this.dragEventData.currentPoints).length)&&(e.detail.currentPoints=this.dragEventData.currentPoints,this.applyActiveStrategy(e))}}function _s(e){const t=this.configuration,n=c.cornerstone,o=e.detail,{element:a,image:i,currentPoints:r,canvasContext:s}=o,l=hn(s.canvas),d=Gt.getActiveColor(),u=Qt.getFontSize(),h=Math.round(r.image.x),g=Math.round(r.image.y);h<0||g<0||h>=i.columns||g>=i.rows||_t(l,e=>{mn(e,t);const o="".concat(h,", ").concat(g);let s,c;if(i.color)s=Tr(a,h,g,1,1),c="R: ".concat(s[0]," G: ").concat(s[1]," B: ").concat(s[2]," A: ").concat(s[3]);else{s=n.getStoredPixels(a,h,g,1,1);const e=s[0],t=e*i.slope+i.intercept,o=Ii(i,e);c="SP: ".concat(e," MO: ").concat(parseFloat(t.toFixed(3))),o&&(c+=" SUV: ".concat(parseFloat(o.toFixed(3))))}const l={x:r.canvas.x+5,y:r.canvas.y-5};on(e,c,l.x,l.y+u+5,d),on(e,o,l.x,l.y,d)})}function Ps(e){const t=this.configuration,n=c.cornerstone,o=e.detail,{element:a,image:i,currentPoints:r,canvasContext:s,isTouchEvent:l}=o,d=hn(s.canvas),u=Gt.getActiveColor();let h=r.page.y-Qt.getFontSize()/2;l&&(h=r.page.y-4*Qt.getFontSize());const g=n.pageToPixel(a,r.page.x,h);g.x<0||g.y<0||g.x>=i.columns||g.y>=i.rows||_t(d,e=>{mn(e,t);const o=n.metaData.get("generalSeriesModule",i.imageId),r=o&&o.modality;let s,c="";if(i.color)s=Tr(a,g.x,g.y,1,1),c="R: ".concat(s[0]," G: ").concat(s[1]," B: ").concat(s[2]);else{s=n.getStoredPixels(a,g.x,g.y,1,1);const e=s[0],t=e*i.slope+i.intercept,o=parseFloat(t.toFixed(2));if("CT"===r)c+="HU: ".concat(o);else if("PT"===r){c+=o;const t=Ii(i,e);t&&(c+=" SUV: ".concat(parseFloat(t.toFixed(2))))}else c+=o}const d=n.pixelToCanvas(a,g);let h={x:12,y:-(Qt.getFontSize()+10)/2};const m=nn(e,c,5);l&&(h={x:-m/2,y:-Qt.getFontSize()-10-12}),Rt(e,a,d,6,{color:u},"canvas"),on(e,c,d.x+h.x,d.y+h.y,u)})}class Ds extends Yn{constructor(e={}){super(e,{name:"Eraser",supportedInteractionTypes:["Mouse","Touch"],svgCursor:ia}),this.preMouseDownCallback=this._deleteAllNearbyTools.bind(this),this.preTouchStartCallback=this._deleteAllNearbyTools.bind(this)}_deleteAllNearbyTools(e){const t=e.detail.currentPoints.canvas,n=e.detail.element;et.tools.forEach((function(e){const o=b(n,e.name);o&&o.data.forEach((function(o){"function"==typeof e.pointNearTool&&e.pointNearTool(n,o,t)&&(T(n,e.name,o),c.cornerstone.updateImage(n))}))}));return!0}}const{FreehandHandleData:ks}=dr;class Os extends Yn{constructor(e={}){super(e,{name:"FreehandRoiSculptor",referencedToolName:"FreehandRoi",supportedInteractionTypes:["Mouse","Touch","DoubleTap"],mixins:["activeOrDisabledBinaryTool"],configuration:{mouseLocation:{handles:{start:{highlight:!0,active:!0}}},minSpacing:1,currentTool:null,dragColor:Gt.getActiveColor(),hoverColor:Gt.getToolColor(),showCursorOnHover:!0,limitRadiusOutsideRegion:!0,hoverCursorFadeAlpha:.5,hoverCursorFadeDistance:1.2},svgCursor:Qo}),this.updateOnMouseMove=!0,this.isMultiPartTool=!0,this.referencedToolName=this.initialConfiguration.referencedToolName,this._active=!1,this.activeMouseUpCallback=this.activeMouseUpCallback.bind(this),this.activeTouchEndCallback=this.activeTouchEndCallback.bind(this),this.activeMouseDragCallback=this.activeMouseDragCallback.bind(this)}renderToolData(e){const t=e.detail;if(null===this.configuration.currentTool)return!1;const n=t.element,o=this.configuration;if(!b(n,this.referencedToolName).data[o.currentTool])return!1;if(this._active){const e=t.canvasContext.canvas.getContext("2d"),n={color:this.configuration.dragColor,fill:null,handleRadius:this._toolSizeCanvas};Yt(e,t,this.configuration.mouseLocation.handles,n)}else this.configuration.showCursorOnHover&&!this._recentTouchEnd&&this._renderHoverCursor(e)}doubleClickCallback(e){const t=e.detail;this._selectFreehandTool(t),c.cornerstone.updateImage(t.element)}doubleTapCallback(e){const t=e.detail;this._selectFreehandTool(t),c.cornerstone.updateImage(t.element)}preTouchStartCallback(e){return this._initialiseSculpting(e),!0}preMouseDownCallback(e){if(this.options.mouseButtonMask.includes(e.detail.buttons))return this._initialiseSculpting(e),!0}activeMouseDragCallback(e){const t=this.configuration;if(!this._active)return;const n=e.detail,o=b(n.element,this.referencedToolName);if(!o)return;const a=o.data[t.currentTool].handles.points;this._getMouseLocation(n),this._sculpt(n,a),c.cornerstone.updateImage(n.element)}activeMouseUpCallback(e){this._activeEnd(e)}activeTouchEndCallback(e){this._activeEnd(e),this._deselectAllTools(e),this._recentTouchEnd=!0}_activeEnd(e){const t=e.detail,n=t.element,o=this.configuration;this._active=!1,et.isMultiPartToolActive=!1,this._getMouseLocation(t),this._invalidateToolData(t),o.mouseUpRender=!0,this._deactivateSculpt(n),c.cornerstone.updateImage(t.element),function(e){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()}(e)}_renderHoverCursor(e){const t=e.detail,n=t.element,o=t.canvasContext.canvas.getContext("2d"),a=b(n,this.referencedToolName).data[this.configuration.currentTool];let i;this._recentTouchEnd=!1,this.configuration.mouseUpRender?(i=this.configuration.mouseLocation.handles.start,this.configuration.mouseUpRender=!1):i=et.mousePositionImage;let r=it(n,this.referencedToolName).distanceFromPointCanvas(n,a,i);if(this.configuration.mouseLocation.handles.start.x=i.x,this.configuration.mouseLocation.handles.start.y=i.y,this.configuration.limitRadiusOutsideRegion){const e=r;r=this._limitCursorRadiusCanvas(t,r),e>this.configuration.hoverCursorFadeDistance*r&&(o.globalAlpha=this.configuration.hoverCursorFadeAlpha)}const s={fill:null,color:this.configuration.hoverColor,handleRadius:r};Yt(o,t,this.configuration.mouseLocation.handles,s),this.configuration.limitRadiusOutsideRegion&&(o.globalAlpha=1)}newImageCallback(e){this._deselectAllTools(e)}enabledCallback(e){this._deselectAllTools(e)}passiveCallback(e){this._deselectAllTools(e)}disabledCallback(e){this._deselectAllTools(e)}_selectFreehandTool(e){const t=this.configuration,n=e.element,o=this._getClosestFreehandToolOnElement(n,e);void 0!==o&&(t.currentTool=o,ct(n))}_activateFreehandTool(e,t){const n=b(e,this.referencedToolName).data;this.configuration.currentTool=t;for(let e=0;e<n.length;e++)n[e].active=e===t}_initialiseSculpting(e){const t=e.detail,n=this.configuration,o=t.element;null===n.currentTool&&(this._selectFreehandTool(t),null===n.currentTool)||(this._active=!0,et.isMultiPartToolActive=!0,this._configureToolSize(t),this._getMouseLocation(t),this._activateFreehandTool(o,n.currentTool),this._activateSculpt(o),c.cornerstone.updateImage(t.element))}_sculpt(e,t){const n=this.configuration;this._sculptData={element:e.element,image:e.image,mousePoint:e.currentPoints.image,points:t,toolSize:this._toolSizeImage,minSpacing:n.minSpacing,maxSpacing:Math.max(this._toolSizeImage,2*n.minSpacing)};const o=this._pushHandles();void 0!==o.first&&(this._insertNewHandles(o),this._consolidateHandles())}_pushHandles(){const{points:e,mousePoint:t,toolSize:n}=this._sculptData,o={};for(let a=0;a<e.length;a++){const i=c.cornerstoneMath.point.distance(e[a],t);i>n||(this._pushOneHandle(a,i),void 0===o.first?(o.first=a,o.last=a):o.last=a)}return o}_pushOneHandle(e,t){const{points:n,mousePoint:o,toolSize:a,image:i}=this._sculptData,r=n[e],s=(r.x-o.x)/t,c=(r.y-o.y)/t,l={x:o.x+a*s,y:o.y+a*c};rn(l,i),r.x=l.x,r.y=l.y;const d=this.constructor._getPreviousHandleIndex(e,n.length);n[d].lines.pop(),n[d].lines.push(r)}_insertNewHandles(e){const t=this._findNewHandleIndicies(e);let n=0;for(let e=0;e<t.length;e++){const o=t[e]+1+n;this._insertHandleRadially(o),n++}}_findNewHandleIndicies(e){const{points:t,maxSpacing:n}=this._sculptData,o=[];for(let a=e.first;a<=e.last;a++)this._checkSpacing(a,t,o,n);const a=this.constructor._getNextHandleIndex(e.last,t.length);if(a!==e.first){this._checkSpacing(a,t,o,n);const i=this.constructor._getPreviousHandleIndex(e.first,t.length);i!==a&&this._checkSpacing(i,t,o,n)}return o}_checkSpacing(e,t,n,o){const a=this.constructor._getNextHandleIndex(e,t.length);c.cornerstoneMath.point.distance(t[e],t[a])>o&&n.push(e)}_insertHandleRadially(e){const{points:t}=this._sculptData,n=e-1,o=this.constructor._getNextHandleIndexBeforeInsert(e,t.length),a=this._getInsertPosition(e,n,o),i=new ks(a);t.splice(e,0,i),t[n].lines.pop(),t[n].lines.push(t[e]),dr.addLine(t,e)}_consolidateHandles(){const{points:e}=this._sculptData;if(e.length<=3)return;const t=this._findCloseHandlePairs();this._mergeCloseHandles(t)}_findCloseHandlePairs(){const{points:e,minSpacing:t}=this._sculptData,n=[];let o=e.length;for(let a=0;a<o;a++){const i=this.constructor._getNextHandleIndex(a,e.length);if(c.cornerstoneMath.point.distance(e[a],e[i])<t){const e=[a,i];n.push(e),0===a&&(o-=1),a++}}return n}_mergeCloseHandles(e){let t=0;for(let n=0;n<e.length;n++){const o=this.constructor._getCorrectedPair(e[n],t);this._combineHandles(o),t++}const n=this._findCloseHandlePairs();n.length&&this._mergeCloseHandles(n)}_combineHandles(e){const{points:t,image:n}=this._sculptData,o={x:(t[e[0]].x+t[e[1]].x)/2,y:(t[e[0]].y+t[e[1]].y)/2};rn(o,n),t[e[0]].x=o.x,t[e[0]].y=o.y;const a=this.constructor._getNextHandleIndex(e[1],t.length);t[e[0]].lines.pop(),t[e[0]].lines.push(t[a]),t.splice(e[1],1)}_configureToolSize(e){const t=e.element,n=this.configuration,o=n.currentTool,a=e.currentPoints.image,i=b(t,this.referencedToolName).data[o],r=it(t,this.referencedToolName);let s=r.distanceFromPoint(t,i,a),c=r.distanceFromPointCanvas(t,i,a);n.limitRadiusOutsideRegion&&(s=this._limitCursorRadiusImage(e,s),c=this._limitCursorRadiusCanvas(e,c)),this._toolSizeImage=s,this._toolSizeCanvas=c}_getMouseLocation(e){const t=this.configuration;t.mouseLocation.handles.start.x=e.currentPoints.image.x,t.mouseLocation.handles.start.y=e.currentPoints.image.y,rn(t.mouseLocation.handles.start,e.image)}_activateSculpt(e){this._deactivateSculpt(e),e.addEventListener(l.MOUSE_UP,this.activeMouseUpCallback),e.addEventListener(l.MOUSE_CLICK,this.activeMouseUpCallback),e.addEventListener(l.MOUSE_DRAG,this.activeMouseDragCallback),e.addEventListener(l.TOUCH_END,this.activeTouchEndCallback),e.addEventListener(l.TOUCH_TAP,this.activeTouchEndCallback),e.addEventListener(l.TOUCH_DRAG,this.activeMouseDragCallback),c.cornerstone.updateImage(e)}_deactivateSculpt(e){e.removeEventListener(l.MOUSE_UP,this.activeMouseUpCallback),e.removeEventListener(l.MOUSE_CLICK,this.activeMouseUpCallback),e.removeEventListener(l.MOUSE_DRAG,this.activeMouseDragCallback),e.removeEventListener(l.TOUCH_END,this.activeTouchEndCallback),e.removeEventListener(l.TOUCH_TAP,this.activeTouchEndCallback),e.removeEventListener(l.TOUCH_DRAG,this.activeMouseDragCallback),c.cornerstone.updateImage(e)}_invalidateToolData(e){const t=this.configuration;b(e.element,this.referencedToolName).data[t.currentTool].invalidated=!0}_deselectAllTools(e){const t=this.configuration,n=b(this.element,this.referencedToolName);if(t.currentTool=null,n)for(let e=0;e<n.data.length;e++)n.data[e].active=!1;st(this.element,this.svgCursor),c.cornerstone.updateImage(this.element)}static _getCorrectedPair(e,t){const n=[e[0]-t,e[1]-t];return n[1]<0&&(n[1]=0),n}_limitCursorRadiusCanvas(e,t){return this._limitCursorRadius(e,t,!0)}_limitCursorRadiusImage(e,t){return this._limitCursorRadius(e,t,!1)}_limitCursorRadius(e,t,n=!1){const o=e.element,a=e.image,i=this.configuration,r=b(o,this.referencedToolName).data[i.currentTool];let s=1;if(n){const e=c.cornerstone.pixelToCanvas(o,{x:0,y:0}),t=c.cornerstone.pixelToCanvas(o,{x:a.width,y:a.height});s=(t.x-e.x)*(t.y-e.y)/(a.width*a.height)}const l=r.area*s,d=Math.pow(l/Math.PI,.5);return Math.min(t,d)}_getClosestFreehandToolOnElement(e,t){const n=it(e,this.referencedToolName),o=b(e,this.referencedToolName);if(!o)return;const a=o.data,i=t.currentPoints.image,r={distance:1/0,toolIndex:null};for(let t=0;t<a.length;t++){const o=n.distanceFromPoint(e,a[t],i);-1!==o&&(o<r.distance&&(r.distance=o,r.toolIndex=t))}return r.toolIndex}static _getNextHandleIndex(e,t){return e===t-1?0:e+1}static _getPreviousHandleIndex(e,t){return 0===e?t-1:e-1}static _getNextHandleIndexBeforeInsert(e,t){return e===t?0:e}_getInsertPosition(e,t,n){const{points:o,toolSize:a,mousePoint:i,image:r}=this._sculptData,s={x:(o[t].x+o[n].x)/2,y:(o[t].y+o[n].y)/2},l=c.cornerstoneMath.point.distance(i,s);let d;if(l<a){const e={x:(s.x-i.x)/l,y:(s.y-i.y)/l};d={x:i.x+a*e.x,y:i.y+a*e.y}}else d=s;return rn(d,r),d}get minSpacing(){return this.configuration.minSpacing}set minSpacing(e){if("number"!=typeof e)throw new Error("Attempting to set freehandSculpter minSpacing to a value other than a number.");this.configuration.minSpacing=e}get maxSpacing(){return this.configuration.maxSpacing}set maxSpacing(e){if("number"!=typeof e)throw new Error("Attempting to set freehandSculpter maxSpacing to a value other than a number.");this.configuration.maxSpacing=e}get showCursorOnHover(){return this.configuration.showCursorOnHover}set showCursorOnHover(e){if("boolean"!=typeof e)throw new Error("Attempting to set freehandSculpter showCursorOnHover to a value other than a boolean.");this.configuration.showCursorOnHover=e,c.cornerstone.updateImage(this.element)}get limitRadiusOutsideRegion(){return this.configuration.limitRadiusOutsideRegion}set limitRadiusOutsideRegion(e){if("boolean"!=typeof e)throw new Error("Attempting to set freehandSculpter limitRadiusOutsideRegion to a value other than a boolean.");this.configuration.limitRadiusOutsideRegion=e,c.cornerstone.updateImage(this.element)}get hoverCursorFadeAlpha(){return this.configuration.hoverCursorFadeAlpha}set hoverCursorFadeAlpha(e){if("number"!=typeof e)throw new Error("Attempting to set freehandSculpter hoverCursorFadeAlpha to a value other than a number.");e=Math.max(Math.min(e,1),0),this.configuration.hoverCursorFadeAlpha=e,c.cornerstone.updateImage(this.element)}get hoverCursorFadeDistance(){return this.configuration.hoverCursorFadeDistance}set hoverCursorFadeDistance(e){if("number"!=typeof e)throw new Error("Attempting to set freehandSculpter hoverCursorFadeDistance to a value other than a number.");e=Math.max(e,1),this.configuration.hoverCursorFadeDistance=e,c.cornerstone.updateImage(this.element)}}class Ls extends Yn{constructor(e={}){super(e,{name:"Magnify",supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:300,magnificationLevel:2},svgCursor:ra}),this.zoomCanvas=void 0,this.zoomElement=void 0,this.activeCallback=this._createMagnificationCanvas.bind(this),this.enabledCallback=this._createMagnificationCanvas.bind(this),this.disabledCallback=this._destroyMagnificationCanvas.bind(this),this.postTouchStartCallback=this._addMagnifyingGlass.bind(this),this.touchDragCallback=this._updateMagnifyingGlass.bind(this),this.touchEndCallback=this._removeMagnifyingGlass.bind(this),this.touchDragEndCallback=this._removeMagnifyingGlass.bind(this),this.postMouseDownCallback=this._addMagnifyingGlass.bind(this),this.mouseDragCallback=this._updateMagnifyingGlass.bind(this),this.mouseUpCallback=this._removeMagnifyingGlass.bind(this),this.mouseClickCallback=this._removeMagnifyingGlass.bind(this),this.newImageCallback=this._drawMagnificationTool.bind(this)}_addMagnifyingGlass(e){this._removeZoomElement(),this._drawZoomedElement(e),window.requestAnimationFrame(()=>this._drawMagnificationTool(e)),ct(e.detail.element),e.preventDefault(),e.stopPropagation()}_updateMagnifyingGlass(e){this._drawMagnificationTool(e),e.preventDefault(),e.stopPropagation()}_removeMagnifyingGlass(e){const t=e.detail.element;st(this.element,this.svgCursor),t.querySelector(".magnifyTool").style.display="none",this._removeZoomElement()}_drawMagnificationTool(e){const t=e.detail.element,n=t.querySelector(".magnifyTool");if(n||this._createMagnificationCanvas(t),void 0===this.zoomCanvas)return;const o=t.querySelector("canvas:not(.magnifyTool)"),a=hn(n),i=c.cornerstone.pixelToCanvas(e.detail.element,e.detail.currentPoints.image),r=Math.min(this.configuration.magnifySize,o.width,o.height),s=this.configuration.magnificationLevel;n.width=r,n.height=r,i.x=Math.max(i.x,.5*r/s),i.x=Math.min(i.x,o.width-.5*r/s),i.y=Math.max(i.y,.5*r/s),i.y=Math.min(i.y,o.height-.5*r/s);const l={x:i.x*s-.5*r,y:i.y*s-.5*r};l.x=Math.max(l.x,0),l.y=Math.max(l.y,0),a.drawImage(this.zoomCanvas,l.x,l.y,r,r,0,0,r,r);const d=e.detail.isTouchEvent?120:0,u={top:Math.max(i.y-.5*r-d,0),left:Math.max(i.x-.5*r,0)},h=n.getBoundingClientRect();u.top=Math.min(u.top,o.height-h.height),u.left=Math.min(u.left,o.width-h.width),n.style.top="".concat(u.top,"px"),n.style.left="".concat(u.left,"px"),n.style.display="block"}_drawZoomedElement(e){const t=e.detail.element;let n=e.detail.enabledElement;void 0===n&&(n=c.cornerstone.getEnabledElement(t));const o=this.configuration.magnificationLevel,a=n.canvas,i=n.image;this.zoomElement||(this.zoomElement=document.createElement("div"),this.zoomElement.width=a.width*o,this.zoomElement.height=a.height*o,c.cornerstone.enable(this.zoomElement,n.options));const r=c.cornerstone.getEnabledElement(this.zoomElement),s=c.cornerstone.getViewport(n.element);this.zoomCanvas=r.canvas,this.zoomCanvas.width=a.width*o,this.zoomCanvas.height=a.height*o,r.viewport=Object.assign({},s),s.scale*=o,c.cornerstone.displayImage(this.zoomElement,i),c.cornerstone.setViewport(this.zoomElement,s)}_removeZoomElement(){void 0!==this.zoomElement&&(c.cornerstone.disable(this.zoomElement),this.zoomElement=void 0,this.zoomCanvas=void 0)}_createMagnificationCanvas(e){if(null===e.querySelector(".magnifyTool")){const t=document.createElement("canvas");t.classList.add("magnifyTool"),t.width=this.configuration.magnifySize,t.height=this.configuration.magnifySize,t.style.position="absolute",t.style.display="none",e.appendChild(t)}}_destroyMagnificationCanvas(e){const t=e.querySelector(".magnifyTool");t&&e.removeChild(t)}}const As=nt.globalConfiguration;class Hs extends Yn{constructor(e={}){const t=Object.assign({name:"Overlay",configuration:{},mixins:["enabledOrDisabledBinaryTool"]},e);super(t),this.initialConfiguration=t}enabledCallback(e){this.forceImageUpdate(e)}disabledCallback(e){this.forceImageUpdate(e)}forceImageUpdate(e){c.cornerstone.getEnabledElement(e).image&&c.cornerstone.updateImage(e)}setupRender(e){if(!e)return;const t=c.cornerstone.metaData.get("overlayPlaneModule",e.imageId);return t&&t.overlays&&t.overlays.length?t:void 0}setupViewport(e){if(void 0===e.overlayColor&&(e.overlayColor=As.configuration.overlayColor||"white"),!1!==e.overlayColor)return!0}renderToolData(e){const t=e.detail,{enabledElement:n,image:o,viewport:a,canvasContext:i}=t,r=this.setupRender(o);if(!t||!n||!r)return;if(!this.setupViewport(a))return;const s=o.columns,c=o.rows;r.overlays.forEach(e=>{if(!1===e.visible)return;const t=document.createElement("canvas");t.width=s,t.height=c;const n=t.getContext("2d");n.fillStyle=e.fillStyle||a.overlayColor,"R"===e.type&&(n.fillRect(0,0,t.width,t.height),n.globalCompositeOperation="xor");let o=0;for(let t=0;t<e.rows;t++)for(let a=0;a<e.columns;a++)e.pixelData[o++]>0&&n.fillRect(a,t,1,1);const r=!isNaN(parseFloat(e.x))&&isFinite(e.x)?e.x:0,l=!isNaN(parseFloat(e.y))&&isFinite(e.y)?e.y:0;i.drawImage(t,r,l)})}}var Rs={getOrientationString:function(e){const t=Ut(e);let n="";const o=t.x<0?"R":"L",a=t.y<0?"A":"P",i=t.z<0?"F":"H",r=new c.cornerstoneMath.Vector3(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),s=1e-4;for(let e=0;e<3;e++)if(r.x>s&&r.x>r.y&&r.x>r.z)n+=o,r.x=0;else if(r.y>s&&r.y>r.x&&r.y>r.z)n+=a,r.y=0;else if(r.z>s&&r.z>r.x&&r.z>r.y)n+=i,r.z=0;else if(r.x>s&&r.y>s&&r.x===r.y)n+=o+a,r.x=0,r.y=0;else if(r.x>s&&r.z>s&&r.x===r.z)n+=o+i,r.x=0,r.z=0;else{if(!(r.y>s&&r.z>s&&r.y===r.z))break;n+=a+i,r.y=0,r.z=0}return n},invertOrientationString:function(e){let t=e.replace("H","f");return t=t.replace("F","h"),t=t.replace("R","l"),t=t.replace("L","r"),t=t.replace("A","p"),t=t.replace("P","a"),t=t.toUpperCase(),t}};class Us extends Yn{constructor(e={}){super(e,{name:"OrientationMarkers",configuration:{drawAllMarkers:!0},mixins:["enabledOrDisabledBinaryTool"]})}enabledCallback(e){this.forceImageUpdate(e)}disabledCallback(e){this.forceImageUpdate(e)}forceImageUpdate(e){const t=c.cornerstone;t.getEnabledElement(e).image&&t.updateImage(e)}renderToolData(e){const t=e.detail,n=hn(t.canvasContext.canvas),o=t.element,a=Bs(o);if(!a)return;const i=Vs(o,a),r=Gt.getToolColor(),s={top:nn(n,a.top,0),left:nn(n,a.left,0),right:nn(n,a.right,0),bottom:nn(n,a.bottom,0),height:nn(n,"M",0)};Fs(n,a,i,s,r),this.configuration.drawAllMarkers&&Ns(n,a,i,s,r)}}const Fs=(e,t,n,o,a)=>{on(e,t.top,n.top.x-o.top/2,n.top.y,a),on(e,t.left,n.left.x-o.left/2,n.left.y,a)},Ns=(e,t,n,o,a)=>{on(e,t.right,n.right.x-o.right,n.right.y,a),on(e,t.bottom,n.bottom.x-o.bottom/2,n.bottom.y-o.height,a)},Bs=e=>{const t=c.cornerstone,n=t.getEnabledElement(e),o=t.metaData.get("imagePlaneModule",n.image.imageId);if(!o||!o.rowCosines||!o.columnCosines)return;const a=Rs.getOrientationString(o.rowCosines),i=Rs.getOrientationString(o.columnCosines),r=Rs.invertOrientationString(a);return{top:Rs.invertOrientationString(i),bottom:i,left:r,right:a}},Vs=e=>{const t=c.cornerstone.getEnabledElement(e);return{top:c.cornerstone.pixelToCanvas(e,{x:t.image.width/2,y:5}),bottom:c.cornerstone.pixelToCanvas(e,{x:t.image.width/2,y:t.image.height-15}),left:c.cornerstone.pixelToCanvas(e,{x:5,y:t.image.height/2}),right:c.cornerstone.pixelToCanvas(e,{x:t.image.width-10,y:t.image.height/2})}};class zs extends Yn{constructor(e={}){super(e,{name:"PanMultiTouch",supportedInteractionTypes:["MultiTouch"],configuration:{touchPointers:2}}),this.multiTouchDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const t=e.detail,{element:n,viewport:o}=t;if(t.numPointers===this.configuration.touchPointers){const e=this._getTranslation(t);this._applyTranslation(o,e),c.cornerstone.setViewport(n,o)}}_getTranslation(e){const{viewport:t,image:n,deltaPoints:o}=e;let a=t.scale,i=t.scale;return n.rowPixelSpacing<n.columnPixelSpacing?a*=n.columnPixelSpacing/n.rowPixelSpacing:n.columnPixelSpacing<n.rowPixelSpacing&&(i*=n.rowPixelSpacing/n.columnPixelSpacing),{x:o.page.x/a,y:o.page.y/i}}_applyTranslation(e,t){e.translation.x+=t.x,e.translation.y+=t.y}}class js extends Yn{constructor(e={}){super(e,{name:"Pan",supportedInteractionTypes:["Mouse","Touch"],svgCursor:sa}),this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const t=e.detail,{element:n,viewport:o}=t,a=this._getTranslation(t);this._applyTranslation(o,a),c.cornerstone.setViewport(n,o)}_getTranslation(e){const{viewport:t,image:n,deltaPoints:o}=e;let a=t.scale,i=t.scale;return n.rowPixelSpacing<n.columnPixelSpacing?a*=n.columnPixelSpacing/n.rowPixelSpacing:n.columnPixelSpacing<n.rowPixelSpacing&&(i*=n.rowPixelSpacing/n.columnPixelSpacing),{x:o.page.x/a,y:o.page.y/i}}_applyTranslation(e,t){e.translation.x+=t.x,e.translation.y+=t.y}}var qs=function(e,t,n,o){const a=c.cornerstone,i=a.getEnabledElement(n).image,r=a.getEnabledElement(o).image;if(!i||!r)return;const s=a.metaData.get("imagePlaneModule",i.imageId),l=a.metaData.get("imagePlaneModule",r.imageId);if(!(s&&l&&s.rowCosines&&s.columnCosines&&s.imagePositionPatient&&l.rowCosines&&l.columnCosines&&l.imagePositionPatient))return;if(s.frameOfReferenceUID!==l.frameOfReferenceUID)return;s.rowCosines=Ut(s.rowCosines),s.columnCosines=Ut(s.columnCosines),s.imagePositionPatient=Ut(s.imagePositionPatient),l.rowCosines=Ut(l.rowCosines),l.columnCosines=Ut(l.columnCosines),l.imagePositionPatient=Ut(l.imagePositionPatient);const d=s.rowCosines.clone().cross(s.columnCosines),u=l.rowCosines.clone().cross(l.columnCosines);let h=d.angleTo(u);if(h=Math.abs(h),h<.5)return;const g=function(e,t){const n=Bt(e,t);if(n)return{start:Ft(n.start,e),end:Ft(n.end,e)}}(s,l);if(!g)return;const m=Gt.getActiveColor();e.setTransform(1,0,0,1,0,0),_t(e,e=>{Lt(e,t.element,g.start,g.end,{color:m})})};const Ws=e=>new Promise(t=>setTimeout(t,e));function Gs(e){try{const t=c.cornerstone.getEnabledElement(e);return t.image?t:Ws(250).then(()=>Gs(e))}catch(e){return null}}const Ys=I("tools:ReferenceLinesTool");class Xs extends Yn{constructor(e={}){super(e,{name:"ReferenceLines",mixins:["enabledOrDisabledBinaryTool"],configuration:{renderer:qs}}),this.renderer=null,this.synchronizationContext=null}async enabledCallback(e,{synchronizationContext:t}={}){const n=this.configuration.renderer;await Gs(e)&&n&&t?(this.renderer=n,this.synchronizationContext=t,this.forceImageUpdate(e)):Ys.warn("Unable to enable ".concat(this.name,". Exiting enable callback. Tool will be enabled, but will not render."))}disabledCallback(e){this.forceImageUpdate(e)}forceImageUpdate(e){c.cornerstone.getEnabledElement(e).image&&c.cornerstone.updateImage(e)}renderToolData(e){const t=e.detail;if(!this.renderer||!this.synchronizationContext)return;const n=this.synchronizationContext.getSourceElements(),o=hn(t.canvasContext.canvas);c.cornerstone.setToPixelCoordinateSystem(t.enabledElement,o),n.forEach(n=>{n!==e.currentTarget&&this.renderer(o,t,e.currentTarget,n)})}}var Ks=(e,t,n)=>{const o=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),a=Math.sqrt(Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2)),i=Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2));return{angle:180*Math.acos((Math.pow(o,2)+Math.pow(a,2)-Math.pow(i,2))/(2*o*a))/Math.PI,direction:(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)}};class Zs extends Yn{constructor(e={}){super(e,{name:"Rotate",strategies:{default:$s,horizontal:Js,vertical:Qs},defaultStrategy:"default",supportedInteractionTypes:["Mouse","Touch"],configuration:{roundAngles:!1,flipHorizontal:!1,flipVertical:!1,rotateScale:1},svgCursor:ca})}touchDragCallback(e){this.dragCallback(e)}mouseDragCallback(e){this.dragCallback(e)}postMouseDownCallback(e){this.initialRotation=e.detail.viewport.rotation}dragCallback(e){e.detail.viewport.initialRotation=this.initialRotation,this.applyActiveStrategy(e),c.cornerstone.setViewport(e.detail.element,e.detail.viewport)}}function $s(e){const{roundAngles:t,rotateScale:n}=this.configuration,{element:o,viewport:a,startPoints:i,currentPoints:r}=e.detail,s=a.initialRotation?a.initialRotation:a.rotation,c=o.getBoundingClientRect(o),{clientWidth:l,clientHeight:d}=o,{scale:u,translation:h}=a,g={x:c.left+l/2+h.x*u,y:c.top+d/2+h.y*u},m=Ks(g,i.client,r.client);m.angle*=n,t&&(m.angle=Math.ceil(m.angle)),m.direction<0&&(m.angle=-m.angle),a.rotation=s+m.angle}function Js(e){const{roundAngles:t,flipHorizontal:n,rotateScale:o}=this.configuration,{viewport:a,startPoints:i,currentPoints:r}=e.detail,s=a.initialRotation,c=i.client.x;let l=(r.client.x-c)*o;t&&(l=Math.round(Math.abs(l))*(l>0?1:-1)),n&&(l=-l),a.rotation=s+l}function Qs(e){const{roundAngles:t,flipVertical:n,rotateScale:o}=this.configuration,{viewport:a,startPoints:i,currentPoints:r}=e.detail,s=a.initialRotation,c=i.client.y;let l=(r.client.y-c)*o;t&&(l=Math.round(Math.abs(l))*(l>0?1:-1)),n&&(l=-l),a.rotation=s+l}class ec extends Yn{constructor(e={}){super(e,{name:"RotateTouch",supportedInteractionTypes:["TouchRotate"]})}touchRotateCallback(e){const t=e.detail,{element:n,viewport:o,rotation:a}=t;o.rotation+=a,c.cornerstone.setViewport(n,o)}}const tc=I("tools:ScaleOverlayTool");class nc extends Yn{constructor(e={}){super(e,{name:"ScaleOverlay",configuration:{minorTickLength:12.5,majorTickLength:25},mixins:["enabledOrDisabledBinaryTool"]})}enabledCallback(e){this.forceImageUpdate(e)}disabledCallback(e){this.forceImageUpdate(e)}forceImageUpdate(e){c.cornerstone.getEnabledElement(e).image&&c.cornerstone.updateImage(e)}renderToolData(e){const t=e.detail,n=hn(t.canvasContext.canvas),{image:o,viewport:a,element:i}=t;let r=o.rowPixelSpacing,s=o.columnPixelSpacing;const l=c.cornerstone.metaData.get("imagePlaneModule",o.imageId);if(l&&(r=l.rowPixelSpacing||l.rowImagePixelSpacing,s=l.columnPixelSpacing||l.colImagePixelSpacing),!r||!s)return void tc.warn("unable to define rowPixelSpacing or colPixelSpacing from data on ".concat(this.name,"'s renderToolData"));const d={width:n.canvas.width,height:n.canvas.height},u=10/r*a.scale,h=10/s*a.scale,g=oc(d,.25,.05),m=oc(d,.05,.15);if(!(d.width&&d.height&&g&&m))return;const f=Gt.getToolColor(),p=kt.getToolWidth(),v=Object.assign({},{hscaleBounds:g,vscaleBounds:m,verticalMinorTick:u,horizontalMinorTick:h,verticalLine:{start:{x:m.bottomRight.x,y:m.topLeft.y},end:{x:m.bottomRight.x,y:m.bottomRight.y}},horizontalLine:{start:{x:g.topLeft.x,y:g.bottomRight.y},end:{x:g.bottomRight.x,y:g.bottomRight.y}},color:f,lineWidth:p},this.configuration);_t(n,e=>{mn(e,v),Lt(e,i,v.verticalLine.start,v.verticalLine.end,{color:v.color,lineWidth:v.lineWidth},"canvas"),ac(e,i,v),Lt(e,i,v.horizontalLine.start,v.horizontalLine.end,{color:v.color,lineWidth:v.lineWidth},"canvas"),ic(e,i,v)})}}const oc=(e,t,n)=>{const o=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),i={left:o,top:a,width:e.width-2*o,height:e.height-2*a};return{topLeft:{x:i.left,y:i.top},bottomRight:{x:i.left+i.width,y:i.top+i.height}}},ac=(e,t,n)=>{let o=0;for(;n.verticalLine.start.y+o*n.verticalMinorTick<=n.vscaleBounds.bottomRight.y;){const{color:a,lineWidth:i}=n,r={x:n.verticalLine.start.x,y:n.verticalLine.start.y+o*n.verticalMinorTick},s={x:0,y:n.verticalLine.start.y+o*n.verticalMinorTick};s.x=o%5==0?n.verticalLine.start.x-n.majorTickLength:n.verticalLine.start.x-n.minorTickLength,Lt(e,t,r,s,{color:a,lineWidth:i},"canvas"),o++}},ic=(e,t,n)=>{let o=0;for(;n.horizontalLine.start.x+o*n.horizontalMinorTick<=n.hscaleBounds.bottomRight.x;){const{color:a,lineWidth:i}=n,r={x:n.horizontalLine.start.x+o*n.horizontalMinorTick,y:n.horizontalLine.start.y},s={x:n.horizontalLine.start.x+o*n.horizontalMinorTick,y:0};s.y=o%5==0?n.horizontalLine.start.y-n.majorTickLength:n.horizontalLine.start.y-n.minorTickLength,Lt(e,t,r,s,{color:a,lineWidth:i},"canvas"),o++}};var rc=function(e,t){const n=b(e,"stack");if(!n||!n.data||!n.data.length)return;const o=c.cornerstone;let a;if(n.data.length>1){const t=b(e,"stackRenderer");t&&t.data&&t.data.length&&(a=t.data[0])}const i=n.data[0];t<0&&(t+=i.imageIds.length);const r=Ts.getStartLoadHandler(e),s=Ts.getEndLoadHandler(e),u=Ts.getErrorLoadingHandler(e);if(t===i.currentImageIdIndex)return;r&&r(e);const h={newImageIdIndex:t,direction:t-i.currentImageIdIndex};i.currentImageIdIndex=t;const g=i.imageIds[t];let m;m=Boolean(i.preventCache)?o.loadImage(g):o.loadAndCacheImage(g),m.then((function(r){if(i.currentImageIdIndex===t){try{o.getEnabledElement(e)}catch(e){return}a?(a.currentImageIdIndex=t,a.render(e,n.data)):o.displayImage(e,r),s&&s(e,r)}}),(function(n){const o=i.imageIds[t];u&&u(e,o,n)})),d(e,l.STACK_SCROLL,h)},sc=function(e,t,n=!1,o=!0){const a=b(e,"stack");if(!a||!a.data||!a.data.length)return;const i=a.data[0];i.pending||(i.pending=[]);let r=i.currentImageIdIndex+t;if(n){r%=i.imageIds.length}else r=ln(r,0,i.imageIds.length-1);if(o)rc(e,r);else{const t={index:r};i.pending.push(t),function e(t,n,o){if(t.pending[0]===n){if(t.currentImageIdIndex===n.index)return t.pending.splice(t.pending.indexOf(n),1),void(t.pending.length>0&&e(t,t.pending[0],o));const a=function a(i){t.imageIds.indexOf(i.detail.image.imageId)===n.index&&(t.pending.splice(t.pending.indexOf(n),1),o.removeEventListener(c.cornerstone.EVENTS.NEW_IMAGE,a),t.pending.length>0&&e(t,t.pending[0],o))};o.addEventListener(c.cornerstone.EVENTS.NEW_IMAGE,a),rc(o,n.index)}}(i,t,e)}};class cc extends Yn{constructor(e={}){super(e,{name:"StackScrollMouseWheel",supportedInteractionTypes:["MouseWheel"],configuration:{loop:!1,allowSkipping:!0,invert:!1}})}mouseWheelCallback(e){const{direction:t,element:n}=e.detail,{loop:o,allowSkipping:a,invert:i}=this.configuration;sc(n,i?-t:t,o,a)}}class lc extends Yn{constructor(e={}){super(e,{name:"StackScrollMultiTouch",supportedInteractionTypes:["MultiTouch"],configuration:{loop:!1,allowSkipping:!0,touchPointers:3}}),this.multiTouchDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const t=e.detail;if(t.numPointers===this.configuration.touchPointers){const{element:e,deltaPoints:n}=t,{loop:o,allowSkipping:a}=this.configuration,i=Ms(this.name,e),r=this._getPixelPerImage(e),s=this._getDeltaY(e,n.page.y);if(!r)return;if(Math.abs(s)>=r){const t=Math.round(s/r);sc(e,t,o,a),i.deltaY=s%r}else i.deltaY=s;Es(this.name,e,i)}}_getDeltaY(e,t){return(Ms(this.name,e).deltaY||0)+t}_getPixelPerImage(e){const t=b(e,"stack");if(!t||!t.data||!t.data.length)return;const n=t.data[0],{stackScrollSpeed:o}=this.configuration;return o||Math.max(2,e.offsetHeight/Math.max(n.imageIds.length,8))}}class dc extends Yn{constructor(e={}){super(e,{name:"StackScroll",supportedInteractionTypes:["Mouse","Touch"],configuration:{loop:!1,allowSkipping:!0},svgCursor:la}),this.mouseDragCallback=this._dragCallback.bind(this),this.touchDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const t=e.detail,{element:n,deltaPoints:o}=t,{loop:a,allowSkipping:i}=this.configuration,r=Ms(this.name,n),s=this._getPixelPerImage(n),c=this._getDeltaY(n,o.page.y);if(s){if(Math.abs(c)>=s){const e=Math.round(c/s);sc(n,e,a,i),r.deltaY=c%s}else r.deltaY=c;Es(this.name,n,r)}}_getDeltaY(e,t){return(Ms(this.name,e).deltaY||0)+t}_getPixelPerImage(e){const t=b(e,"stack");if(!t||!t.data||!t.data.length)return;const n=t.data[0],{stackScrollSpeed:o}=this.configuration;return o||Math.max(2,e.offsetHeight/Math.max(n.imageIds.length,8))}}var uc=function(e,t,n,o,a){if(!e)throw new Error("getLuminance: parameter element must not be undefined");t=Math.round(t),n=Math.round(n);const i=c.cornerstone.getEnabledElement(e).image,r=[];let s=0;const l=i.getPixelData();let d,u,h;if(i.color)for(u=0;u<a;u++)for(h=0;h<o;h++){d=4*((u+n)*i.columns+(h+t));const e=l[d],o=l[d+1],a=l[d+2];r[s++]=.2126*e+.7152*o+.0722*a}else for(u=0;u<a;u++)for(h=0;h<o;h++)d=(u+n)*i.columns+(h+t),r[s++]=l[d]*i.slope+i.intercept;return r};class hc extends Yn{constructor(e={}){super(e,{name:"WwwcRegion",supportedInteractionTypes:["Mouse","Touch"],configuration:{minWindowWidth:10},svgCursor:da}),this._resetHandles(),this.postTouchStartCallback=this._startOutliningRegion.bind(this),this.touchDragCallback=this._setHandlesAndUpdate.bind(this),this.touchEndCallback=this._applyStrategy.bind(this),this.postMouseDownCallback=this._startOutliningRegion.bind(this),this.mouseClickCallback=this._startOutliningRegion.bind(this),this.mouseDragCallback=this._setHandlesAndUpdate.bind(this),this.mouseMoveCallback=this._setHandlesAndUpdate.bind(this),this.mouseUpCallback=this._applyStrategy.bind(this)}renderToolData(e){const t=e.detail,{element:n}=t,o=Gt.getColorIfActive({active:!0}),a=hn(t.canvasContext.canvas);_t(a,e=>{un(e,n,this.handles.start,this.handles.end,{color:o})})}_startOutliningRegion(e){const t=e.detail.element,n=e.detail.currentPoints.image;return gc(this.handles.start)?this.handles.start=n:(this.handles.end=n,this._applyStrategy(e)),c.cornerstone.updateImage(t),!0}_setHandlesAndUpdate(e){const t=e.detail.element,n=e.detail.currentPoints.image;this.handles.end=n,c.cornerstone.updateImage(t)}_applyStrategy(e){gc(this.handles.start)||gc(this.handles.end)||(e.detail.handles=this.handles,mc(e,this.configuration),this._resetHandles())}_resetHandles(){this.handles={start:{},end:{}}}}const gc=e=>0===Object.keys(e).length&&e.constructor===Object,mc=function(e,t){const n=e.detail,{image:o,element:a}=n,{start:i,end:r}=e.detail.handles;let s=Math.min(i.x,r.x),l=Math.min(i.y,r.y),d=Math.abs(i.x-r.x),u=Math.abs(i.y-r.y);s=ln(s,0,o.width),l=ln(l,0,o.height),d=Math.floor(Math.min(d,Math.abs(o.width-s))),u=Math.floor(Math.min(u,Math.abs(o.height-l)));const h=uc(a,s,l,d,u),g=fc(h,o.minPixelValue,o.maxPixelValue),m=n.viewport;void 0===t.minWindowWidth&&(t.minWindowWidth=10),m.voi.windowWidth=Math.max(Math.abs(g.max-g.min),t.minWindowWidth),m.voi.windowCenter=g.mean,m.voiLUT=void 0,c.cornerstone.setViewport(a,m),c.cornerstone.updateImage(a)},fc=function(e,t,n){const o=e.length;let a=n,i=t,r=0;if(o<2)return{min:a,max:i,mean:(t+n)/2};for(let t=0;t<o;t++){const n=e[t];a=Math.min(a,n),i=Math.max(i,n),r+=n}return{min:a,max:i,mean:r/o}};class pc extends Yn{constructor(e={}){super(e,{name:"Wwwc",strategies:{basicLevelingStrategy:vc},supportedInteractionTypes:["Mouse","Touch"],configuration:{orientation:0},svgCursor:ua})}mouseDragCallback(e){this.applyActiveStrategy(e),c.cornerstone.setViewport(e.detail.element,e.detail.viewport)}touchDragCallback(e){e.stopImmediatePropagation(),this.applyActiveStrategy(e),c.cornerstone.setViewport(e.detail.element,e.detail.viewport)}}function vc(e){const{orientation:t}=this.configuration,n=e.detail,o=(n.image.maxPixelValue*n.image.slope+n.image.intercept-(n.image.minPixelValue*n.image.slope+n.image.intercept))/1024,a=n.deltaPoints.page.x*o,i=n.deltaPoints.page.y*o;0===t?(n.viewport.voi.windowWidth+=a,n.viewport.voi.windowCenter+=i):(n.viewport.voi.windowWidth+=i,n.viewport.voi.windowCenter+=a),n.viewport.voiLUT=void 0}var xc=function(e,t,n){const{maxScale:o,minScale:a}=n,i=Math.log(e.scale)/Math.log(1.7)+t,r=Math.pow(1.7,i);return e.scale=o&&r>o?o:a&&r<a?a:r,e},yc={changeViewportScale:xc,correctShift:function(e,t){const{hflip:n,vflip:o,rotation:a}=t;if(e.x*=n?-1:1,e.y*=o?-1:1,0!==a){const t=a*Math.PI/180,n=Math.cos(t),o=Math.sin(t),i=e.x*n-e.y*o,r=e.x*o+e.y*n;e.x=i,e.y=r}return e}};class bc extends Yn{constructor(e={}){super(e,{name:"ZoomMouseWheel",supportedInteractionTypes:["MouseWheel"],configuration:{minScale:.25,maxScale:20,invert:!1}})}mouseWheelCallback(e){const{element:t,viewport:n,spinY:o}=e.detail,{invert:a,maxScale:i,minScale:r}=this.configuration,s=xc(n,a?o/4:-o/4,{maxScale:i,minScale:r});c.cornerstone.setViewport(t,s)}}const{correctShift:Tc,changeViewportScale:Cc}=yc;class Mc extends Yn{constructor(e={}){super(e,{name:"Zoom",strategies:{default:wc,translate:Ic,zoomToCenter:Sc},defaultStrategy:"default",supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,preventZoomOutsideImage:!1,minScale:.25,maxScale:20},svgCursor:ha})}touchDragCallback(e){Ec.call(this,e)}mouseDragCallback(e){Ec.call(this,e)}}const Ec=function(e){if(!e.detail.deltaPoints.page.y)return!1;this.applyActiveStrategy(e,this.configuration),c.cornerstone.setViewport(e.detail.element,e.detail.viewport)};function wc(e){const{invert:t,maxScale:n,minScale:o}=this.configuration,a=e.detail.deltaPoints.page.y,i=t?-a/100:a/100,{element:r,viewport:s}=e.detail,[l,d,u,h]=[e.detail.startPoints.page.x,e.detail.startPoints.page.y,e.detail.startPoints.image.x,e.detail.startPoints.image.y],g=Cc(s,i,{maxScale:n,minScale:o});c.cornerstone.setViewport(r,g);const m=c.cornerstone.pageToPixel(r,l,d);let f={x:u-m.x,y:h-m.y};f=Tc(f,g),s.translation.x-=f.x,s.translation.y-=f.y}function Ic(e){const{invert:t,preventZoomOutsideImage:n,maxScale:o,minScale:a}=this.configuration,i=e.detail.deltaPoints.page.y,r=t?-i/100:i/100,s=e.detail.image,c=e.detail.viewport,[l,d]=[e.detail.startPoints.image.x,e.detail.startPoints.image.y],u=Cc(c,r,{maxScale:o,minScale:a}),h={x:0,y:0};if(r<0)u.scale<3&&(Math.abs(u.translation.x)<.01?u.translation.x=0:h.x=u.translation.x/8,Math.abs(u.translation.y)<.01?u.translation.y=0:h.y=u.translation.y/8);else{n&&rn(e.detail.startPoints.image,s);let t={x:s.width/2-l,y:s.height/2-d};t=Tc(t,u);const o={x:u.translation.x-t.x,y:u.translation.y-t.y};Math.abs(o.x)<.01?u.translation.x=t.x:h.x=o.x/8,Math.abs(o.y)<.01?u.translation.y=t.y:h.y=o.y/8}u.translation.x-=h.x,u.translation.y-=h.y}function Sc(e){const{invert:t,maxScale:n,minScale:o}=this.configuration,a=e.detail.deltaPoints.page.y,i=t?-a/100:a/100,r=e.detail.viewport;Cc(r,i,{maxScale:n,minScale:o})}const{correctShift:_c}=yc;class Pc extends Yn{constructor(e={}){super(e,{name:"ZoomTouchPinch",supportedInteractionTypes:["TouchPinch"],configuration:{minScale:.25,maxScale:20}})}touchPinchCallback(e){const{element:t,viewport:n,scaleChange:o}=e.detail,[a,i,r,s]=[e.detail.startPoints.page.x,e.detail.startPoints.page.y,e.detail.startPoints.image.x,e.detail.startPoints.image.y],{maxScale:l,minScale:d}=this.configuration;n.scale+=o*n.scale,l&&n.scale>l?n.scale=l:d&&n.scale<d&&(n.scale=d),c.cornerstone.setViewport(t,n);const u=c.cornerstone.pageToPixel(t,a,i);let h={x:r-u.x,y:s-u.y};h=_c(h,n),n.translation.x-=h.x,n.translation.y-=h.y,c.cornerstone.setViewport(t,n)}}var Dc=function(e){return{page:kc(e.page),image:kc(e.image),client:kc(e.client),canvas:kc(e.canvas)}};function kc({x:e,y:t}={}){return{x:e,y:t}}const Oc=I("eventListeners:mouseEventListeners");let Lc,Ac=!0;const Hc=new Map;function Rc(e){if("number"==typeof e.buttons)return e.buttons;switch(e.which){case 0:return 0;case 1:return 1;case 2:return 4;case 3:return 2}return 0}function Uc(){Ac=!1}function Fc(e){const t=e.currentTarget,n=c.cornerstone.getEnabledElement(t);if(!n.image)return;const o=l.MOUSE_DOUBLE_CLICK,a={page:c.cornerstoneMath.point.pageToPoint(e),image:c.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};a.canvas=c.cornerstone.pixelToCanvas(t,a.image);const i=Dc(a);Oc.log("double-click: %o",Rc(e)),d(t,o,{event:e,buttons:Rc(e),viewport:c.cornerstone.getViewport(t),image:n.image,element:t,startPoints:a,lastPoints:i,currentPoints:a,deltaPoints:{x:0,y:0},type:o})}function Nc(e){const t=e.currentTarget,n=c.cornerstone.getEnabledElement(t);if(!n.image)return;Lc=setTimeout(Uc,200),t.removeEventListener("mousemove",Bc);const o={page:c.cornerstoneMath.point.pageToPoint(e),image:c.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};o.canvas=c.cornerstone.pixelToCanvas(t,o.image);let a=Dc(o);const i={event:e,buttons:Rc(e),viewport:c.cornerstone.getViewport(t),image:n.image,element:t,startPoints:o,lastPoints:a,currentPoints:o,deltaPoints:{x:0,y:0},type:l.MOUSE_DOWN};function r(e){const i=l.MOUSE_DRAG,r={page:c.cornerstoneMath.point.pageToPoint(e),image:c.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};r.canvas=c.cornerstone.pixelToCanvas(t,r.image);const s={page:c.cornerstoneMath.point.subtract(r.page,a.page),image:c.cornerstoneMath.point.subtract(r.image,a.image),client:c.cornerstoneMath.point.subtract(r.client,a.client),canvas:c.cornerstoneMath.point.subtract(r.canvas,a.canvas)};Oc.log("mousemove: %o",Rc(e));const u={buttons:Rc(e),viewport:c.cornerstone.getViewport(t),image:n.image,element:t,startPoints:o,lastPoints:a,currentPoints:r,deltaPoints:s,type:i,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey};d(u.element,i,u),a=Dc(r)}function s(e){clearTimeout(Lc);let i=l.MOUSE_UP;Ac&&(i=l.MOUSE_CLICK);const u={page:c.cornerstoneMath.point.pageToPoint(e),image:c.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};u.canvas=c.cornerstone.pixelToCanvas(t,u.image);const h={page:c.cornerstoneMath.point.subtract(u.page,a.page),image:c.cornerstoneMath.point.subtract(u.image,a.image),client:c.cornerstoneMath.point.subtract(u.client,a.client),canvas:c.cornerstoneMath.point.subtract(u.canvas,a.canvas)};Oc.log("mouseup: %o",Rc(e));const g={event:e,buttons:Rc(e),viewport:c.cornerstone.getViewport(t),image:n.image,element:t,startPoints:o,lastPoints:a,currentPoints:u,deltaPoints:h,type:i};d(g.element,i,g),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s),Hc.delete(r),Hc.delete(s),t.addEventListener("mousemove",Bc),Ac=!0}d(i.element,l.MOUSE_DOWN,i)&&(i.type=l.MOUSE_DOWN_ACTIVATE,d(i.element,l.MOUSE_DOWN_ACTIVATE,i)),document.addEventListener("mousemove",r),document.addEventListener("mouseup",s),Hc.set(r,"mousemove"),Hc.set(s,"mouseup")}function Bc(e){const t=e.currentTarget,n=c.cornerstone.getEnabledElement(t);if(!n.image)return;const o=l.MOUSE_MOVE,a={page:c.cornerstoneMath.point.pageToPoint(e),image:c.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};a.canvas=c.cornerstone.pixelToCanvas(t,a.image);let i=Dc(a);const r={page:c.cornerstoneMath.point.pageToPoint(e),image:c.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};r.canvas=c.cornerstone.pixelToCanvas(t,r.image);const s={page:c.cornerstoneMath.point.subtract(r.page,i.page),image:c.cornerstoneMath.point.subtract(r.image,i.image),client:c.cornerstoneMath.point.subtract(r.client,i.client),canvas:c.cornerstoneMath.point.subtract(r.canvas,i.canvas)};d(t,o,{viewport:c.cornerstone.getViewport(t),image:n.image,element:t,startPoints:a,lastPoints:i,currentPoints:r,deltaPoints:s,type:o}),i=Dc(r)}function Vc(e){e.removeEventListener("mousedown",Nc),e.removeEventListener("mousemove",Bc),e.removeEventListener("dblclick",Fc),Hc.forEach((e,t)=>{document.removeEventListener(e,t)}),Hc.clear()}var zc={enable:function(e){Vc(e),e.addEventListener("mousedown",Nc),e.addEventListener("mousemove",Bc),e.addEventListener("dblclick",Fc)},disable:Vc};function jc(e){const t=e.currentTarget,n=c.cornerstone.getEnabledElement(t);if(!n.image)return;if(e.deltaY>-1&&e.deltaY<1)return;e.preventDefault();const{pageX:o,pageY:a}=e,i=c.cornerstone.pageToPixel(t,o,a),{spinX:r,spinY:s,pixelX:u,pixelY:h}=function(e){let t=0,n=0,o=0,a=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),o=10*t,a=10*n,"deltaY"in e&&(a=e.deltaY),"deltaX"in e&&(o=e.deltaX),(o||a)&&e.deltaMode&&(1===e.deltaMode?(o*=40,a*=40):(o*=800,a*=800)),o&&!t&&(t=o<1?-1:1),a&&!n&&(n=a<1?-1:1),{spinX:t,spinY:n,pixelX:o,pixelY:a}}(e),g=s<0?-1:1,m={element:t,viewport:c.cornerstone.getViewport(t),detail:e,image:n.image,direction:g,spinX:r,spinY:s,pixelX:u,pixelY:h,pageX:o,pageY:a,imageX:i.x,imageY:i.y};d(t,l.MOUSE_WHEEL,m)}function qc(e){e.removeEventListener("wheel",jc,{passive:!1})}var Wc={enable:function(e){qc(e),e.addEventListener("wheel",jc,{passive:!1})},disable:qc};const Gc=0,Yc=1;let Xc,Kc;function Zc(e,t){const n=Date.now();if(e!==Xc){if(n-Kc<=2e3)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;Xc=e}Kc=n}const $c=Zc.bind(null,Gc),Jc=Zc.bind(null,Yc);function Qc(e,t,n){const o=n?$c:Jc;t.forEach((function(t){e.addEventListener(t,o,{passive:!1})}))}function el(e,t,n){const o=n?$c:Jc;t.forEach((function(t){e.removeEventListener(t,o)}))}const tl=["mousedown","mouseup"],nl=["touchstart","touchend"];function ol(e){el(e,tl,Gc),el(e,nl,Yc)}var al={enable:function(e){ol(e),Qc(e,tl,Gc),Qc(e,nl,Yc)},disable:ol};let il,rl,sl,cl,ll,dl,ul,hl,gl,ml=1,fl=0,pl=!1,vl=!1;function xl(e){const t=e.currentTarget||e.srcEvent.currentTarget,n=c.cornerstone.getEnabledElement(t);if(!n.image)return;let o,a,i,r,s;switch(e.preventDefault(),(e.pointers&&e.pointers.length>1||e.touches&&e.touches.length>1)&&(vl=!1,clearTimeout(ul)),e.type){case"tap":vl=!1,clearTimeout(ul),rl={page:c.cornerstoneMath.point.pageToPoint(e.pointers[0]),image:c.cornerstone.pageToPixel(t,e.pointers[0].pageX,e.pointers[0].pageY),client:{x:e.pointers[0].clientX,y:e.pointers[0].clientY}},rl.canvas=c.cornerstone.pixelToCanvas(t,rl.image),o=l.TAP,ll={event:e,viewport:c.cornerstone.getViewport(t),image:n.image,element:t,currentPoints:rl,type:o,isTouchEvent:!0},d(t,o,ll);break;case"doubletap":vl=!1,clearTimeout(ul),rl={page:c.cornerstoneMath.point.pageToPoint(e.pointers[0]),image:c.cornerstone.pageToPixel(t,e.pointers[0].pageX,e.pointers[0].pageY),client:{x:e.pointers[0].clientX,y:e.pointers[0].clientY}},rl.canvas=c.cornerstone.pixelToCanvas(t,rl.image),o=l.DOUBLE_TAP,ll={event:e,viewport:c.cornerstone.getViewport(t),image:n.image,element:t,currentPoints:rl,type:o,isTouchEvent:!0},d(t,o,ll);break;case"pinchstart":vl=!1,clearTimeout(ul),ml=1;break;case"pinchmove":if(vl=!1,clearTimeout(ul),!0===pl){ml=e.scale,pl=!1;break}a=(e.scale-ml)/ml,il={page:e.center,image:c.cornerstone.pageToPixel(t,e.center.x,e.center.y)},il.canvas=c.cornerstone.pixelToCanvas(t,il.image),o=l.TOUCH_PINCH,ll={event:e,startPoints:il,viewport:c.cornerstone.getViewport(t),image:n.image,element:t,direction:e.scale<1?1:-1,scaleChange:a,type:o,isTouchEvent:!0},d(t,o,ll),ml=e.scale;break;case"touchstart":ml=1,clearTimeout(ul),clearTimeout(dl),dl=setTimeout((function(){il={page:c.cornerstoneMath.point.pageToPoint(e.touches[0]),image:c.cornerstone.pageToPixel(t,e.touches[0].pageX,e.touches[0].pageY),client:{x:e.touches[0].clientX,y:e.touches[0].clientY}},il.canvas=c.cornerstone.pixelToCanvas(t,il.image),o=l.TOUCH_START,e.touches.length>1&&(o=l.MULTI_TOUCH_START),ll={event:e,viewport:c.cornerstone.getViewport(t),image:n.image,element:t,startPoints:il,currentPoints:il,type:o,isTouchEvent:!0},!0===d(t,o,ll)&&(o=l.TOUCH_START_ACTIVE,e.touches.length>1&&(o=l.MULTI_TOUCH_START_ACTIVE),ll.type=o,d(t,o,ll)),sl=Dc(il)}),50),vl=!0,hl=0,ul=setTimeout((function(){vl&&(rl={page:c.cornerstoneMath.point.pageToPoint(e.touches[0]),image:c.cornerstone.pageToPixel(t,e.touches[0].pageX,e.touches[0].pageY),client:{x:e.touches[0].clientX,y:e.touches[0].clientY}},rl.canvas=c.cornerstone.pixelToCanvas(t,il.image),o=l.TOUCH_PRESS,ll={event:e,viewport:c.cornerstone.getViewport(t),image:n.image,element:t,currentPoints:rl,type:o,isTouchEvent:!0},d(t,o,ll))}),700);break;case"touchend":ml=1,vl=!1,clearTimeout(ul),setTimeout((function(){il={page:c.cornerstoneMath.point.pageToPoint(e.changedTouches[0]),image:c.cornerstone.pageToPixel(t,e.changedTouches[0].pageX,e.changedTouches[0].pageY),client:{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}},il.canvas=c.cornerstone.pixelToCanvas(t,il.image),o=l.TOUCH_END,ll={event:e,viewport:c.cornerstone.getViewport(t),image:n.image,element:t,startPoints:il,currentPoints:il,type:o,isTouchEvent:!0},d(t,o,ll)}),50);break;case"panmove":i={x:e.deltaX-gl.x,y:e.deltaY-gl.y},gl={x:e.deltaX,y:e.deltaY},rl={page:{x:sl.page.x+i.x,y:sl.page.y+i.y},image:c.cornerstone.pageToPixel(t,sl.page.x+i.x,sl.page.y+i.y),client:{x:sl.client.x+i.x,y:sl.client.y+i.y}},rl.canvas=c.cornerstone.pixelToCanvas(t,rl.image),cl={page:c.cornerstoneMath.point.subtract(rl.page,sl.page),image:c.cornerstoneMath.point.subtract(rl.image,sl.image),client:c.cornerstoneMath.point.subtract(rl.client,sl.client),canvas:c.cornerstoneMath.point.subtract(rl.canvas,sl.canvas)},hl+=Math.sqrt(cl.page.x*cl.page.x+cl.page.y*cl.page.y),hl>5&&(vl=!1,clearTimeout(ul)),o=l.TOUCH_DRAG,e.pointers.length>1&&(o=l.MULTI_TOUCH_DRAG),ll={viewport:c.cornerstone.getViewport(t),image:n.image,element:t,startPoints:il,lastPoints:sl,currentPoints:rl,deltaPoints:cl,numPointers:e.pointers.length,type:o,isTouchEvent:!0},d(t,o,ll),sl=Dc(rl);break;case"panstart":gl={x:e.deltaX,y:e.deltaY},rl={page:c.cornerstoneMath.point.pageToPoint(e.pointers[0]),image:c.cornerstone.pageToPixel(t,e.pointers[0].pageX,e.pointers[0].pageY),client:{x:e.pointers[0].clientX,y:e.pointers[0].clientY}},rl.canvas=c.cornerstone.pixelToCanvas(t,rl.image),sl=Dc(rl);break;case"panend":if(vl=!1,clearTimeout(ul),!sl)return!1;rl={page:c.cornerstoneMath.point.pageToPoint(e.pointers[0]),image:c.cornerstone.pageToPixel(t,e.pointers[0].pageX,e.pointers[0].pageY),client:{x:e.pointers[0].clientX,y:e.pointers[0].clientY}},rl.canvas=c.cornerstone.pixelToCanvas(t,rl.image),cl={page:c.cornerstoneMath.point.subtract(rl.page,sl.page),image:c.cornerstoneMath.point.subtract(rl.image,sl.image),client:c.cornerstoneMath.point.subtract(rl.client,sl.client),canvas:c.cornerstoneMath.point.subtract(rl.canvas,sl.canvas)},o=l.TOUCH_DRAG_END,ll={event:e.srcEvent,viewport:c.cornerstone.getViewport(t),image:n.image,element:t,startPoints:il,lastPoints:sl,currentPoints:rl,deltaPoints:cl,type:o,isTouchEvent:!0},d(t,o,ll),r=e.pointers.length-e.changedPointers.length,2===r&&(pl=!0);break;case"rotatemove":vl=!1,clearTimeout(ul),s=e.rotation-fl,fl=e.rotation,o=l.TOUCH_ROTATE,ll={event:e.srcEvent,viewport:c.cornerstone.getViewport(t),image:n.image,element:t,rotation:s,type:o},d(t,o,ll)}return!1}function yl(e){al.disable(e);["touchstart","touchend"].forEach(t=>{e.removeEventListener(t,xl)});const t=Ms("touchInput",e),n=t.hammer;n&&(n.off("tap doubletap panstart panmove panend pinchstart pinchmove rotatemove",xl),n.input.destroy()),t.hammer=null,function(e,t){const n=Cs[e];n&&(Cs[e]=n.filter(e=>e.element!==t))}("touchInput",e)}var bl={enable:function(e){yl(e);const t=c.Hammer,n={inputClass:t.SUPPORT_POINTER_EVENTS?t.PointerEventInput:t.TouchInput},o=new t.Manager(e,n),a={pointers:0,direction:t.DIRECTION_ALL,threshold:0},i=new t.Pan(a),r=new t.Pinch({threshold:0}),s=new t.Rotate({threshold:0});r.recognizeWith(i),r.recognizeWith(s),s.recognizeWith(i);const l=new t.Tap({event:"doubletap",taps:2,interval:1500,threshold:50,posThreshold:50});l.recognizeWith(i),o.add([l,i,s,r]),o.on("tap doubletap panstart panmove panend pinchstart pinchmove rotatemove",xl),al.enable(e),["touchstart","touchend"].forEach(t=>{e.addEventListener(t,xl,{passive:!1})});const d=Ms("touchInput",e);d.hammer=o,Es("touchInput",e,d)},disable:yl};const Tl=ot("segmentation");function Cl(e,t,n,o,a){!function(e,t,n){const{configuration:o}=Tl,a=e.detail,i=hn(a.canvasContext.canvas),r=c.cornerstone.pixelToCanvas(a.element,{x:0,y:0}),s=c.cornerstone.pixelToCanvas(a.element,{x:a.image.width,y:0}),l=c.cornerstone.pixelToCanvas(a.element,{x:a.image.width,y:a.image.height}),d=c.cornerstoneMath.point.distance(r,s),u=c.cornerstoneMath.point.distance(s,l),h=a.canvasContext.canvas,g=a.viewport,m=i.imageSmoothingEnabled,f=i.globalAlpha;i.imageSmoothingEnabled=!1,i.globalAlpha=n?o.fillAlpha:o.fillAlphaInactive,function(e,t,n){if(!(n.hflip||n.vflip||n.rotation))return;const o={x:t.width/2+n.translation.x*n.scale,y:t.height/2+n.translation.y*n.scale};e.translate(o.x,o.y),n.rotation&&e.rotate(n.rotation*Math.PI/180),n.vflip&&e.scale(1,-1),n.hflip&&e.scale(-1,1),e.translate(-o.x,-o.y)}(i,h,g);const p=function(e){const{viewport:t,image:n}=e;let o=t.scale,a=t.scale;n.rowPixelSpacing<n.columnPixelSpacing?o*=n.columnPixelSpacing/n.rowPixelSpacing:n.columnPixelSpacing<n.rowPixelSpacing&&(a*=n.rowPixelSpacing/n.columnPixelSpacing);return{x:t.translation.x*o,y:t.translation.y*a}}(a);i.drawImage(t,h.width/2-d/2+p.x,h.height/2-u/2+p.y,d,u),i.globalAlpha=f,i.imageSmoothingEnabled=m,function(e){e.setTransform(1,0,0,1,0,0)}(i)}(e,function(e,t,n){const{state:o}=Tl,a=e.detail,{image:i}=a,r=i.width,s=i.height,{segmentsHidden:c}=t,l=n.pixelData,d=o.colorLutTables[t.colorLUTIndex],u=document.createElement("canvas");u.width=r,u.height=s;const h=hn(u),g=new ImageData(r,s),m=g.data;for(let e=0;e<l.length;e++){const t=l[e];if(0!==t&&!c[t]){const t=d[l[e]];m[4*e]=t[0],m[4*e+1]=t[1],m[4*e+2]=t[2],m[4*e+3]=t[3]}}return h.putImageData(g,0,0),u}(e,t,n),a)}const Ml=ot("segmentation");function El(e,t,n,o,a){const{configuration:i}=Ml;!function(e,t,n,o=!0){const{configuration:a,state:i}=Ml,r=e.detail,{element:s,canvasContext:c}=r,l=a.outlineWidth||1,d=hn(c.canvas),u=i.colorLutTables[n],h=d.globalAlpha;d.globalAlpha=o?a.outlineAlpha:a.outlineAlphaInactive,_t(d,e=>{for(let n=1;n<t.length;n++)if(t[n]){const o=u[n];Xt(e,s,t[n],{color:"rgba(".concat(o[0],", ").concat(o[1],", ").concat(o[2],", 1.0 )"),lineWidth:l},"canvas")}}),d.globalAlpha=h}(e,function(e,t,n,o){const a=e.detail,{element:i,image:r,viewport:s}=a,c=r.width,l=r.height;o=o||1;const{segmentsHidden:d}=t,u=n.pixelData,h=t.activeSegmentIndex,g=[];n.segmentsOnLabelmap.forEach(e=>{!d[e]&&(g[e]=[])}),g[h]||(g[h]=[]);const m=function(e,t){const n=t/2;let o=e.rotation;o*=Math.PI/180;const a=Math.cos(o),i=Math.sin(o),r=[a,i],s=[-i,a],c={x:n*r[0],y:n*r[1]},l={x:n*s[0],y:n*s[1]};e.hflip&&(c.x*=-1,c.y*=-1);e.vflip&&(l.x*=-1,l.y*=-1);return{i:c,j:l}}(s,o);for(let e=0;e<u.length;e++){const t=u[e];if(0===t)continue;if(!!d[t])continue;const n={x:(f=e)%c,y:Math.floor(f/c)},o=wl(n,l,c);void 0!==o.top&&u[o.top]===t||Dl(g[t],i,n,m),void 0!==o.bottom&&u[o.bottom]===t||kl(g[t],i,n,m),void 0!==o.left&&u[o.left]===t||Ol(g[t],i,n,m),void 0!==o.right&&u[o.right]===t||Ll(g[t],i,n,m),void 0!==o.topLeft&&u[o.topLeft]!==t&&u[o.top]===t&&u[o.left]===t&&Il(g[t],i,n,m),void 0!==o.topRight&&u[o.topRight]!==t&&u[o.top]===t&&u[o.right]===t&&Sl(g[t],i,n,m),void 0!==o.bottomLeft&&u[o.bottomLeft]!==t&&u[o.bottom]===t&&u[o.left]===t&&_l(g[t],i,n,m),void 0!==o.bottomRight&&u[o.bottomRight]!==t&&u[o.bottom]===t&&u[o.right]===t&&Pl(g[t],i,n,m)}var f;return g}(e,t,n,i.outlineWidth),t.colorLUTIndex,a)}function wl(e,t,n){const o=e.y*n+e.x,a={},i=e.y-1>=0,r=e.y+1<t,s=e.x-1>=0,c=e.x+1<n;return i&&(a.top=o-n,c&&(a.topRight=a.top+1),s&&(a.topLeft=a.top-1)),r&&(a.bottom=o+n,c&&(a.bottomRight=a.bottom+1),s&&(a.bottomLeft=a.bottom-1)),s&&(a.left=o-1),c&&(a.right=o+1),a}function Il(e,t,n,o){const{pixelToCanvas:a}=c.cornerstone,i=a(t,n);i.x+=o.j.x,i.y+=o.j.y;const r={x:i.x,y:i.y};r.x+=2*o.i.x,r.y+=2*o.i.y,e.push({start:i,end:r})}function Sl(e,t,n,o){const{pixelToCanvas:a}=c.cornerstone,i=a(t,{x:n.x+1,y:n.y});i.x+=o.j.x,i.y+=o.j.y;const r={x:i.x,y:i.y};r.x-=2*o.i.x,r.y-=2*o.i.y,e.push({start:i,end:r})}function _l(e,t,n,o){const{pixelToCanvas:a}=c.cornerstone,i=a(t,{x:n.x,y:n.y+1});i.x-=o.j.x,i.y-=o.j.y;const r={x:i.x,y:i.y};r.x+=2*o.i.x,r.y+=2*o.i.y,e.push({start:i,end:r})}function Pl(e,t,n,o){const{pixelToCanvas:a}=c.cornerstone,i=a(t,{x:n.x+1,y:n.y+1});i.x-=o.j.x,i.y-=o.j.y;const r={x:i.x,y:i.y};r.x-=2*o.i.x,r.y-=2*o.i.y,e.push({start:i,end:r})}function Dl(e,t,n,o){const{pixelToCanvas:a}=c.cornerstone,i=a(t,n),r=a(t,{x:n.x+1,y:n.y});i.x+=o.j.x,i.y+=o.j.y,r.x+=o.j.x,r.y+=o.j.y,e.push({start:i,end:r})}function kl(e,t,n,o){const{pixelToCanvas:a}=c.cornerstone,i=a(t,{x:n.x,y:n.y+1}),r=a(t,{x:n.x+1,y:n.y+1});i.x-=o.j.x,i.y-=o.j.y,r.x-=o.j.x,r.y-=o.j.y,e.push({start:i,end:r})}function Ol(e,t,n,o){const{pixelToCanvas:a}=c.cornerstone,i=a(t,n),r=a(t,{x:n.x,y:n.y+1});i.x+=o.i.x,i.y+=o.i.y,r.x+=o.i.x,r.y+=o.i.y,e.push({start:i,end:r})}function Ll(e,t,n,o){const{pixelToCanvas:a}=c.cornerstone,i=a(t,{x:n.x+1,y:n.y}),r=a(t,{x:n.x+1,y:n.y+1});i.x-=o.i.x,i.y-=o.i.y,r.x-=o.i.x,r.y-=o.i.y,e.push({start:i,end:r})}const Al=ot("segmentation");function Hl(e,t,n,o,a){(function(e){const{configuration:t}=Al;return t.renderFill&&(e&&0!==t.fillAlpha||!e&&0!==t.fillAlphaInactive)})(a)&&Cl(e,t,o,0,a),function(e){const{configuration:t}=Al;return t.renderOutline&&(e&&0!==t.outlineAlpha||!e&&0!==t.outlineAlphaInactive)}(a)&&El(e,t,o,0,a)}const Rl=ot("segmentation");var Ul=function(e){const t=e.detail.element,{configuration:n,getters:o}=Rl,{activeLabelmapIndex:a,labelmaps3D:i,currentImageIdIndex:r}=o.labelmaps3D(t);i&&(n.shouldRenderInactiveLabelmaps&&function(e,t,n,o){for(let a=0;a<t.length;a++){const i=t[a];if(a===n||!i)continue;const r=i.labelmaps2D[o];r&&Hl(e,i,0,r,!1)}}(e,i,a,r),function(e,t,n,o){const a=t[n];if(!a)return;const i=a.labelmaps2D[o];i&&Hl(e,a,0,i,!0)}(e,i,a,r))};const Fl=ot("segmentation"),Nl=function(e){const t=e.detail,n=t.element,o=et.tools.filter(e=>e.element===n&&("active"===e.mode||"passive"===e.mode||"enabled"===e.mode)),a=b(n,"stack"),i=Fl.configuration;a&&(i.renderFill||i.renderOutline)&&Ul(e);const r=t.canvasContext.canvas.getContext("2d");o.forEach(t=>{t.renderToolData&&(r.save(),t.renderToolData(e),r.restore())})};var Bl=function(e){e.addEventListener(c.cornerstone.EVENTS.IMAGE_RENDERED,Nl)},Vl=function(e){e.removeEventListener(c.cornerstone.EVENTS.IMAGE_RENDERED,Nl)},zl=function(e,t,n){if(et.isToolLocked)return!1;const o=n.detail.element;let a=et.tools.filter(t=>t.supportedInteractionTypes.includes(e));if(a=no(o,a,e),a=a.filter(e=>"function"==typeof e[t]),et.isMultiPartToolActive&&(a=ro(a)),0===a.length)return!1;a[0][t](n)},jl=function(e,t,n,o="mouse"){return t.filter(t=>{const a=Ao(o,t.name),i=b(e,t.name);for(let t=0;t<i.data.length;t++)if(void 0!==Zn(e,i.data[t].handles,n,a))return!0;return!1})},ql=function(e,t){return t.filter(t=>t.element===e&&("active"===t.mode||"passive"===t.mode))},Wl=function(e,t){return t.filter(t=>{const n=b(e,t.name);return n&&n.data.length>0})},Gl=function(e){if(et.isToolLocked)return;const t=e.detail,n=e.detail.element,o=e.detail.currentPoints.canvas,a=ql(n,tt.mouseTools());let i=a.filter(e=>"active"===e.mode&&Array.isArray(e.options.mouseButtonMask)&&e.options.mouseButtonMask.includes(t.buttons)&&e.options.isMouseActive);if(et.isMultiPartToolActive&&(i=ro(i)),i.length>0){const t=i.find(e=>"function"==typeof e.preMouseDownCallback);if(t){if(t.preMouseDownCallback(e))return}}if(et.isMultiPartToolActive)return;const r=Wl(n,a),s=jl(n,r,o,"mouse");if(s.length>0){const t=s[0],a=b(n,t.name),{handle:i,data:r}=Fo(n,a,t.name,o);return void t.handleSelectedCallback(e,r,i,"mouse")}const c=a.filter(e=>{const t=b(n,e.name);return t&&t.data&&e.pointNearTool&&t.data.some(t=>e.pointNearTool(n,t,o,"mouse"))});if(c.length>0){const t=c[0],a=b(n,t.name).data.find(e=>t.pointNearTool(n,e,o));t.toolSelectedCallback(e,a,"mouse")}else if(i.length>0){const t=i.find(e=>"function"==typeof e.postMouseDownCallback);if(t){if(t.postMouseDownCallback(e))return}}};const Yl=I("eventDispatchers:mouseEventHandlers");var Xl=function(e){if(et.isToolLocked)return;const{element:t,buttons:n}=e.detail,o=so(t,n,"mouse");if(o){if("function"==typeof o.preMouseDownActivateCallback){if(o.preMouseDownActivateCallback(e))return}et.isMultiPartToolActive||(o.addNewMeasurement?o.addNewMeasurement(e,"mouse"):o instanceof Vo&&function(e,t){Yl.log("addNewMeasurement"),e.preventDefault(),e.stopPropagation();const n=e.detail,o=n.element,a=t.createNewMeasurement(n);a&&(y(o,t.name,a),c.cornerstone.updateImage(o),(1===Object.keys(a.handles).length?Co:Do)(n,t.name,a,a.handles.end,t.options,"mouse",e=>{if(!a.cancelled)if(e){const e=l.MEASUREMENT_COMPLETED,n={toolName:t.name,toolType:t.name,element:o,measurementData:a};d(o,e,n)}else T(o,t.name,a)}))}(e,o))}},Kl=function(e){if(et.isToolLocked)return;let t;const n=e.detail,o=n.element;t=no(o,tt.mouseTools()),t=t.filter(e=>Array.isArray(e.options.mouseButtonMask)&&e.options.mouseButtonMask.includes(n.buttons)&&e.options.isMouseActive),t=t.filter(e=>"function"==typeof e.mouseDragCallback),et.isMultiPartToolActive&&(t=ro(t)),0!==t.length&&t[0].mouseDragCallback(e)},Zl=function(e){if(et.isToolLocked||et.isMultiPartToolActive)return;let t;const{element:n,currentPoints:o}=e.detail;et.mousePositionImage=o.image,t=ql(n,tt.mouseTools());const a=t.filter(e=>"active"===e.mode&&e.options.isMouseActive);let i=!1;a.length>0&&(i=a.some(e=>e.updateOnMouseMove)),t=Wl(n,t);for(let n=0;n<t.length;n++){const o=t[n];"function"==typeof o.mouseMoveCallback&&(i=o.mouseMoveCallback(e)||i)}!0===i&&c.cornerstone.updateImage(n)};const $l=zl.bind(null,"Mouse","mouseClickCallback"),Jl=zl.bind(null,"Mouse","doubleClickCallback"),Ql=zl.bind(null,"Mouse","mouseUpCallback"),ed=zl.bind(null,"MouseWheel","mouseWheelCallback");var td=function(e){e.addEventListener(l.MOUSE_CLICK,$l),e.addEventListener(l.MOUSE_DOWN,Gl),e.addEventListener(l.MOUSE_DOWN_ACTIVATE,Xl),e.addEventListener(l.MOUSE_DOUBLE_CLICK,Jl),e.addEventListener(l.MOUSE_DRAG,Kl),e.addEventListener(l.MOUSE_MOVE,Zl),e.addEventListener(l.MOUSE_UP,Ql),e.addEventListener(l.MOUSE_WHEEL,ed)},nd=function(e){e.removeEventListener(l.MOUSE_CLICK,$l),e.removeEventListener(l.MOUSE_DOWN,Gl),e.removeEventListener(l.MOUSE_DOWN_ACTIVATE,Xl),e.removeEventListener(l.MOUSE_DOUBLE_CLICK,Jl),e.removeEventListener(l.MOUSE_DRAG,Kl),e.removeEventListener(l.MOUSE_MOVE,Zl),e.removeEventListener(l.MOUSE_UP,Ql),e.removeEventListener(l.MOUSE_WHEEL,ed)};const od=function(e){if(et.isToolLocked)return!1;const t=e.detail.element,n=et.tools.filter(e=>e.element===t&&("active"===e.mode||"passive"===e.mode||"enabled"===e.mode));if(0===n.length)return!1;n.forEach(t=>{t.newImageCallback&&t.newImageCallback(e)})};var ad=function(e){e.addEventListener(c.cornerstone.EVENTS.NEW_IMAGE,od)},id=function(e){e.removeEventListener(c.cornerstone.EVENTS.NEW_IMAGE,od)},rd=function(e){if(et.isToolLocked)return!1;const{element:t,numPointers:n}=e.detail;let o=et.tools.filter(e=>e.supportedInteractionTypes.includes("MultiTouch"));if(o=no(t,o,"MultiTouch"),o=o.filter(e=>"function"==typeof e.multiTouchDragCallback&&n===e.configuration.touchPointers),et.isMultiPartToolActive&&(o=ro(o)),0===o.length)return!1;o[0].multiTouchDragCallback(e)};const sd=I("eventDispatchers:touchEventHandlers");var cd=function(e){if(et.isToolLocked||et.isMultiPartToolActive)return;const t=so(e.detail.element,null,"touch");t&&t.addNewMeasurement?t.addNewMeasurement(e,"touch"):t instanceof Vo&&function(e,t){sd.log("addNewMeasurement"),e.preventDefault(),e.stopPropagation();const n=e.detail,o=n.element,a=t.createNewMeasurement(n);if(a){if(y(o,t.name,a),1===Object.keys(a.handles).length&&n.type===l.TAP){return a.active=!1,a.handles.end.active=!1,a.handles.end.highlight=!1,a.invalidated=!0,(et.deleteIfHandleOutsideImage||t.options.deleteIfHandleOutsideImage)&&eo(n,a.handles)&&T(o,t.name,a),void c.cornerstone.updateImage(o)}c.cornerstone.updateImage(o),Do(n,t.name,a,a.handles.end,t.options,"touch",()=>{const e=l.MEASUREMENT_COMPLETED,n={toolName:t.name,toolType:t.name,element:o,measurementData:a};d(o,e,n)})}}(e,t)},ld=function(e){if(e)for(let t=0;t<e.data.length;t++){const n=e.data[t];n.active=!1,n.handles&&dd(n.handles)}};function dd(e){Object.keys(e).forEach((function(t){e[t].active=!1}))}var ud=function(e){if(et.isToolLocked||et.isMultiPartToolActive)return;let t;const n=e.detail.element,o=e.detail.currentPoints.canvas;t=no(n,tt.touchTools()),t=Wl(n,t);const a=t.filter(e=>{const t=b(n,e.name);for(let e=0;e<t.data.length;e++)if(void 0!==Zn(n,t.data[e].handles,o,28))return!0;return!1});if(a.length>0){const t=a[0],i=b(n,t.name),r=i.data.find(e=>void 0!==Zn(n,e.handles,o,28));return i.data.active=!0,r.active=!0,c.cornerstone.updateImage(n),Co(e.detail,t.name,i.data,r,t.options,"touch",()=>ld(i)),e.stopImmediatePropagation(),void e.preventDefault()}const i=t.filter(e=>{const t=b(n,e.name);return t&&t.data&&e.pointNearTool&&t.data.some(t=>e.pointNearTool(n,t,o))});if(i.length>0){const t=i[0],a=b(n,t.name),r=a.data.find(e=>t.pointNearTool(n,e,o));return r.active=!0,c.cornerstone.updateImage(n),go(e.detail,t.name,r,0,t.options,"touch",()=>ld(a)),e.stopImmediatePropagation(),void e.preventDefault()}const r=no(n,tt.touchTools());return r.length>0&&r[0].touchStartActiveCallback?r[0].touchStartActiveCallback(e):cd(e),!1},hd=function(e){if(et.isToolLocked)return;const t=e.detail,n=t.element,o=t.startPoints.canvas,a=ql(n,tt.touchTools());let i=a.filter(e=>"active"===e.mode&&e.options.isTouchActive);if(et.isMultiPartToolActive&&(i=ro(i)),i.length>0){const t=i.find(e=>"function"==typeof e.preTouchStartCallback);if(t){if(t.preTouchStartCallback(e))return}}if(et.isMultiPartToolActive)return;const r=Wl(n,a),s=jl(n,r,o,"touch");if(s.length>0){const t=s[0],a=b(n,t.name),{handle:i,data:r}=Fo(n,a,t.name,o,"touch");return void t.handleSelectedCallback(e,r,i,"touch")}const c=r.filter(e=>{const t=b(n,e.name);return t&&t.data&&e.pointNearTool&&t.data.some(t=>e.pointNearTool(n,t,o,"touch"))});if(c.length>0){const t=c[0],a=b(n,t.name).data.find(e=>t.pointNearTool(n,e,o));t.toolSelectedCallback(e,a,"touch")}else if(i.length>0){const t=i.find(e=>"function"==typeof e.postTouchStartCallback);if(t){if(t.postTouchStartCallback(e))return}}};const gd=zl.bind(null,"DoubleTap","doubleTapCallback"),md=zl.bind(null,"Touch","touchDragCallback"),fd=zl.bind(null,"Touch","touchEndCallback"),pd=zl.bind(null,"TouchPinch","touchPinchCallback"),vd=zl.bind(null,"Touch","touchPressCallback"),xd=zl.bind(null,"TouchRotate","touchRotateCallback");var yd=function(e){e.addEventListener(l.TAP,ud),e.addEventListener(l.TOUCH_START,hd,{passive:!1}),e.addEventListener(l.TOUCH_DRAG,md,{passive:!1}),e.addEventListener(l.TOUCH_END,fd),e.addEventListener(l.TOUCH_START_ACTIVE,cd),e.addEventListener(l.TOUCH_PRESS,vd),e.addEventListener(l.DOUBLE_TAP,gd),e.addEventListener(l.TOUCH_PINCH,pd),e.addEventListener(l.TOUCH_ROTATE,xd),e.addEventListener(l.MULTI_TOUCH_DRAG,rd)},bd=function(e){e.removeEventListener(l.TAP,ud),e.removeEventListener(l.TOUCH_START,hd),e.removeEventListener(l.TOUCH_DRAG,md),e.removeEventListener(l.TOUCH_END,fd),e.removeEventListener(l.TOUCH_START_ACTIVE,cd),e.removeEventListener(l.TOUCH_PRESS,vd),e.removeEventListener(l.DOUBLE_TAP,gd),e.removeEventListener(l.TOUCH_PINCH,pd),e.removeEventListener(l.TOUCH_ROTATE,xd),e.removeEventListener(l.MULTI_TOUCH_DRAG,rd)};const Td=I("addTool"),Cd=function(e,t,n){const o=new t(n);it(e,o.name)?Td.warn("%s has already been added to the target element",o.name):(o.element=e,at.state.tools.push(o))},Md=function(e,t){Ed(e,t),at.state.enabledElements.forEach(n=>{Cd(n,e,t)})},Ed=function(e,t){const{configuration:n}=ot("globalConfiguration");if(!n.globalToolSyncEnabled)return;const o=new e(t);void 0!==at.state.globalTools[o.name]?Td.warn("%s has already been added globally",o.name):at.state.globalTools[o.name]={tool:e,props:t,activeBindings:[]}},wd=I("internals:addEnabledElement");var Id=function(e){wd.log("EVENT:ELEMENT_ENABLED");const t=e.detail.element;Bl(t),ad(t);const{configuration:n}=ot("globalConfiguration");n.mouseEnabled&&(zc.enable(t),Wc.enable(t),td(t)),n.touchEnabled&&(bl.enable(t),yd(t)),Sd(t)};const Sd=function(e){at.state.enabledElements.push(e),at.modules&&function(e){const t=at.modules;Object.keys(t).forEach((function(n){"function"==typeof t[n].enabledElementCallback&&t[n].enabledElementCallback(e)}))}(e),function(e){const{configuration:t}=ot("globalConfiguration");if(!t.globalToolSyncEnabled)return;Object.keys(at.state.globalTools).forEach((function(t){const{tool:n,props:o}=at.state.globalTools[t];Cd(e,n,o)}))}(e),function(e){const{configuration:t}=ot("globalConfiguration");if(!t.globalToolSyncEnabled)return;const n={active:ht,passive:xt,enabled:pt,disabled:mt};at.state.globalToolChangeHistory.forEach(t=>{const o=t.args.slice(0);o.unshift(e),n[t.mode].apply(null,o)})}(e)};const _d=I("internals:removeEnabledElement");var Pd=function(e){_d.log("EVENT:ELEMENT_DISABLED");const t=e.detail.element,{configuration:n}=ot("globalConfiguration");Vl(t),id(t),n.mouseEnabled&&(zc.disable(t),Wc.disable(t),nd(t)),n.touchEnabled&&(bl.disable(t),bd(t)),Dd(t),kd(t),Od(t)};const Dd=function(e){at.state.tools.forEach(t=>{t.element===e&&mt(t.element,t.name)}),at.state.tools=at.state.tools.filter(t=>t.element!==e)},kd=function(e){at.modules&&function(e){const t=at.modules;Object.keys(t).forEach((function(n){"function"==typeof t[n].removeEnabledElementCallback&&t[n].removeEnabledElementCallback(e)}))}(e);const t=at.state.enabledElements.findIndex(t=>t===e);t>-1?at.state.enabledElements.splice(t,1):_d.warn("unable to remove element")},Od=function(e){Ts.removeHandlers(e)};const Ld=function(){window.removeEventListener("resize",Hd,!1)};let Ad;function Hd(){Ad||(Ad=setTimeout((function(){Ad=null,Rd()}),66))}const Rd=function(){et.enabledElements.forEach(e=>{c.cornerstone.resize(e)})};var Ud=function(){Ld(),window.addEventListener("resize",Hd,!1)},Fd=function(e={}){!function(){!function(){const e=c.cornerstone,t=e.EVENTS.ELEMENT_ENABLED,n=e.EVENTS.ELEMENT_DISABLED;e.events.removeEventListener(t,Id),e.events.removeEventListener(n,Pd)}();const e=c.cornerstone,t=e.EVENTS.ELEMENT_ENABLED,n=e.EVENTS.ELEMENT_DISABLED;e.events.addEventListener(t,Id),e.events.addEventListener(n,Pd)}(),function(){const e=at.modules;Object.keys(e).forEach((function(t){"function"==typeof e[t].onRegisterCallback&&e[t].onRegisterCallback()}))}();const t=ot("globalConfiguration");Array.isArray(e)?e.forEach(e=>{const{moduleName:t,configuration:n}=e,o=ot(t);o&&(o.configuration=Object.assign({},o.configuration,n))}):t.configuration=Object.assign({},t.configuration,e),t.configuration.autoResizeViewports&&Ud()};const Nd=I("stackTools:stackPrefetch");let Bd,Vd={maxImagesToPrefetch:1/0,preserveExistingPool:!1};function zd(e,t){e=Math.round(e)||0;const n=[];let o=(t=Math.round(t)||0)-e+1;if(o<=0)return n;for(;o--;)n[o]=t--;return n}function jd(e){const t=b(e,"stack");if(!t||!t.data||!t.data.length)return;const n=t.data[0],o=b(e,"stackPrefetch");if(!o)return;const a=o.data[0]||{};if(a.indicesToRequest&&a.indicesToRequest.length||(a.enabled=!1),!1===a.enabled)return;function i(e){const t=a.indicesToRequest.indexOf(e);t>-1&&a.indicesToRequest.splice(t,1)}if(o.data[0].indicesToRequest.sort((e,t)=>e-t),a.indicesToRequest.slice().forEach((function(e){const t=n.imageIds[e];t&&c.cornerstone.imageCache.getImageLoadObject(t)&&i(e)})),!a.indicesToRequest.length)return;Vd.preserveExistingPool||c.cornerstone.imageLoadPoolManager.clearRequestStack("prefetch");const r=function(e,t){let n=0,o=e.length-1;return e.forEach((e,a)=>{e<t?n=Math.max(a,n):e>t&&(o=Math.min(a,o))}),{low:n,high:o}}(a.indicesToRequest,n.currentImageIdIndex);let s,l;Ts.getErrorLoadingHandler(e);let d=r.low,u=r.high;const h=[];for(;d>=0||u<a.indicesToRequest.length;){const e=n.currentImageIdIndex,t=e-a.indicesToRequest[d]>Vd.maxImagesToPrefetch,o=a.indicesToRequest[u]-e>Vd.maxImagesToPrefetch,i=!t&&d>=0,r=!o&&u<a.indicesToRequest.length;if(!r&&!i)break;i&&(l=a.indicesToRequest[d--],s=n.imageIds[l],h.push(s)),r&&(l=a.indicesToRequest[u++],s=n.imageIds[l],h.push(s))}let g;const m={addToBeginning:!0,priority:0,requestType:"prefetch"};g=e=>c.cornerstone.loadAndCacheImage(e,m),h.reverse().forEach(e=>{c.cornerstone.imageLoadPoolManager.addRequest(g.bind(null,e),"prefetch",{imageId:e},0,!0)})}function qd(e){return function(t){const n=t.detail;let o;try{o=b(e,"stack")}catch(e){return}if(!o||!o.data||!o.data.length)return;const a=o.data[0].imageIds.indexOf(n.imageId);if(a<0)return;const i=b(e,"stackPrefetch");i&&i.data&&i.data.length&&i.data[0].indicesToRequest.push(a)}}function Wd(e){clearTimeout(Bd),Bd=setTimeout((function(){const t=e.target;try{jd(t)}catch(e){return}}),10)}var Gd={enable:function(e){b(e,"stackPrefetch").data=[];const t=b(e,"stack");if(!t||!t.data||!t.data.length)return;const n=t.data[0];if(!0===n.preventCache)return void Nd.warn("A stack that should not be cached was given the stackPrefetch");const o={indicesToRequest:zd(0,n.imageIds.length-1),enabled:!0,direction:1},a=o.indicesToRequest.indexOf(n.currentImageIdIndex);o.indicesToRequest.splice(a,1),y(e,"stackPrefetch",o),jd(e),e.removeEventListener(c.cornerstone.EVENTS.NEW_IMAGE,Wd),e.addEventListener(c.cornerstone.EVENTS.NEW_IMAGE,Wd);const i=qd(e);c.cornerstone.events.removeEventListener(c.cornerstone.EVENTS.IMAGE_CACHE_PROMISE_REMOVED,i),c.cornerstone.events.addEventListener(c.cornerstone.EVENTS.IMAGE_CACHE_PROMISE_REMOVED,i)},disable:function(e){clearTimeout(Bd),e.removeEventListener(c.cornerstone.EVENTS.NEW_IMAGE,Wd);const t=qd(e);c.cornerstone.events.removeEventListener(c.cornerstone.EVENTS.IMAGE_CACHE_PROMISE_REMOVED,t);const n=b(e,"stackPrefetch");n&&n.data.length&&(n.data[0].enabled=!1,c.cornerstone.imageLoadPoolManager.clearRequestStack("prefetch"))},getConfiguration:function(){return Vd},setConfiguration:function(e){Vd=e}};const Yd={FusionRenderer:class{constructor(){this.currentImageIdIndex=0,this.layerIds=[],this.findImageFn=void 0}render(e,t){if(!Number.isInteger(this.currentImageIdIndex))throw new Error("FusionRenderer: render - Image ID Index is not an integer");if(!this.findImageFn)throw new Error("No findImage function has been defined");if(!t){t=b(e,"stack").data}const n=c.cornerstone,o=t[0],a=o.imageIds[this.currentImageIdIndex],i=t.slice(1,t.length);n.loadAndCacheImage(a).then(t=>{let r=this.layerIds[0];r?n.setLayerImage(e,t,r):(r=n.addLayer(e,t,o.options),this.layerIds.push(r)),n.displayImage(e,t),i.forEach((t,o)=>{const i=this.findImageFn(t.imageIds,a),s=o+1;let c=this.layerIds[s];c||(c=n.addLayer(e,void 0,t.options),this.layerIds.push(c)),i?n.loadAndCacheImage(i).then(t=>{n.setLayerImage(e,t,c),n.updateImage(e)}):(n.setLayerImage(e,void 0,c),n.setActiveLayer(e,r),n.updateImage(e))})})}}};var Xd=Yd;function Kd(e){const t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}function Zd(e,t){let n,o;if(void 0===e)throw new Error("playClip: element must not be undefined");const a=b(e,"stack");if(!a||!a.data||!a.data.length)return;const i=c.cornerstone;let r;if(a.data.length>1){const t=b(e,"stackRenderer");t&&t.data&&t.data.length&&(r=t.data[0])}const s=a.data[0],u=b(e,"playClip");u&&u.data&&u.data.length?(n=u.data[0],Kd(n)):(n={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,frameRate:0,frameTimeVector:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,speed:1,reverse:!1,loop:!0},y(e,"playClip",n)),(t<0||t>0)&&(n.framesPerSecond=Number(t),n.reverse=n.framesPerSecond<0,n.ignoreFrameTimeVector=!0),!0!==n.ignoreFrameTimeVector&&n.frameTimeVector&&n.frameTimeVector.length===s.imageIds.length&&(o=function(e,t){let n,o,a,i=0;const r=e.length,s=[];for(s.isTimeVarying=!1,("number"!=typeof t||t<=0)&&(t=1),n=1;n<r;n++)a=Number(e[n])/t|0,s.push(a),1===n?o=a:a!==o&&(s.isTimeVarying=!0),i+=a;return s.length>0&&(a=s.isTimeVarying?i/s.length|0:s[0],s.push(a)),s}(n.frameTimeVector,n.speed));const h=()=>{let t,o,c,u,h=s.currentImageIdIndex;const g=s.imageIds.length;if(n.reverse?h--:h++,!n.loop&&(h<0||h>=g))return Kd(n),void function(e){d(e,l.CLIP_STOPPED,{element:e})}(e);h>=g&&(h=0),h<0&&(h=g-1),h!==s.currentImageIdIndex&&(o=Ts.getStartLoadHandler(e),c=Ts.getEndLoadHandler(e),u=Ts.getErrorLoadingHandler(e),o&&o(e),t=!0===s.preventCache?i.loadImage(s.imageIds[h]):i.loadAndCacheImage(s.imageIds[h]),t.then((function(t){try{s.currentImageIdIndex=h,r?(r.currentImageIdIndex=h,r.render(e,a.data)):i.displayImage(e,t),c&&c(e,t)}catch(e){return}}),(function(t){const n=s.imageIds[h];u&&u(e,n,t)})))};o&&o.length>0&&o.isTimeVarying?(n.usingFrameTimeVector=!0,n.intervalId=setTimeout((function e(){n.intervalId=setTimeout(e,o[s.currentImageIdIndex]),h()}),0)):(n.usingFrameTimeVector=!1,n.intervalId=setInterval(h,1e3/Math.abs(n.framesPerSecond)))}function $d(e){const t=b(e,"playClip");t&&t.data&&t.data.length&&Kd(t.data[0])}const Jd=function(e,t){const n=at.state.tools.findIndex(n=>n.element===e&&n.name===t);n>=0&&at.state.tools.splice(n,1)},Qd=function(e){eu(e),at.state.enabledElements.forEach(t=>{Jd(t,e)})},eu=function(e){const{configuration:t}=ot("globalConfiguration");t.globalToolSyncEnabled&&at.state.globalTools[e]&&delete at.state.globalTools[e]},tu=function(e,t,n){const o=it(e,t);o&&o.mergeOptions(n)},nu=function(e,t){et.enabledElements.forEach(n=>{tu(n,e,t)})};function ou(e,t){let n={};return{get:function(o,a){return e.indexOf(a)>=0?(!1===n.hasOwnProperty(a)&&(n[a]={data:[]}),n[a]):t.get(o,a)},add:function(o,a,i){if(!(e.indexOf(a)>=0))return t.add(o,a,i);!1===n.hasOwnProperty(a)&&(n[a]={data:[]}),n[a].data.push(i)},saveToolState:function(){return n},restoreToolState:function(e){n=e},toolState:n}}const au=[];function iu(e,t){let n=x(e);n||(n=v);let o=["stack","stackPrefetch","playClip","volume","slab","referenceLines","crosshairs","stackRenderer"];t&&(o=o.concat(t));const a=ou(o,n);au.push(a),M(e,a)}const ru={newStackSpecificToolStateManager:ou,addStackStateManager:iu};function su(){const e={};return{get:function(t,n){if(!1===e.hasOwnProperty(t))return;const o=e[t];return!1!==o.hasOwnProperty(n)?o[n]:void 0},add:function(t,n,o){!1===e.hasOwnProperty(t)&&(e[t]={});const a=e[t];!1===a.hasOwnProperty(n)&&(a[n]={data:[]}),a[n].data.push(o)},remove:function(t,n,o){if(!1===e.hasOwnProperty(t))return;const a=e[t];if(!1===a.hasOwnProperty(n))return;const i=a[n];let r=-1;for(let e=0;e<i.data.length;e++)i.data[e]===o&&(r=e);-1!==r&&i.data.splice(r,1)}}}const cu=su();var lu=(e,t,n="image/png")=>{const o=e.querySelector("canvas");if(o.msToBlob){const e=o.msToBlob();return window.navigator.msSaveBlob(e,t)}const a=document.createElement("a");if(a.download=t,a.href=o.toDataURL(n,1),document.createEvent){const e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(e)}else a.fireEvent&&a.fireEvent("onclick")};const du=I("thirdParty:registerModule");var uu=function(e,t,n=!1){const o=function(e){return void 0!==nt[e]}(e);!o||n?(o&&du.warn("Overwriting module %s",e),nt[e]=t,"function"==typeof nt[e].onRegisterCallback&&nt[e].onRegisterCallback()):du.warn("A module with the name %s is already registered",e)};function hu(){const e=navigator.userAgent;let t,n=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?(t=/\brv[ :]+(\d+)/g.exec(e)||[],"IE ".concat(t[1]||"")):"Chrome"===n[1]&&(t=e.match(/\b(OPR|Edge)\/(\d+)/),null!==t)?t.slice(1).join(" ").replace("OPR","Opera"):(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(t=e.match(/version\/(\d+)/i))&&n.splice(1,1,t[1]),n.join(" "))}const gu={"base/BaseTool":Yn,"base/BaseAnnotationTool":Vo,"base/BaseBrushTool":io,"tools/cursors/MouseCursor":Wo,"tools/cursors":a,"manipulators/anyHandlesOutsideImage":eo,"manipulators/getHandleNearImagePoint":Zn,"manipulators/getHandlePixelPosition":to,"manipulators/handleActivator":$n,"manipulators/moveAllHandles":go,"manipulators/moveHandle":Co,"manipulators/moveNewHandle":Do,"manipulators/moveHandleNearImagePoint":Uo,"manipulators/findHandleDataNearImagePoint":Fo,"manipulators/moveAnnotation":No,"mixins/activeOrDisabledBinaryTool":Nn.activeOrDisabledBinaryTool,"mixins/enabledOrDisabledBinaryTool":Nn.enabledOrDisabledBinaryTool,"drawing/getNewContext":hn,"drawing/draw":_t,"drawing/path":Ot,"drawing/setShadow":mn,"drawing/drawLine":Lt,"drawing/drawLines":Xt,"drawing/drawJoinedLines":At,"drawing/drawCircle":Rt,"drawing/drawEllipse":zt,"drawing/drawRect":un,"drawing/fillOutsideRect":function(e,t,n,o,a,i="pixel"){if("pixel"===i){const e=c.cornerstone;n=e.pixelToCanvas(t,n),o=e.pixelToCanvas(t,o)}const r=Math.min(n.x,o.x),s=Math.min(n.y,o.y),l=Math.abs(n.x-o.x),d=Math.abs(n.y-o.y);Ot(e,a,e=>{e.rect(0,0,e.canvas.clientWidth,e.canvas.clientHeight),e.rect(r+l,s,-l,d)})},"drawing/drawTextBox":on,"drawing/drawArrow":Ht,"drawing/fillBox":tn,"drawing/fillTextLines":en,"drawing/drawLink":Kt,"drawing/drawLinkedTextBox":dn,"drawing/drawHandles":Yt,"drawing/textBoxWidth":nn,"util/getActiveTool":so,"util/getLuminance":uc,"util/getROITextBoxCoords":ki,"util/copyPoints":Dc,"util/calculateSUV":Ii,"util/setContextToDisplayFontSize":function(e,t,n){return c.cornerstone.setToPixelCoordinateSystem(e,t,.1),{fontSize:n/e.viewport.scale/.1,lineHeight:n/e.viewport.scale/.1,fontScale:.1}},"util/scrollToIndex":rc,"util/scroll":sc,"util/roundToDecimal":jo,"util/projectPatientPointToImagePlane":Ft,"util/imagePointToPatientPoint":Nt,"util/planePlaneIntersection":Bt,"util/pointInsideBoundingBox":Xn,"util/makeUnselectable":function(e,t){e.style.webkitUserSelect="none",e.style.webkitTouchCallout="none",e.style.mozUserSelect="none",e.style.msUserSelect="none",e.style.oUserSelect="none",e.style.khtmlUserSelect="none",e.style.userSelect="none",e.unselectable="on",e.oncontextmenu=()=>!1,!0===t&&(e.style.pointerEvents="none")},"util/getRGBPixels":Tr,"util/getBrowserInfo":hu,"util/isMobileDevice":function(){return new RegExp("Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini").test(navigator.userAgent)},"util/angleBetweenPoints":Ks,"util/numbersWithCommas":Oi,"util/lineSegDistance":zo,"util/triggerEvent":d,"util/convertToVector3":Ut,"util/clip":an,"util/clipToBox":rn,"util/clipBoxToDisplayedArea":cn,"util/debounce":La,"util/deepmerge":qn,"util/getDefault":gn,"util/getProximityThreshold":Ao,"util/getPixelSpacing":ka,"util/isEmptyObject":fn,"util/isObject":Oa,"util/isPointInImage":Pe,"util/isPointInPolygon":zr,"util/getLogger":I,"util/throttle":Aa,"util/wait":Ws,"util/waitForEnabledElementImageToLoad":Gs,"util/getKeyPressData":function(e){const t=c.cornerstone,n=e.currentTarget,o=t.getEnabledElement(n);if(!o||!o.image)return;const a=at.state.mousePositionImage;return{event:window.event||e,element:n,viewport:t.getViewport(n),image:o.image,currentPoints:{image:a,canvas:t.pixelToCanvas(n,a)},keyCode:e.keyCode,which:e.which}},"util/ellipseUtils":Di,"util/freehandUtils":dr,"util/segmentationUtils":o,"util/zoomUtils":yc},mu=I("thirdParty:registerMixin");var fu=function(e,t,n=!1){const o=function(e){return void 0!==Nn[e]}(e);!o||n?(o&&mu.warn("Overwriting mixins/%s",e),Nn[e]=t,gu["mixins/".concat(e)]=Nn[e]):mu.warn("mixins/%s is already registered",e)};const pu=I("thirdParty:registerType");var vu=function(e,t,n,o=!1){const a="".concat(e,"/").concat(t),i=function(e){return void 0!==gu[e]}(a);!i||o?(i&&pu.warn("Overwriting %s",a),gu[a]=n):pu.warn("%s is already registered",a)};const xu=I("thirdParty:register");var yu=function(e,t,n,o=!1){if(function(e,t,n){if(!e)return xu.warn("The type must be given in order to register."),!1;if(!t)return xu.warn("The %s must have a name in order to register.",e),!1;if("object"!=typeof n&&"function"!=typeof n)return xu.warn("The %s is a %s, it should be an Object or a function.",n,typeof n),!1;return!0}(e,t,n))switch(e){case"module":uu(t,n,o);break;case"mixin":fu(t,n,o);break;default:vu(e,t,n,o)}};var bu=function(e,t=!1){e.forEach(({type:e,name:n,item:o})=>{yu(e,n,o,t)})},Tu=function(e,t,n){if(n===t)return;const o=c.cornerstone,a=o.getViewport(t),i=o.getViewport(n);i.voi.windowWidth===a.voi.windowWidth&&i.voi.windowCenter===a.voi.windowCenter&&i.invert===a.invert||(i.voi.windowWidth=a.voi.windowWidth,i.voi.windowCenter=a.voi.windowCenter,i.invert=a.invert,e.setViewport(n,i))},Cu=function(e,t,n){n!==t&&c.cornerstone.updateImage(n)};function Mu(e){return e.filter((function(e,t,n){return n.indexOf(e)===t}))}var Eu=function(e,t){c.cornerstone;const n=this,o=[],a=[];let i=!1;const r={};let s=t;function l(e){const t=e.detail.element;n.remove(t),function(e){for(const t in Cs)Cs[t]=Cs[t].filter(t=>t.element!==e)}(t)}this.enabled=!0,this.setHandler=function(e){s=e},this.getHandler=function(){return s},this.getDistances=function(){if(!o.length||!a.length)return;const e=c.cornerstone;r.distances={},r.imageIds={sourceElements:[],targetElements:[]},o.forEach((function(t){const n=e.getEnabledElement(t);if(!n||!n.image)return;const o=n.image.imageId,i=e.metaData.get("imagePlaneModule",o);if(!i||!i.imagePositionPatient)return;const s=Ut(i.imagePositionPatient);r.hasOwnProperty(n)||(r.distances[o]={},r.imageIds.sourceElements.push(o),a.forEach((function(n){const a=e.getEnabledElement(n);if(!a||!a.image)return;const i=a.image.imageId;if(r.imageIds.targetElements.push(i),t===n)return;if(o===i)return;if(r.distances[o].hasOwnProperty(i))return;const c=e.metaData.get("imagePlaneModule",i);if(!c||!c.imagePositionPatient)return;const l=Ut(c.imagePositionPatient);r.distances[o][i]=l.clone().sub(s)})),Object.keys(r.distances[o]).length||delete r.distances[o])}))},this.fireEvent=function(e,t){const c=!n.enabled,l=!o.length||!a.length;c||l||(i=!0,a.forEach((function(i){const c=a.indexOf(i);if(-1===c)return;const l=r.imageIds.targetElements[c],d=o.indexOf(e);if(-1===d)return;const u=r.imageIds.sourceElements[d];let h;u===l?h=0:void 0!==r.distances[u]&&(h=r.distances[u][l]),s(n,e,i,t,h)})),i=!1)},this.onEvent=function(e){const t=e.detail;!0!==i&&n.fireEvent(e.currentTarget,t)},this.addSource=function(t){-1===o.indexOf(t)&&(o.push(t),e.split(" ").forEach(e=>{t.addEventListener(e,n.onEvent)}),n.getDistances(),n.updateDisableHandlers())},this.addTarget=function(e){-1===a.indexOf(e)&&(a.push(e),n.getDistances(),s(n,e,e,0),n.updateDisableHandlers())},this.add=function(e){n.addSource(e),n.addTarget(e)},this.removeSource=function(t){const a=o.indexOf(t);-1!==a&&(o.splice(a,1),e.split(" ").forEach(e=>{t.removeEventListener(e,n.onEvent)}),n.getDistances(),n.fireEvent(t),n.updateDisableHandlers())},this.removeTarget=function(e){const t=a.indexOf(e);-1!==t&&(a.splice(t,1),n.getDistances(),s(n,e,e,0),n.updateDisableHandlers())},this.remove=function(e){n.removeTarget(e),n.removeSource(e)},this.getSourceElements=function(){return o},this.getTargetElements=function(){return a},this.displayImage=function(e,t,n){i=!0,c.cornerstone.displayImage(e,t,n),i=!1},this.setViewport=function(e,t){i=!0,c.cornerstone.setViewport(e,t),i=!1},this.updateDisableHandlers=function(){Mu(o.concat(a)).forEach((function(e){e.removeEventListener(c.cornerstone.EVENTS.ELEMENT_DISABLED,l),e.addEventListener(c.cornerstone.EVENTS.ELEMENT_DISABLED,l)}))},this.destroy=function(){Mu(o.concat(a)).forEach((function(e){n.remove(e)}))}},wu=function(e,t,n,o){if(t===n)return;if(!o||!o.direction)return;const a=c.cornerstone,i=b(n,"stack").data[0];let r=i.currentImageIdIndex+o.direction;if(r=ln(r,0,i.imageIds.length-1),i.currentImageIdIndex===r)return;const s=Ts.getStartLoadHandler(n),l=Ts.getEndLoadHandler(n),d=Ts.getErrorLoadingHandler(n);i.currentImageIdIndex=r;const u=i.imageIds[r];let h;s&&s(n),h=!0===i.preventCache?a.loadImage(u):a.loadAndCacheImage(u),h.then((function(t){const o=a.getViewport(n);i.currentImageIdIndex===r&&(e.displayImage(n,t,o),l&&l(n,t))}),(function(e){const t=i.imageIds[r];d&&d(n,t,e)}))},Iu=function(e,t,n){if(n===t)return;const o=c.cornerstone,a=b(t,"stack").data[0],i=a.imageIds[a.currentImageIdIndex],r=o.metaData.get("imagePlaneModule",i);if(void 0===r||void 0===r.imagePositionPatient)return;const s=Ut(r.imagePositionPatient),l=b(n,"stack").data[0];let d=Number.MAX_VALUE,u=-1;if(l.imageIds.forEach((e,t)=>{const n=o.metaData.get("imagePlaneModule",e);if(void 0===n||void 0===n.imagePositionPatient)return;const a=Ut(n.imagePositionPatient).distanceToSquared(s);a<d&&(d=a,u=t)}),u===l.currentImageIdIndex)return;const h=Ts.getStartLoadHandler(n),g=Ts.getEndLoadHandler(n),m=Ts.getErrorLoadingHandler(n);l.currentImageIdIndex=u;const f=l.imageIds[u];if(h&&h(n),-1!==u){let t;t=!0===l.preventCache?o.loadImage(f):o.loadAndCacheImage(f),t.then((function(t){const a=o.getViewport(n);l.currentImageIdIndex===u&&(e.displayImage(n,t,a),g&&g(n,t))}),(function(e){const t=l.imageIds[u];m&&m(n,t,e)}))}},Su=function(e,t,n,o,a){if(n===t)return;const i=c.cornerstone,r=b(t,"stack").data[0],s=r.imageIds[r.currentImageIdIndex],l=i.metaData.get("imagePlaneModule",s);if(void 0===l||void 0===l.imagePositionPatient)return;const d=Ut(l.imagePositionPatient),u=b(n,"stack").data[0];let h=Number.MAX_VALUE,g=-1;if(!a)return;const m=d.clone().add(a);if(u.imageIds.forEach((function(e,t){const n=i.metaData.get("imagePlaneModule",e);if(void 0===n||void 0===n.imagePositionPatient)return;const o=Ut(n.imagePositionPatient),a=m.distanceToSquared(o);a<h&&(h=a,g=t)})),g===u.currentImageIdIndex||-1===g)return;const f=Ts.getStartLoadHandler(n),p=Ts.getEndLoadHandler(n),v=Ts.getErrorLoadingHandler(n);u.currentImageIdIndex=g;const x=u.imageIds[g];let y;f&&f(n),y=!0===u.preventCache?i.loadImage(x):i.loadAndCacheImage(x),y.then((function(t){const o=i.getViewport(n);u.currentImageIdIndex===g&&(e.displayImage(n,t,o),p&&p(n,t))}),(function(e){const t=u.imageIds[g];v&&v(n,t,e)}))},_u=function(e,t,n){if(n===t)return;const o=c.cornerstone,a=b(t,"stack").data[0],i=b(n,"stack").data[0];let r=a.currentImageIdIndex;if(r=ln(r,0,i.imageIds.length-1),r===i.currentImageIdIndex)return;const s=Ts.getStartLoadHandler(n),l=Ts.getEndLoadHandler(n),d=Ts.getErrorLoadingHandler(n);let u;s&&s(n),u=!0===i.preventCache?o.loadImage(i.imageIds[r]):o.loadAndCacheImage(i.imageIds[r]),u.then((function(t){const a=o.getViewport(n);i.currentImageIdIndex=r,e.displayImage(n,t,a),l&&l(n,t)}),(function(e){const t=i.imageIds[r];d&&d(n,t,e)}))},Pu=function(e,t,n){if(n===t)return;const o=c.cornerstone,a=o.getViewport(t),i=o.getViewport(n);i.scale===a.scale&&i.translation.x===a.translation.x&&i.translation.y===a.translation.y||(i.scale=a.scale,i.translation.x=a.translation.x,i.translation.y=a.translation.y,e.setViewport(n,i))},Du="0.0.0-semantically-released",ku=function(e){return gu[e]};n.d(t,"AngleTool",(function(){return Ha})),n.d(t,"ArrowAnnotateTool",(function(){return Fa})),n.d(t,"BidirectionalTool",(function(){return wi})),n.d(t,"CircleRoiTool",(function(){return Ai})),n.d(t,"CobbAngleTool",(function(){return Fi})),n.d(t,"EllipticalRoiTool",(function(){return Bi})),n.d(t,"FreehandRoiTool",(function(){return vr})),n.d(t,"LengthTool",(function(){return br})),n.d(t,"ProbeTool",(function(){return Mr})),n.d(t,"RectangleRoiTool",(function(){return wr})),n.d(t,"TextMarkerTool",(function(){return Dr})),n.d(t,"BrushTool",(function(){return Lr})),n.d(t,"SphericalBrushTool",(function(){return Rr})),n.d(t,"RectangleScissorsTool",(function(){return ms})),n.d(t,"FreehandScissorsTool",(function(){return gs})),n.d(t,"CircleScissorsTool",(function(){return fs})),n.d(t,"CorrectionScissorsTool",(function(){return ps})),n.d(t,"CrosshairsTool",(function(){return ws})),n.d(t,"DoubleTapFitToWindowTool",(function(){return Is})),n.d(t,"DragProbeTool",(function(){return Ss})),n.d(t,"EraserTool",(function(){return Ds})),n.d(t,"FreehandRoiSculptorTool",(function(){return Os})),n.d(t,"MagnifyTool",(function(){return Ls})),n.d(t,"OverlayTool",(function(){return Hs})),n.d(t,"OrientationMarkersTool",(function(){return Us})),n.d(t,"PanMultiTouchTool",(function(){return zs})),n.d(t,"PanTool",(function(){return js})),n.d(t,"ReferenceLinesTool",(function(){return Xs})),n.d(t,"RotateTool",(function(){return Zs})),n.d(t,"RotateTouchTool",(function(){return ec})),n.d(t,"ScaleOverlayTool",(function(){return nc})),n.d(t,"StackScrollMouseWheelTool",(function(){return cc})),n.d(t,"StackScrollMultiTouchTool",(function(){return lc})),n.d(t,"StackScrollTool",(function(){return dc})),n.d(t,"WwwcRegionTool",(function(){return hc})),n.d(t,"WwwcTool",(function(){return pc})),n.d(t,"ZoomMouseWheelTool",(function(){return bc})),n.d(t,"ZoomTool",(function(){return Mc})),n.d(t,"ZoomTouchPinchTool",(function(){return Pc})),n.d(t,"init",(function(){return Fd})),n.d(t,"stackPrefetch",(function(){return Gd})),n.d(t,"stackRenderers",(function(){return Xd})),n.d(t,"playClip",(function(){return Zd})),n.d(t,"stopClip",(function(){return $d})),n.d(t,"store",(function(){return at})),n.d(t,"getModule",(function(){return ot})),n.d(t,"getToolForElement",(function(){return it})),n.d(t,"addTool",(function(){return Md})),n.d(t,"addToolForElement",(function(){return Cd})),n.d(t,"removeTool",(function(){return Qd})),n.d(t,"removeToolForElement",(function(){return Jd})),n.d(t,"setToolOptions",(function(){return nu})),n.d(t,"setToolOptionsForElement",(function(){return tu})),n.d(t,"isToolActiveForElement",(function(){return oo})),n.d(t,"setToolActive",(function(){return gt})),n.d(t,"setToolActiveForElement",(function(){return ht})),n.d(t,"setToolEnabled",(function(){return vt})),n.d(t,"setToolEnabledForElement",(function(){return pt})),n.d(t,"setToolDisabled",(function(){return ft})),n.d(t,"setToolDisabledForElement",(function(){return mt})),n.d(t,"setToolPassive",(function(){return yt})),n.d(t,"setToolPassiveForElement",(function(){return xt})),n.d(t,"addToolState",(function(){return y})),n.d(t,"getToolState",(function(){return b})),n.d(t,"removeToolState",(function(){return T})),n.d(t,"clearToolState",(function(){return C})),n.d(t,"setElementToolStateManager",(function(){return M})),n.d(t,"getElementToolStateManager",(function(){return x})),n.d(t,"textStyle",(function(){return Qt})),n.d(t,"toolStyle",(function(){return kt})),n.d(t,"toolColors",(function(){return Gt})),n.d(t,"toolCoordinates",(function(){return $a})),n.d(t,"stackSpecificStateManager",(function(){return ru})),n.d(t,"newStackSpecificToolStateManager",(function(){return ou})),n.d(t,"addStackStateManager",(function(){return iu})),n.d(t,"loadHandlerManager",(function(){return Ts})),n.d(t,"newImageIdSpecificToolStateManager",(function(){return p})),n.d(t,"globalImageIdSpecificToolStateManager",(function(){return v})),n.d(t,"newFrameOfReferenceSpecificToolStateManager",(function(){return su})),n.d(t,"globalFrameOfReferenceSpecificToolStateManager",(function(){return cu})),n.d(t,"forceEnabledElementResize",(function(){return Rd})),n.d(t,"orientation",(function(){return Rs})),n.d(t,"SaveAs",(function(){return lu})),n.d(t,"enableLogger",(function(){return S})),n.d(t,"disableLogger",(function(){return _})),n.d(t,"register",(function(){return yu})),n.d(t,"registerSome",(function(){return bu})),n.d(t,"wwwcSynchronizer",(function(){return Tu})),n.d(t,"updateImageSynchronizer",(function(){return Cu})),n.d(t,"Synchronizer",(function(){return Eu})),n.d(t,"stackScrollSynchronizer",(function(){return wu})),n.d(t,"stackImagePositionSynchronizer",(function(){return Iu})),n.d(t,"stackImagePositionOffsetSynchronizer",(function(){return Su})),n.d(t,"stackImageIndexSynchronizer",(function(){return _u})),n.d(t,"panZoomSynchronizer",(function(){return Pu})),n.d(t,"importInternal",(function(){return ku})),n.d(t,"external",(function(){return c})),n.d(t,"EVENTS",(function(){return l})),n.d(t,"version",(function(){return Du})),n.d(t,"import",(function(){return ku}));const Ou={AngleTool:Ha,ArrowAnnotateTool:Fa,BidirectionalTool:wi,CircleRoiTool:Ai,CobbAngleTool:Fi,EllipticalRoiTool:Bi,FreehandRoiTool:vr,LengthTool:br,ProbeTool:Mr,RectangleRoiTool:wr,TextMarkerTool:Dr,BrushTool:Lr,SphericalBrushTool:Rr,RectangleScissorsTool:ms,FreehandScissorsTool:gs,CircleScissorsTool:fs,CorrectionScissorsTool:ps,CrosshairsTool:ws,DoubleTapFitToWindowTool:Is,DragProbeTool:Ss,EraserTool:Ds,FreehandRoiSculptorTool:Os,MagnifyTool:Ls,OverlayTool:Hs,OrientationMarkersTool:Us,PanMultiTouchTool:zs,PanTool:js,ReferenceLinesTool:Xs,RotateTool:Zs,RotateTouchTool:ec,ScaleOverlayTool:nc,StackScrollMouseWheelTool:cc,StackScrollMultiTouchTool:lc,StackScrollTool:dc,WwwcRegionTool:hc,WwwcTool:pc,ZoomMouseWheelTool:bc,ZoomTool:Mc,ZoomTouchPinchTool:Pc,init:Fd,stackPrefetch:Gd,stackRenderers:Xd,playClip:Zd,stopClip:$d,store:at,getModule:ot,getToolForElement:it,addTool:Md,addToolForElement:Cd,removeTool:Qd,removeToolForElement:Jd,setToolOptions:nu,setToolOptionsForElement:tu,isToolActiveForElement:oo,setToolActive:gt,setToolActiveForElement:ht,setToolEnabled:vt,setToolEnabledForElement:pt,setToolDisabled:ft,setToolDisabledForElement:mt,setToolPassive:yt,setToolPassiveForElement:xt,addToolState:y,getToolState:b,removeToolState:T,clearToolState:C,setElementToolStateManager:M,getElementToolStateManager:x,textStyle:Qt,toolStyle:kt,toolColors:Gt,toolCoordinates:$a,stackSpecificStateManager:ru,newStackSpecificToolStateManager:ou,addStackStateManager:iu,loadHandlerManager:Ts,newImageIdSpecificToolStateManager:p,globalImageIdSpecificToolStateManager:v,newFrameOfReferenceSpecificToolStateManager:su,globalFrameOfReferenceSpecificToolStateManager:cu,forceEnabledElementResize:Rd,orientation:Rs,SaveAs:lu,enableLogger:S,disableLogger:_,importInternal:ku,import:ku,register:yu,registerSome:bu,wwwcSynchronizer:Tu,updateImageSynchronizer:Cu,Synchronizer:Eu,stackScrollSynchronizer:wu,stackImagePositionSynchronizer:Iu,stackImagePositionOffsetSynchronizer:Su,stackImageIndexSynchronizer:_u,panZoomSynchronizer:Pu,external:c,EVENTS:l,version:Du};t.default=Ou},,,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return v}));var o=n(2),a=n.n(o),i=n(4),r=n(1),s=n(13),c=n(0),l=n(5),d=n(8),u=function(e,t,n,o){return new(n||(n=Promise))((function(a,i){function r(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,s)}c((o=o.apply(e,t||[])).next())}))};const h=a()("threads:master:messages"),g=a()("threads:master:spawn"),m=a()("threads:master:thread-utils"),f=void 0!==e&&e.env.THREADS_WORKER_INIT_TIMEOUT?Number.parseInt(e.env.THREADS_WORKER_INIT_TIMEOUT,10):1e4;function p(e,t,n,o){const a=n.filter(e=>e.type===l.a.internalError).map(e=>e.error);return Object.assign(e,{[c.a]:a,[c.b]:n,[c.c]:o,[c.e]:t})}function v(e,t){return u(this,void 0,void 0,(function*(){g("Initializing new thread");const n=t&&t.timeout?t.timeout:f,o=(yield function(e,t,n){return u(this,void 0,void 0,(function*(){let o;const a=new Promise((e,a)=>{o=setTimeout(()=>a(Error(n)),t)}),i=yield Promise.race([e,a]);return clearTimeout(o),i}))}(function(e){return new Promise((t,n)=>{const o=a=>{var i;h("Message from worker before finishing initialization:",a.data),(i=a.data)&&"init"===i.type?(e.removeEventListener("message",o),t(a.data)):(e=>e&&"uncaughtError"===e.type)(a.data)&&(e.removeEventListener("message",o),n(Object(r.a)(a.data.error)))};e.addEventListener("message",o)})}(e),n,`Timeout: Did not receive an init message from worker after ${n}ms. Make sure the worker calls expose().`)).exposed,{termination:a,terminate:c}=function(e){const[t,n]=Object(s.a)();return{terminate:()=>u(this,void 0,void 0,(function*(){m("Terminating worker"),yield e.terminate(),n()})),termination:t}}(e),v=function(e,t){return new i.a(n=>{const o=e=>{const t={type:l.a.message,data:e.data};n.next(t)},a=e=>{m("Unhandled promise rejection event in thread:",e);const t={type:l.a.internalError,error:Error(e.reason)};n.next(t)};e.addEventListener("message",o),e.addEventListener("unhandledrejection",a),t.then(()=>{const t={type:l.a.termination};e.removeEventListener("message",o),e.removeEventListener("unhandledrejection",a),n.next(t),n.complete()})})}(e,a);if("function"===o.type){return p(Object(d.a)(e),e,v,c)}if("module"===o.type){return p(Object(d.b)(e,o.methods),e,v,c)}{const e=o.type;throw Error(`Worker init message states unexpected type of expose(): ${e}`)}}))}}).call(this,n(7))}])}));
//# sourceMappingURL=cornerstoneTools.min.js.map